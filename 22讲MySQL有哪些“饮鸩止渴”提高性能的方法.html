<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport"
          content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no,viewport-fit=cover">
    <meta name="format-detection" content="telephone=no">
    <style type="text/css">

#watermark {

  position: relative;
  overflow: hidden;
}

#watermark .x {
  position: absolute;
  top: 800;
  left: 400;
  color: #3300ff;
  font-size: 50px;
  pointer-events: none;
  opacity:0.3;
  filter:Alpha(opacity=50);
  
  
}
    </style>


    <style type="text/css">
 html{color:#333;-webkit-text-size-adjust:100%;-ms-text-size-adjust:100%;text-rendering:optimizelegibility;font-family:Helvetica Neue,PingFang SC,Verdana,Microsoft Yahei,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif}html.borderbox *,html.borderbox :after,html.borderbox :before{box-sizing:border-box}article,aside,blockquote,body,button,code,dd,details,dl,dt,fieldset,figcaption,figure,footer,form,h1,h2,h3,h4,h5,h6,header,hr,input,legend,li,menu,nav,ol,p,pre,section,td,textarea,th,ul{margin:0;padding:0}article,aside,details,figcaption,figure,footer,header,menu,nav,section{display:block}audio,canvas,video{display:inline-block}body,button,input,select,textarea{font:300 1em/1.8 PingFang SC,Lantinghei SC,Microsoft Yahei,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,Helvetica,sans-serif}button::-moz-focus-inner,input::-moz-focus-inner{padding:0;border:0}table{border-collapse:collapse;border-spacing:0}fieldset,img{border:0}blockquote{position:relative;color:#999;font-weight:400;border-left:1px solid #1abc9c;padding-left:1em;margin:1em 3em 1em 2em}@media only screen and (max-width:640px){blockquote{margin:1em 0}}abbr,acronym{border-bottom:1px dotted;font-variant:normal}abbr{cursor:help}del{text-decoration:line-through}address,caption,cite,code,dfn,em,th,var{font-style:normal;font-weight:400}ol,ul{list-style:none}caption,th{text-align:left}q:after,q:before{content:""}sub,sup{font-size:75%;line-height:0;position:relative}:root sub,:root sup{vertical-align:baseline}sup{top:-.5em}sub{bottom:-.25em}a{color:#1abc9c}a:hover{text-decoration:underline}.typo a{border-bottom:1px solid #1abc9c}.typo a:hover{border-bottom-color:#555;color:#555}.typo a:hover,a,ins{text-decoration:none}.typo-u,u{text-decoration:underline}mark{background:#fffdd1;border-bottom:1px solid #ffedce;padding:2px;margin:0 5px}code,pre,pre tt{font-family:Courier,Courier New,monospace}pre{background:hsla(0,0%,97%,.7);border:1px solid #ddd;padding:1em 1.5em;display:block;-webkit-overflow-scrolling:touch}hr{border:none;border-bottom:1px solid #cfcfcf;margin-bottom:.8em;height:10px}.typo-small,figcaption,small{font-size:.9em;color:#888}b,strong{font-weight:700;color:#000}[draggable]{cursor:move}.clearfix:after,.clearfix:before{content:"";display:table}.clearfix:after{clear:both}.clearfix{zoom:1}.textwrap,.textwrap td,.textwrap th{word-wrap:break-word;word-break:break-all}.textwrap-table{table-layout:fixed}.serif{font-family:Palatino,Optima,Georgia,serif}.typo-dl,.typo-form,.typo-hr,.typo-ol,.typo-p,.typo-pre,.typo-table,.typo-ul,.typo dl,.typo form,.typo hr,.typo ol,.typo p,.typo pre,.typo table,.typo ul,blockquote{margin-bottom:1rem}h1,h2,h3,h4,h5,h6{font-family:PingFang SC,Helvetica Neue,Verdana,Microsoft Yahei,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#000;line-height:1.35}.typo-h1,.typo-h2,.typo-h3,.typo-h4,.typo-h5,.typo-h6,.typo h1,.typo h2,.typo h3,.typo h4,.typo h5,.typo h6{margin-top:1.2em;margin-bottom:.6em;line-height:1.35}.typo-h1,.typo h1{font-size:2em}.typo-h2,.typo h2{font-size:1.8em}.typo-h3,.typo h3{font-size:1.6em}.typo-h4,.typo h4{font-size:1.4em}.typo-h5,.typo-h6,.typo h5,.typo h6{font-size:1.2em}.typo-ul,.typo ul{margin-left:1.3em;list-style:disc}.typo-ol,.typo ol{list-style:decimal;margin-left:1.9em}.typo-ol ol,.typo-ol ul,.typo-ul ol,.typo-ul ul,.typo li ol,.typo li ul{margin-bottom:.8em;margin-left:2em}.typo-ol ul,.typo-ul ul,.typo li ul{list-style:circle}.typo-table td,.typo-table th,.typo table caption,.typo table td,.typo table th{border:1px solid #ddd;padding:.5em 1em;color:#666}.typo-table th,.typo table th{background:#fbfbfb}.typo-table thead th,.typo table thead th{background:hsla(0,0%,95%,.7)}.typo table caption{border-bottom:none}.typo-input,.typo-textarea{-webkit-appearance:none;border-radius:0}.typo-em,.typo em,caption,legend{color:#000;font-weight:inherit}.typo-em{position:relative}.typo-em:after{position:absolute;top:.65em;left:0;width:100%;overflow:hidden;white-space:nowrap;content:"\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB"}.typo img{max-width:100%}.common-content{font-weight:400;color:#353535;line-height:1.75rem;white-space:normal;word-break:normal;font-size:1rem}.common-content img{display:block;max-width:100%;background-color:#eee}.common-content audio,.common-content video{width:100%;background-color:#eee}.common-content center,.common-content font{margin-top:1rem;display:inline-block}.common-content center{width:100%}.common-content pre{margin-top:1rem;padding-left:0;padding-right:0;position:relative;overflow:hidden}.common-content pre code{font-size:.8rem;font-family:Consolas,Liberation Mono,Menlo,monospace,Courier;display:block;width:100%;box-sizing:border-box;padding-left:1rem;padding-right:1rem;overflow-x:auto}.common-content hr{border:none;margin-top:1.5rem;margin-bottom:1.5rem;border-top:1px solid #f5f5f5;height:1px;background:none}.common-content b,.common-content h1,.common-content h2,.common-content h3,.common-content h4,.common-content h5,.common-content strong{font-weight:700}.common-content h1,.common-content h2{font-size:1.125rem;margin-bottom:.45rem}.common-content h3,.common-content h4,.common-content h5{font-size:1rem;margin-bottom:.45rem}.common-content p{font-weight:400;color:#353535;margin-top:.15rem}.common-content .orange{color:#ff5a05}.common-content .reference{font-size:1rem;color:#888}.custom-rich-content h1{margin-top:0;font-weight:400;font-size:15.25px;border-bottom:1px solid #eee;line-height:2.8}.custom-rich-content li,.custom-rich-content p{font-size:14px;color:#888;line-height:1.6}table.hljs-ln{margin-bottom:0;border-spacing:0;border-collapse:collapse}table.hljs-ln,table.hljs-ln tbody,table.hljs-ln td,table.hljs-ln tr{box-sizing:border-box}table.hljs-ln td{padding:0;border:0}table.hljs-ln td.hljs-ln-numbers{min-width:15px;color:rgba(27,31,35,.3);text-align:right;white-space:nowrap;cursor:pointer;user-select:none}table.hljs-ln td.hljs-ln-code,table.hljs-ln td.hljs-ln-numbers{font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,Courier,monospace;font-size:12px;line-height:20px;vertical-align:top}table.hljs-ln td.hljs-ln-code{position:relative;padding-right:10px;padding-left:10px;overflow:visible;color:#24292e;word-wrap:normal;white-space:pre}video::-webkit-media-controls{overflow:hidden!important}video::-webkit-media-controls-enclosure{width:calc(100% + 32px);margin-left:auto}.button-cancel{color:#888;border:1px solid #888;border-radius:3px;margin-right:12px}.button-cancel,.button-primary{-ms-flex-positive:1;flex-grow:1;height:35px;display:inline-block;font-size:15px;text-align:center;line-height:36px}.button-primary{color:#fff;background-color:#ff5a05;border-radius:3px}@font-face{font-family:iconfont;src:url(//at.alicdn.com/t/font_372689_bwwwtosxtzp.eot);src:url(//at.alicdn.com/t/font_372689_bwwwtosxtzp.eot#iefix) format("embedded-opentype"),url(//at.alicdn.com/t/font_372689_bwwwtosxtzp.woff) format("woff"),url(//at.alicdn.com/t/font_372689_bwwwtosxtzp.ttf) format("truetype"),url(//at.alicdn.com/t/font_372689_bwwwtosxtzp.svg#iconfont) format("svg")}@font-face{font-family:player-font;src:url(//at.alicdn.com/t/font_509397_1cyjv4o90qiod2t9.eot);src:url(//at.alicdn.com/t/font_509397_1cyjv4o90qiod2t9.eot#iefix) format("embedded-opentype"),url(//at.alicdn.com/t/font_509397_1cyjv4o90qiod2t9.woff) format("woff"),url(//at.alicdn.com/t/font_509397_1cyjv4o90qiod2t9.ttf) format("truetype"),url(//at.alicdn.com/t/font_509397_1cyjv4o90qiod2t9.svg#player-font) format("svg")}.iconfont{font-family:iconfont!important;font-size:16px;font-style:normal;-webkit-font-smoothing:antialiased;-webkit-text-stroke-width:.2px;-moz-osx-font-smoothing:grayscale}html{background:#fff;min-height:100%;-webkit-tap-highlight-color:rgba(0,0,0,0)}body{width:100%}body.fixed{overflow:hidden;position:fixed;width:100vw;height:100vh}i{font-style:normal}a{word-wrap:break-word;-webkit-tap-highlight-color:rgba(0,0,0,0)}a:hover{text-decoration:none}.fade-enter-active,.fade-leave-active{transition:opacity .3s}.fade-enter,.fade-leave-to{opacity:0}.MathJax,.MathJax_CHTML,.MathJax_MathContainer,.MathJax_MathML,.MathJax_PHTML,.MathJax_PlainSource,.MathJax_SVG{outline:0}.ios-app-switch .js-audit{display:none}._loading_wrap_{position:fixed;width:100vw;height:100vh;top:50%;left:50%;transform:translate(-50%,-50%);z-index:999}._loading_div_class_,._loading_wrap_{display:-ms-flexbox;display:flex;-ms-flex-pack:center;justify-content:center;-ms-flex-align:center;align-items:center}._loading_div_class_{word-wrap:break-word;padding:.5rem .75rem;text-align:center;z-index:9999;font-size:.6rem;max-width:60%;color:#fff;border-radius:.25rem;-ms-flex-direction:column;flex-direction:column}._loading_div_class_ .message{color:#353535;font-size:16px;line-height:3}.spinner{animation:circle-rotator 1.4s linear infinite}.spinner *{line-height:0;box-sizing:border-box}@keyframes circle-rotator{0%{transform:rotate(0deg)}to{transform:rotate(270deg)}}.path{stroke-dasharray:187;stroke-dashoffset:0;transform-origin:center;animation:circle-dash 1.4s ease-in-out infinite,circle-colors 5.6s ease-in-out infinite}@keyframes circle-colors{0%{stroke:#ff5a05}to{stroke:#ff5a05}}@keyframes circle-dash{0%{stroke-dashoffset:187}50%{stroke-dashoffset:46.75;transform:rotate(135deg)}to{stroke-dashoffset:187;transform:rotate(450deg)}}.confirm-box-wrapper,.confirm-box-wrapper .mask{position:absolute;top:0;left:0;right:0;bottom:0}.confirm-box-wrapper .mask{background:rgba(0,0,0,.6)}.confirm-box-wrapper .confirm-box{position:fixed;top:50%;left:50%;width:267px;background:#fff;transform:translate(-50%,-50%);border-radius:7px}.confirm-box-wrapper .confirm-box .head{margin:0 18px;font-size:18px;text-align:center;line-height:65px;border-bottom:1px solid #d9d9d9}.confirm-box-wrapper .confirm-box .body{padding:18px;padding-bottom:0;color:#353535;font-size:12.5px;max-height:150px;overflow:auto}.confirm-box-wrapper .confirm-box .foot{display:-ms-flexbox;display:flex;-ms-flex-direction:row;flex-direction:row;padding:18px}.confirm-box-wrapper .confirm-box .foot .button-cancel{border:1px solid #d9d9d9}.hljs{display:block;overflow-x:auto;padding:.5em;color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}




    </style>
    <style type="text/css">
        .button-cancel[data-v-87ffcada]{color:#888;border:1px solid #888;border-radius:3px;margin-right:12px}.button-cancel[data-v-87ffcada],.button-primary[data-v-87ffcada]{-webkit-box-flex:1;-ms-flex-positive:1;flex-grow:1;height:35px;display:inline-block;font-size:15px;text-align:center;line-height:36px}.button-primary[data-v-87ffcada]{color:#fff;background-color:#ff5a05;border-radius:3px}.pd[data-v-87ffcada]{padding-left:1.375rem;padding-right:1.375rem}.article[data-v-87ffcada]{max-width:70rem;margin:0 auto}.article .article-unavailable[data-v-87ffcada]{color:#fa8919;font-size:15px;font-weight:600;line-height:24px;border-radius:5px;padding:12px;background-color:#f6f7fb;margin-top:20px}.article .article-unavailable .iconfont[data-v-87ffcada]{font-size:12px}.article .main[data-v-87ffcada]{padding:1.25rem 0;margin-bottom:52px}.article-title[data-v-87ffcada]{color:#353535;font-weight:400;line-height:1.65rem;font-size:1.34375rem}.article-info[data-v-87ffcada]{color:#888;font-size:.9375rem;margin-top:1.0625rem}.article-content[data-v-87ffcada]{margin-top:1.0625rem}.article-content.android video[data-v-87ffcada]::-webkit-media-controls-fullscreen-button{display:none}.copyright[data-v-87ffcada]{color:#b2b2b2;padding-bottom:20px;margin-top:20px;font-size:13px}.audio-player[data-v-87ffcada]{width:100%;margin:20px 0}.to-comment[data-v-87ffcada]{overflow:hidden;padding-top:10px;margin-bottom:-30px}.to-comment a.button-primary[data-v-87ffcada]{float:right;height:20px;font-size:12px;line-height:20px;padding:4px 8px;cursor:pointer}.article-comments[data-v-87ffcada]{margin-top:2rem}.article-comments h2[data-v-87ffcada]{text-align:center;color:#888;position:relative;z-index:1;margin-bottom:1rem}.article-comments h2[data-v-87ffcada]:before{border-top:1px dotted #888;content:"";position:absolute;top:56%;left:0;width:100%;z-index:-1}.article-comments h2 span[data-v-87ffcada]{font-size:15.25px;font-weight:400;padding:0 1rem;background:#fff;display:inline-block}.article-sub-bottom[data-v-87ffcada]{z-index:10;cursor:pointer}.switch-btns[data-v-87ffcada]{height:76px;cursor:pointer;padding-top:24px;padding-bottom:24px;border-bottom:10px solid #f6f7fb;position:relative}.switch-btns[data-v-87ffcada]:before{content:" ";height:1px;background:#e8e8e8;position:absolute;top:0;left:0;-webkit-box-sizing:border-box;box-sizing:border-box;left:1.375rem;right:1.375rem}.switch-btns .btn[data-v-87ffcada]{height:38px;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center}.switch-btns .btn .tag[data-v-87ffcada]{-webkit-box-flex:0;-ms-flex:0 0 62px;flex:0 0 62px;text-align:center;color:#888;font-size:14px;border-radius:10px;height:22px;line-height:22px;background:#f6f7fb;font-weight:400}.switch-btns .btn .txt[data-v-87ffcada]{margin-left:10px;-webkit-box-flex:1;-ms-flex:1 1 auto;flex:1 1 auto;color:#888;font-size:15px;height:22px;line-height:22px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-weight:400}@media (max-width:769px){.article .breadcrumb[data-v-87ffcada]{padding-top:10px;padding-bottom:10px}}





    </style>

    <style type="text/css">
        .comment-item{list-style-position:inside;width:100%;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin-bottom:1rem}.comment-item a{border-bottom:none}.comment-item .avatar{width:2.625rem;height:2.625rem;-ms-flex-negative:0;flex-shrink:0;border-radius:50%}.comment-item .info{margin-left:.5rem;-webkit-box-flex:1;-ms-flex-positive:1;flex-grow:1}.comment-item .info .hd{width:100%;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between;-webkit-box-align:center;-ms-flex-align:center;align-items:center}.comment-item .info .hd .username{color:#888;font-size:15.25px;font-weight:400;line-height:1.2}.comment-item .info .hd .control{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-align:center;-ms-flex-align:center;align-items:center}.comment-item .info .hd .control .btn-share{color:#888;font-size:.75rem;margin-right:1rem}.comment-item .info .hd .control .btn-praise{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-align:center;-ms-flex-align:center;align-items:center;font-size:15.25px;text-decoration:none}.comment-item .info .hd .control .btn-praise i{color:#888;display:inline-block;font-size:.75rem;margin-right:.3rem;margin-top:-.01rem}.comment-item .info .hd .control .btn-praise i.on,.comment-item .info .hd .control .btn-praise span{color:#ff5a05}.comment-item .info .bd{color:#353535;font-size:15.25px;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6}.comment-item .info .time{color:#888;font-size:9px;line-height:1}.comment-item .info .reply .reply-hd{font-size:15.25px}.comment-item .info .reply .reply-hd span{margin-left:-12px;color:#888;font-weight:400}.comment-item .info .reply .reply-hd i{color:#ff5a05;font-size:15.25px}.comment-item .info .reply .reply-content{color:#353535;font-size:15.25px;font-weight:400;white-space:normal;word-break:break-all}.comment-item .info .reply .reply-time{color:#888;font-size:9px}




    </style>
</head>
<body>
<div id="app">


    <div data-v-87ffcada="" class="article" id="watermark">
        <div data-v-87ffcada="" class="main main-app">
            <h1 data-v-87ffcada="" class="article-title pd">
                22è®²MySQLæœ‰å“ªäº›â€œé¥®é¸©æ­¢æ¸´â€æé«˜æ€§èƒ½çš„æ–¹æ³•
            </h1>
            <div data-v-87ffcada="" class="article-content typo common-content pd"><img data-v-87ffcada=""
                                                                                        src="https://static001.geekbang.org/resource/image/78/6f/78c6369b041dbce14645fa428780306f.jpg">

                <div>
                    <audio controls="controls" height="100" width="100">
                        <source src="22è®²MySQLæœ‰å“ªäº›â€œé¥®é¸©æ­¢æ¸´â€æé«˜æ€§èƒ½çš„æ–¹æ³•.mp3" type="audio/mp3" />
                        <embed height="100" width="100" src="22è®²MySQLæœ‰å“ªäº›â€œé¥®é¸©æ­¢æ¸´â€æé«˜æ€§èƒ½çš„æ–¹æ³•.mp3" />
                    </audio>
                </div>
                <div data-v-87ffcada="" id="article-content" class="">
                    <div class="text">
                        <p>ä¸çŸ¥é“ä½ åœ¨å®é™…è¿ç»´è¿‡ç¨‹ä¸­æœ‰æ²¡æœ‰ç¢°åˆ°è¿™æ ·çš„æƒ…æ™¯ï¼šä¸šåŠ¡é«˜å³°æœŸï¼Œç”Ÿäº§ç¯å¢ƒçš„MySQLå‹åŠ›å¤ªå¤§ï¼Œæ²¡æ³•æ­£å¸¸å“åº”ï¼Œéœ€è¦çŸ­æœŸå†…ã€ä¸´æ—¶æ€§åœ°æå‡ä¸€äº›æ€§èƒ½ã€‚</p><p>æˆ‘ä»¥å‰åšä¸šåŠ¡æŠ¤èˆªçš„æ—¶å€™ï¼Œå°±å¶å°”ä¼šç¢°ä¸Šè¿™ç§åœºæ™¯ã€‚ç”¨æˆ·çš„å¼€å‘è´Ÿè´£äººè¯´ï¼Œä¸ç®¡ä½ ç”¨ä»€ä¹ˆæ–¹æ¡ˆï¼Œè®©ä¸šåŠ¡å…ˆè·‘èµ·æ¥å†è¯´ã€‚</p><p>ä½†ï¼Œå¦‚æœæ˜¯æ— æŸæ–¹æ¡ˆçš„è¯ï¼Œè‚¯å®šä¸éœ€è¦ç­‰åˆ°è¿™ä¸ªæ—¶å€™æ‰ä¸Šåœºã€‚ä»Šå¤©æˆ‘ä»¬å°±æ¥èŠèŠè¿™äº›ä¸´æ—¶æ–¹æ¡ˆï¼Œå¹¶ç€é‡è¯´ä¸€è¯´å®ƒä»¬å¯èƒ½å­˜åœ¨çš„é£é™©ã€‚</p><h1>çŸ­è¿æ¥é£æš´</h1><p>æ­£å¸¸çš„çŸ­è¿æ¥æ¨¡å¼å°±æ˜¯è¿æ¥åˆ°æ•°æ®åº“åï¼Œæ‰§è¡Œå¾ˆå°‘çš„SQLè¯­å¥å°±æ–­å¼€ï¼Œä¸‹æ¬¡éœ€è¦çš„æ—¶å€™å†é‡è¿ã€‚å¦‚æœä½¿ç”¨çš„æ˜¯çŸ­è¿æ¥ï¼Œåœ¨ä¸šåŠ¡é«˜å³°æœŸçš„æ—¶å€™ï¼Œå°±å¯èƒ½å‡ºç°è¿æ¥æ•°çªç„¶æš´æ¶¨çš„æƒ…å†µã€‚</p><p>æˆ‘åœ¨ç¬¬1ç¯‡æ–‡ç« <a href="https://time.geekbang.org/column/article/68319">ã€ŠåŸºç¡€æ¶æ„ï¼šä¸€æ¡SQLæŸ¥è¯¢è¯­å¥æ˜¯å¦‚ä½•æ‰§è¡Œçš„ï¼Ÿã€‹</a>ä¸­è¯´è¿‡ï¼ŒMySQLå»ºç«‹è¿æ¥çš„è¿‡ç¨‹ï¼Œæˆæœ¬æ˜¯å¾ˆé«˜çš„ã€‚é™¤äº†æ­£å¸¸çš„ç½‘ç»œè¿æ¥ä¸‰æ¬¡æ¡æ‰‹å¤–ï¼Œè¿˜éœ€è¦åšç™»å½•æƒé™åˆ¤æ–­å’Œè·å¾—è¿™ä¸ªè¿æ¥çš„æ•°æ®è¯»å†™æƒé™ã€‚</p><p>åœ¨æ•°æ®åº“å‹åŠ›æ¯”è¾ƒå°çš„æ—¶å€™ï¼Œè¿™äº›é¢å¤–çš„æˆæœ¬å¹¶ä¸æ˜æ˜¾ã€‚</p><p>ä½†æ˜¯ï¼ŒçŸ­è¿æ¥æ¨¡å‹å­˜åœ¨ä¸€ä¸ªé£é™©ï¼Œå°±æ˜¯ä¸€æ—¦æ•°æ®åº“å¤„ç†å¾—æ…¢ä¸€äº›ï¼Œè¿æ¥æ•°å°±ä¼šæš´æ¶¨ã€‚max_connectionså‚æ•°ï¼Œç”¨æ¥æ§åˆ¶ä¸€ä¸ªMySQLå®ä¾‹åŒæ—¶å­˜åœ¨çš„è¿æ¥æ•°çš„ä¸Šé™ï¼Œè¶…è¿‡è¿™ä¸ªå€¼ï¼Œç³»ç»Ÿå°±ä¼šæ‹’ç»æ¥ä¸‹æ¥çš„è¿æ¥è¯·æ±‚ï¼Œå¹¶æŠ¥é”™æç¤ºâ€œToo many connectionsâ€ã€‚å¯¹äºè¢«æ‹’ç»è¿æ¥çš„è¯·æ±‚æ¥è¯´ï¼Œä»ä¸šåŠ¡è§’åº¦çœ‹å°±æ˜¯æ•°æ®åº“ä¸å¯ç”¨ã€‚</p><!-- [[[read_end]]] --><p>åœ¨æœºå™¨è´Ÿè½½æ¯”è¾ƒé«˜çš„æ—¶å€™ï¼Œå¤„ç†ç°æœ‰è¯·æ±‚çš„æ—¶é—´å˜é•¿ï¼Œæ¯ä¸ªè¿æ¥ä¿æŒçš„æ—¶é—´ä¹Ÿæ›´é•¿ã€‚è¿™æ—¶ï¼Œå†æœ‰æ–°å»ºè¿æ¥çš„è¯ï¼Œå°±å¯èƒ½ä¼šè¶…è¿‡max_connectionsçš„é™åˆ¶ã€‚</p><p>ç¢°åˆ°è¿™ç§æƒ…å†µæ—¶ï¼Œä¸€ä¸ªæ¯”è¾ƒè‡ªç„¶çš„æƒ³æ³•ï¼Œå°±æ˜¯è°ƒé«˜max_connectionsçš„å€¼ã€‚ä½†è¿™æ ·åšæ˜¯æœ‰é£é™©çš„ã€‚å› ä¸ºè®¾è®¡max_connectionsè¿™ä¸ªå‚æ•°çš„ç›®çš„æ˜¯æƒ³ä¿æŠ¤MySQLï¼Œå¦‚æœæˆ‘ä»¬æŠŠå®ƒæ”¹å¾—å¤ªå¤§ï¼Œè®©æ›´å¤šçš„è¿æ¥éƒ½å¯ä»¥è¿›æ¥ï¼Œé‚£ä¹ˆç³»ç»Ÿçš„è´Ÿè½½å¯èƒ½ä¼šè¿›ä¸€æ­¥åŠ å¤§ï¼Œå¤§é‡çš„èµ„æºè€—è´¹åœ¨æƒé™éªŒè¯ç­‰é€»è¾‘ä¸Šï¼Œç»“æœå¯èƒ½æ˜¯é€‚å¾—å…¶åï¼Œå·²ç»è¿æ¥çš„çº¿ç¨‹æ‹¿ä¸åˆ°CPUèµ„æºå»æ‰§è¡Œä¸šåŠ¡çš„SQLè¯·æ±‚ã€‚</p><p>é‚£ä¹ˆè¿™ç§æƒ…å†µä¸‹ï¼Œä½ è¿˜æœ‰æ²¡æœ‰åˆ«çš„å»ºè®®å‘¢ï¼Ÿæˆ‘è¿™é‡Œè¿˜æœ‰ä¸¤ç§æ–¹æ³•ï¼Œä½†è¦æ³¨æ„ï¼Œè¿™äº›æ–¹æ³•éƒ½æ˜¯æœ‰æŸçš„ã€‚</p><p><strong>ç¬¬ä¸€ç§æ–¹æ³•ï¼šå…ˆå¤„ç†æ‰é‚£äº›å ç€è¿æ¥ä½†æ˜¯ä¸å·¥ä½œçš„çº¿ç¨‹ã€‚</strong></p><p>max_connectionsçš„è®¡ç®—ï¼Œä¸æ˜¯çœ‹è°åœ¨runningï¼Œæ˜¯åªè¦è¿ç€å°±å ç”¨ä¸€ä¸ªè®¡æ•°ä½ç½®ã€‚å¯¹äºé‚£äº›ä¸éœ€è¦ä¿æŒçš„è¿æ¥ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡kill connectionä¸»åŠ¨è¸¢æ‰ã€‚è¿™ä¸ªè¡Œä¸ºè·Ÿäº‹å…ˆè®¾ç½®wait_timeoutçš„æ•ˆæœæ˜¯ä¸€æ ·çš„ã€‚è®¾ç½®wait_timeoutå‚æ•°è¡¨ç¤ºçš„æ˜¯ï¼Œä¸€ä¸ªçº¿ç¨‹ç©ºé—²wait_timeoutè¿™ä¹ˆå¤šç§’ä¹‹åï¼Œå°±ä¼šè¢«MySQLç›´æ¥æ–­å¼€è¿æ¥ã€‚</p><p>ä½†æ˜¯éœ€è¦æ³¨æ„ï¼Œåœ¨show processlistçš„ç»“æœé‡Œï¼Œè¸¢æ‰æ˜¾ç¤ºä¸ºsleepçš„çº¿ç¨‹ï¼Œå¯èƒ½æ˜¯æœ‰æŸçš„ã€‚æˆ‘ä»¬æ¥çœ‹ä¸‹é¢è¿™ä¸ªä¾‹å­ã€‚</p><p><img src="https://static001.geekbang.org/resource/image/90/2a/9091ff280592c8c68665771b1516c62a.png" alt=""></p><center><span class="reference">å›¾1 sleepçº¿ç¨‹çš„ä¸¤ç§çŠ¶æ€</span></center><p>åœ¨ä¸Šé¢è¿™ä¸ªä¾‹å­é‡Œï¼Œå¦‚æœæ–­å¼€session Açš„è¿æ¥ï¼Œå› ä¸ºè¿™æ—¶å€™session Aè¿˜æ²¡æœ‰æäº¤ï¼Œæ‰€ä»¥MySQLåªèƒ½æŒ‰ç…§å›æ»šäº‹åŠ¡æ¥å¤„ç†ï¼›è€Œæ–­å¼€session Bçš„è¿æ¥ï¼Œå°±æ²¡ä»€ä¹ˆå¤§å½±å“ã€‚æ‰€ä»¥ï¼Œå¦‚æœæŒ‰ç…§ä¼˜å…ˆçº§æ¥è¯´ï¼Œä½ åº”è¯¥ä¼˜å…ˆæ–­å¼€åƒsession Bè¿™æ ·çš„äº‹åŠ¡å¤–ç©ºé—²çš„è¿æ¥ã€‚</p><p>ä½†æ˜¯ï¼Œæ€ä¹ˆåˆ¤æ–­å“ªäº›æ˜¯äº‹åŠ¡å¤–ç©ºé—²çš„å‘¢ï¼Ÿsession Cåœ¨Tæ—¶åˆ»ä¹‹åçš„30ç§’æ‰§è¡Œshow processlistï¼Œçœ‹åˆ°çš„ç»“æœæ˜¯è¿™æ ·çš„ã€‚</p><p><img src="https://static001.geekbang.org/resource/image/ae/25/ae6a9ceecf8517e47f9ebfc565f0f925.png" alt=""></p><center><span class="reference">å›¾2 sleepçº¿ç¨‹çš„ä¸¤ç§çŠ¶æ€ï¼Œshow processlistç»“æœ</span></center><p>å›¾ä¸­id=4å’Œid=5çš„ä¸¤ä¸ªä¼šè¯éƒ½æ˜¯Sleep çŠ¶æ€ã€‚è€Œè¦çœ‹äº‹åŠ¡å…·ä½“çŠ¶æ€çš„è¯ï¼Œä½ å¯ä»¥æŸ¥information_schemaåº“çš„innodb_trxè¡¨ã€‚</p><p><img src="https://static001.geekbang.org/resource/image/ca/e8/ca4b455c8eacbf32b98d1fe9ed9876e8.png" alt=""></p><center><span class="reference">å›¾3 ä»information_schema.innodb_trxæŸ¥è¯¢äº‹åŠ¡çŠ¶æ€</span></center><p>è¿™ä¸ªç»“æœé‡Œï¼Œtrx_mysql_thread_id=4ï¼Œè¡¨ç¤ºid=4çš„çº¿ç¨‹è¿˜å¤„åœ¨äº‹åŠ¡ä¸­ã€‚</p><p>å› æ­¤ï¼Œå¦‚æœæ˜¯è¿æ¥æ•°è¿‡å¤šï¼Œä½ å¯ä»¥ä¼˜å…ˆæ–­å¼€äº‹åŠ¡å¤–ç©ºé—²å¤ªä¹…çš„è¿æ¥ï¼›å¦‚æœè¿™æ ·è¿˜ä¸å¤Ÿï¼Œå†è€ƒè™‘æ–­å¼€äº‹åŠ¡å†…ç©ºé—²å¤ªä¹…çš„è¿æ¥ã€‚</p><p>ä»æœåŠ¡ç«¯æ–­å¼€è¿æ¥ä½¿ç”¨çš„æ˜¯kill connection + idçš„å‘½ä»¤ï¼Œ ä¸€ä¸ªå®¢æˆ·ç«¯å¤„äºsleepçŠ¶æ€æ—¶ï¼Œå®ƒçš„è¿æ¥è¢«æœåŠ¡ç«¯ä¸»åŠ¨æ–­å¼€åï¼Œè¿™ä¸ªå®¢æˆ·ç«¯å¹¶ä¸ä¼šé©¬ä¸ŠçŸ¥é“ã€‚ç›´åˆ°å®¢æˆ·ç«¯åœ¨å‘èµ·ä¸‹ä¸€ä¸ªè¯·æ±‚çš„æ—¶å€™ï¼Œæ‰ä¼šæ”¶åˆ°è¿™æ ·çš„æŠ¥é”™â€œERROR 2013 (HY000): Lost connection to MySQL server during queryâ€ã€‚</p><p>ä»æ•°æ®åº“ç«¯ä¸»åŠ¨æ–­å¼€è¿æ¥å¯èƒ½æ˜¯æœ‰æŸçš„ï¼Œå°¤å…¶æ˜¯æœ‰çš„åº”ç”¨ç«¯æ”¶åˆ°è¿™ä¸ªé”™è¯¯åï¼Œä¸é‡æ–°è¿æ¥ï¼Œè€Œæ˜¯ç›´æ¥ç”¨è¿™ä¸ªå·²ç»ä¸èƒ½ç”¨çš„å¥æŸ„é‡è¯•æŸ¥è¯¢ã€‚è¿™ä¼šå¯¼è‡´ä»åº”ç”¨ç«¯çœ‹ä¸Šå»ï¼Œâ€œMySQLä¸€ç›´æ²¡æ¢å¤â€ã€‚</p><p>ä½ å¯èƒ½è§‰å¾—è¿™æ˜¯ä¸€ä¸ªå†·ç¬‘è¯ï¼Œä½†å®é™…ä¸Šæˆ‘ç¢°åˆ°è¿‡ä¸ä¸‹10æ¬¡ã€‚</p><p>æ‰€ä»¥ï¼Œå¦‚æœä½ æ˜¯ä¸€ä¸ªæ”¯æŒä¸šåŠ¡çš„DBAï¼Œä¸è¦å‡è®¾æ‰€æœ‰çš„åº”ç”¨ä»£ç éƒ½ä¼šè¢«æ­£ç¡®åœ°å¤„ç†ã€‚å³ä½¿åªæ˜¯ä¸€ä¸ªæ–­å¼€è¿æ¥çš„æ“ä½œï¼Œä¹Ÿè¦ç¡®ä¿é€šçŸ¥åˆ°ä¸šåŠ¡å¼€å‘å›¢é˜Ÿã€‚</p><p><strong>ç¬¬äºŒç§æ–¹æ³•ï¼šå‡å°‘è¿æ¥è¿‡ç¨‹çš„æ¶ˆè€—ã€‚</strong></p><p>æœ‰çš„ä¸šåŠ¡ä»£ç ä¼šåœ¨çŸ­æ—¶é—´å†…å…ˆå¤§é‡ç”³è¯·æ•°æ®åº“è¿æ¥åšå¤‡ç”¨ï¼Œå¦‚æœç°åœ¨æ•°æ®åº“ç¡®è®¤æ˜¯è¢«è¿æ¥è¡Œä¸ºæ‰“æŒ‚äº†ï¼Œé‚£ä¹ˆä¸€ç§å¯èƒ½çš„åšæ³•ï¼Œæ˜¯è®©æ•°æ®åº“è·³è¿‡æƒé™éªŒè¯é˜¶æ®µã€‚</p><p>è·³è¿‡æƒé™éªŒè¯çš„æ–¹æ³•æ˜¯ï¼šé‡å¯æ•°æ®åº“ï¼Œå¹¶ä½¿ç”¨â€“skip-grant-tableså‚æ•°å¯åŠ¨ã€‚è¿™æ ·ï¼Œæ•´ä¸ªMySQLä¼šè·³è¿‡æ‰€æœ‰çš„æƒé™éªŒè¯é˜¶æ®µï¼ŒåŒ…æ‹¬è¿æ¥è¿‡ç¨‹å’Œè¯­å¥æ‰§è¡Œè¿‡ç¨‹åœ¨å†…ã€‚</p><p>ä½†æ˜¯ï¼Œè¿™ç§æ–¹æ³•ç‰¹åˆ«ç¬¦åˆæˆ‘ä»¬æ ‡é¢˜é‡Œè¯´çš„â€œé¥®é¸©æ­¢æ¸´â€ï¼Œé£é™©æé«˜ï¼Œæ˜¯æˆ‘ç‰¹åˆ«ä¸å»ºè®®ä½¿ç”¨çš„æ–¹æ¡ˆã€‚å°¤å…¶ä½ çš„åº“å¤–ç½‘å¯è®¿é—®çš„è¯ï¼Œå°±æ›´ä¸èƒ½è¿™ä¹ˆåšäº†ã€‚</p><p>åœ¨MySQL 8.0ç‰ˆæœ¬é‡Œï¼Œå¦‚æœä½ å¯ç”¨â€“skip-grant-tableså‚æ•°ï¼ŒMySQLä¼šé»˜è®¤æŠŠ --skip-networkingå‚æ•°æ‰“å¼€ï¼Œè¡¨ç¤ºè¿™æ—¶å€™æ•°æ®åº“åªèƒ½è¢«æœ¬åœ°çš„å®¢æˆ·ç«¯è¿æ¥ã€‚å¯è§ï¼ŒMySQLå®˜æ–¹å¯¹skip-grant-tablesè¿™ä¸ªå‚æ•°çš„å®‰å…¨é—®é¢˜ä¹Ÿå¾ˆé‡è§†ã€‚</p><p>é™¤äº†çŸ­è¿æ¥æ•°æš´å¢å¯èƒ½ä¼šå¸¦æ¥æ€§èƒ½é—®é¢˜å¤–ï¼Œå®é™…ä¸Šï¼Œæˆ‘ä»¬åœ¨çº¿ä¸Šç¢°åˆ°æ›´å¤šçš„æ˜¯æŸ¥è¯¢æˆ–è€…æ›´æ–°è¯­å¥å¯¼è‡´çš„æ€§èƒ½é—®é¢˜ã€‚å…¶ä¸­ï¼ŒæŸ¥è¯¢é—®é¢˜æ¯”è¾ƒå…¸å‹çš„æœ‰ä¸¤ç±»ï¼Œä¸€ç±»æ˜¯ç”±æ–°å‡ºç°çš„æ…¢æŸ¥è¯¢å¯¼è‡´çš„ï¼Œä¸€ç±»æ˜¯ç”±QPSï¼ˆæ¯ç§’æŸ¥è¯¢æ•°ï¼‰çªå¢å¯¼è‡´çš„ã€‚è€Œå…³äºæ›´æ–°è¯­å¥å¯¼è‡´çš„æ€§èƒ½é—®é¢˜ï¼Œæˆ‘ä¼šåœ¨ä¸‹ä¸€ç¯‡æ–‡ç« å’Œä½ å±•å¼€è¯´æ˜ã€‚</p><h1>æ…¢æŸ¥è¯¢æ€§èƒ½é—®é¢˜</h1><p>åœ¨MySQLä¸­ï¼Œä¼šå¼•å‘æ€§èƒ½é—®é¢˜çš„æ…¢æŸ¥è¯¢ï¼Œå¤§ä½“æœ‰ä»¥ä¸‹ä¸‰ç§å¯èƒ½ï¼š</p><ol>
<li>
<p>ç´¢å¼•æ²¡æœ‰è®¾è®¡å¥½ï¼›</p>
</li>
<li>
<p>SQLè¯­å¥æ²¡å†™å¥½ï¼›</p>
</li>
<li>
<p>MySQLé€‰é”™äº†ç´¢å¼•ã€‚</p>
</li>
</ol><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±å…·ä½“åˆ†æä¸€ä¸‹è¿™ä¸‰ç§å¯èƒ½ï¼Œä»¥åŠå¯¹åº”çš„è§£å†³æ–¹æ¡ˆã€‚</p><p><strong>å¯¼è‡´æ…¢æŸ¥è¯¢çš„ç¬¬ä¸€ç§å¯èƒ½æ˜¯ï¼Œç´¢å¼•æ²¡æœ‰è®¾è®¡å¥½ã€‚</strong></p><p>è¿™ç§åœºæ™¯ä¸€èˆ¬å°±æ˜¯é€šè¿‡ç´§æ€¥åˆ›å»ºç´¢å¼•æ¥è§£å†³ã€‚MySQL 5.6ç‰ˆæœ¬ä»¥åï¼Œåˆ›å»ºç´¢å¼•éƒ½æ”¯æŒOnline DDLäº†ï¼Œå¯¹äºé‚£ç§é«˜å³°æœŸæ•°æ®åº“å·²ç»è¢«è¿™ä¸ªè¯­å¥æ‰“æŒ‚äº†çš„æƒ…å†µï¼Œæœ€é«˜æ•ˆçš„åšæ³•å°±æ˜¯ç›´æ¥æ‰§è¡Œalter table è¯­å¥ã€‚</p><p>æ¯”è¾ƒç†æƒ³çš„æ˜¯èƒ½å¤Ÿåœ¨å¤‡åº“å…ˆæ‰§è¡Œã€‚å‡è®¾ä½ ç°åœ¨çš„æœåŠ¡æ˜¯ä¸€ä¸»ä¸€å¤‡ï¼Œä¸»åº“Aã€å¤‡åº“Bï¼Œè¿™ä¸ªæ–¹æ¡ˆçš„å¤§è‡´æµç¨‹æ˜¯è¿™æ ·çš„ï¼š</p><ol>
<li>
<p>åœ¨å¤‡åº“Bä¸Šæ‰§è¡Œ set sql_log_bin=offï¼Œä¹Ÿå°±æ˜¯ä¸å†™binlogï¼Œç„¶åæ‰§è¡Œalter table è¯­å¥åŠ ä¸Šç´¢å¼•ï¼›</p>
</li>
<li>
<p>æ‰§è¡Œä¸»å¤‡åˆ‡æ¢ï¼›</p>
</li>
<li>
<p>è¿™æ—¶å€™ä¸»åº“æ˜¯Bï¼Œå¤‡åº“æ˜¯Aã€‚åœ¨Aä¸Šæ‰§è¡Œ set sql_log_bin=offï¼Œç„¶åæ‰§è¡Œalter table è¯­å¥åŠ ä¸Šç´¢å¼•ã€‚</p>
</li>
</ol><p>è¿™æ˜¯ä¸€ä¸ªâ€œå¤è€â€çš„DDLæ–¹æ¡ˆã€‚å¹³æ—¶åœ¨åšå˜æ›´çš„æ—¶å€™ï¼Œä½ åº”è¯¥è€ƒè™‘ç±»ä¼¼gh-ostè¿™æ ·çš„æ–¹æ¡ˆï¼Œæ›´åŠ ç¨³å¦¥ã€‚ä½†æ˜¯åœ¨éœ€è¦ç´§æ€¥å¤„ç†æ—¶ï¼Œä¸Šé¢è¿™ä¸ªæ–¹æ¡ˆçš„æ•ˆç‡æ˜¯æœ€é«˜çš„ã€‚</p><p><strong>å¯¼è‡´æ…¢æŸ¥è¯¢çš„ç¬¬äºŒç§å¯èƒ½æ˜¯ï¼Œè¯­å¥æ²¡å†™å¥½ã€‚</strong></p><p>æ¯”å¦‚ï¼Œæˆ‘ä»¬çŠ¯äº†åœ¨ç¬¬18ç¯‡æ–‡ç« <a href="https://time.geekbang.org/column/article/74059">ã€Šä¸ºä»€ä¹ˆè¿™äº›SQLè¯­å¥é€»è¾‘ç›¸åŒï¼Œæ€§èƒ½å´å·®å¼‚å·¨å¤§ï¼Ÿã€‹</a>ä¸­æåˆ°çš„é‚£äº›é”™è¯¯ï¼Œå¯¼è‡´è¯­å¥æ²¡æœ‰ä½¿ç”¨ä¸Šç´¢å¼•ã€‚</p><p>è¿™æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æ”¹å†™SQLè¯­å¥æ¥å¤„ç†ã€‚MySQL 5.7æä¾›äº†query_rewriteåŠŸèƒ½ï¼Œå¯ä»¥æŠŠè¾“å…¥çš„ä¸€ç§è¯­å¥æ”¹å†™æˆå¦å¤–ä¸€ç§æ¨¡å¼ã€‚</p><p>æ¯”å¦‚ï¼Œè¯­å¥è¢«é”™è¯¯åœ°å†™æˆäº† select * from t where id + 1 = 10000ï¼Œä½ å¯ä»¥é€šè¿‡ä¸‹é¢çš„æ–¹å¼ï¼Œå¢åŠ ä¸€ä¸ªè¯­å¥æ”¹å†™è§„åˆ™ã€‚</p><pre><code>mysql&gt; insert into query_rewrite.rewrite_rules(pattern, replacement, pattern_database) values (&quot;select * from t where id + 1 = ?&quot;, &quot;select * from t where id = ? - 1&quot;, &quot;db1&quot;);

call query_rewrite.flush_rewrite_rules();
</code></pre><p>è¿™é‡Œï¼Œcall query_rewrite.flush_rewrite_rules()è¿™ä¸ªå­˜å‚¨è¿‡ç¨‹ï¼Œæ˜¯è®©æ’å…¥çš„æ–°è§„åˆ™ç”Ÿæ•ˆï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬è¯´çš„â€œæŸ¥è¯¢é‡å†™â€ã€‚ä½ å¯ä»¥ç”¨å›¾4ä¸­çš„æ–¹æ³•æ¥ç¡®è®¤æ”¹å†™è§„åˆ™æ˜¯å¦ç”Ÿæ•ˆã€‚</p><p><img src="https://static001.geekbang.org/resource/image/47/8a/47a1002cbc4c05c74841591d20f7388a.png" alt=""></p><center><span class="reference">å›¾4 æŸ¥è¯¢é‡å†™æ•ˆæœ</span></center><p><strong>å¯¼è‡´æ…¢æŸ¥è¯¢çš„ç¬¬ä¸‰ç§å¯èƒ½ï¼Œå°±æ˜¯ç¢°ä¸Šäº†æˆ‘ä»¬åœ¨ç¬¬10ç¯‡æ–‡ç« </strong><a href="https://time.geekbang.org/column/article/71173"><strong>ã€ŠMySQLä¸ºä»€ä¹ˆæœ‰æ—¶å€™ä¼šé€‰é”™ç´¢å¼•ï¼Ÿã€‹</strong></a><strong>ä¸­æåˆ°çš„æƒ…å†µï¼ŒMySQLé€‰é”™äº†ç´¢å¼•ã€‚</strong></p><p>è¿™æ—¶å€™ï¼Œåº”æ€¥æ–¹æ¡ˆå°±æ˜¯ç»™è¿™ä¸ªè¯­å¥åŠ ä¸Šforce indexã€‚</p><p>åŒæ ·åœ°ï¼Œä½¿ç”¨æŸ¥è¯¢é‡å†™åŠŸèƒ½ï¼Œç»™åŸæ¥çš„è¯­å¥åŠ ä¸Šforce indexï¼Œä¹Ÿå¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p><p>ä¸Šé¢æˆ‘å’Œä½ è®¨è®ºçš„ç”±æ…¢æŸ¥è¯¢å¯¼è‡´æ€§èƒ½é—®é¢˜çš„ä¸‰ç§å¯èƒ½æƒ…å†µï¼Œå®é™…ä¸Šå‡ºç°æœ€å¤šçš„æ˜¯å‰ä¸¤ç§ï¼Œå³ï¼šç´¢å¼•æ²¡è®¾è®¡å¥½å’Œè¯­å¥æ²¡å†™å¥½ã€‚è€Œè¿™ä¸¤ç§æƒ…å†µï¼Œæ°æ°æ˜¯å®Œå…¨å¯ä»¥é¿å…çš„ã€‚æ¯”å¦‚ï¼Œé€šè¿‡ä¸‹é¢è¿™ä¸ªè¿‡ç¨‹ï¼Œæˆ‘ä»¬å°±å¯ä»¥é¢„å…ˆå‘ç°é—®é¢˜ã€‚</p><ol>
<li>
<p>ä¸Šçº¿å‰ï¼Œåœ¨æµ‹è¯•ç¯å¢ƒï¼ŒæŠŠæ…¢æŸ¥è¯¢æ—¥å¿—ï¼ˆslow logï¼‰æ‰“å¼€ï¼Œå¹¶ä¸”æŠŠlong_query_timeè®¾ç½®æˆ0ï¼Œç¡®ä¿æ¯ä¸ªè¯­å¥éƒ½ä¼šè¢«è®°å½•å…¥æ…¢æŸ¥è¯¢æ—¥å¿—ï¼›</p>
</li>
<li>
<p>åœ¨æµ‹è¯•è¡¨é‡Œæ’å…¥æ¨¡æ‹Ÿçº¿ä¸Šçš„æ•°æ®ï¼Œåšä¸€éå›å½’æµ‹è¯•ï¼›</p>
</li>
<li>
<p>è§‚å¯Ÿæ…¢æŸ¥è¯¢æ—¥å¿—é‡Œæ¯ç±»è¯­å¥çš„è¾“å‡ºï¼Œç‰¹åˆ«ç•™æ„Rows_examinedå­—æ®µæ˜¯å¦ä¸é¢„æœŸä¸€è‡´ã€‚ï¼ˆæˆ‘ä»¬åœ¨å‰é¢æ–‡ç« ä¸­å·²ç»å¤šæ¬¡ç”¨åˆ°è¿‡Rows_examinedæ–¹æ³•äº†ï¼Œç›¸ä¿¡ä½ å·²ç»åŠ¨æ‰‹å°è¯•è¿‡äº†ã€‚å¦‚æœè¿˜æœ‰ä¸æ˜ç™½çš„ï¼Œæ¬¢è¿ç»™æˆ‘ç•™è¨€ï¼Œæˆ‘ä»¬ä¸€èµ·è®¨è®ºï¼‰ã€‚</p>
</li>
</ol><p>ä¸è¦åå•¬è¿™æ®µèŠ±åœ¨ä¸Šçº¿å‰çš„â€œé¢å¤–â€æ—¶é—´ï¼Œå› ä¸ºè¿™ä¼šå¸®ä½ çœä¸‹å¾ˆå¤šæ•…éšœå¤ç›˜çš„æ—¶é—´ã€‚</p><p>å¦‚æœæ–°å¢çš„SQLè¯­å¥ä¸å¤šï¼Œæ‰‹åŠ¨è·‘ä¸€ä¸‹å°±å¯ä»¥ã€‚è€Œå¦‚æœæ˜¯æ–°é¡¹ç›®çš„è¯ï¼Œæˆ–è€…æ˜¯ä¿®æ”¹äº†åŸæœ‰é¡¹ç›®çš„ è¡¨ç»“æ„è®¾è®¡ï¼Œå…¨é‡å›å½’æµ‹è¯•éƒ½æ˜¯å¿…è¦çš„ã€‚è¿™æ—¶å€™ï¼Œä½ éœ€è¦å·¥å…·å¸®ä½ æ£€æŸ¥æ‰€æœ‰çš„SQLè¯­å¥çš„è¿”å›ç»“æœã€‚æ¯”å¦‚ï¼Œä½ å¯ä»¥ä½¿ç”¨å¼€æºå·¥å…·pt-query-digest(<a href="https://www.percona.com/doc/percona-toolkit/3.0/pt-query-digest.html">https://www.percona.com/doc/percona-toolkit/3.0/pt-query-digest.html</a>)ã€‚</p><h1>QPSçªå¢é—®é¢˜</h1><p>æœ‰æ—¶å€™ç”±äºä¸šåŠ¡çªç„¶å‡ºç°é«˜å³°ï¼Œæˆ–è€…åº”ç”¨ç¨‹åºbugï¼Œå¯¼è‡´æŸä¸ªè¯­å¥çš„QPSçªç„¶æš´æ¶¨ï¼Œä¹Ÿå¯èƒ½å¯¼è‡´MySQLå‹åŠ›è¿‡å¤§ï¼Œå½±å“æœåŠ¡ã€‚</p><p>æˆ‘ä¹‹å‰ç¢°åˆ°è¿‡ä¸€ç±»æƒ…å†µï¼Œæ˜¯ç”±ä¸€ä¸ªæ–°åŠŸèƒ½çš„bugå¯¼è‡´çš„ã€‚å½“ç„¶ï¼Œæœ€ç†æƒ³çš„æƒ…å†µæ˜¯è®©ä¸šåŠ¡æŠŠè¿™ä¸ªåŠŸèƒ½ä¸‹æ‰ï¼ŒæœåŠ¡è‡ªç„¶å°±ä¼šæ¢å¤ã€‚</p><p>è€Œä¸‹æ‰ä¸€ä¸ªåŠŸèƒ½ï¼Œå¦‚æœä»æ•°æ®åº“ç«¯å¤„ç†çš„è¯ï¼Œå¯¹åº”äºä¸åŒçš„èƒŒæ™¯ï¼Œæœ‰ä¸åŒçš„æ–¹æ³•å¯ç”¨ã€‚æˆ‘è¿™é‡Œå†å’Œä½ å±•å¼€è¯´æ˜ä¸€ä¸‹ã€‚</p><ol>
<li>
<p>ä¸€ç§æ˜¯ç”±å…¨æ–°ä¸šåŠ¡çš„bugå¯¼è‡´çš„ã€‚å‡è®¾ä½ çš„DBè¿ç»´æ˜¯æ¯”è¾ƒè§„èŒƒçš„ï¼Œä¹Ÿå°±æ˜¯è¯´ç™½åå•æ˜¯ä¸€ä¸ªä¸ªåŠ çš„ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œå¦‚æœä½ èƒ½å¤Ÿç¡®å®šä¸šåŠ¡æ–¹ä¼šä¸‹æ‰è¿™ä¸ªåŠŸèƒ½ï¼Œåªæ˜¯æ—¶é—´ä¸Šæ²¡é‚£ä¹ˆå¿«ï¼Œé‚£ä¹ˆå°±å¯ä»¥ä»æ•°æ®åº“ç«¯ç›´æ¥æŠŠç™½åå•å»æ‰ã€‚</p>
</li>
<li>
<p>å¦‚æœè¿™ä¸ªæ–°åŠŸèƒ½ä½¿ç”¨çš„æ˜¯å•ç‹¬çš„æ•°æ®åº“ç”¨æˆ·ï¼Œå¯ä»¥ç”¨ç®¡ç†å‘˜è´¦å·æŠŠè¿™ä¸ªç”¨æˆ·åˆ æ‰ï¼Œç„¶åæ–­å¼€ç°æœ‰è¿æ¥ã€‚è¿™æ ·ï¼Œè¿™ä¸ªæ–°åŠŸèƒ½çš„è¿æ¥ä¸æˆåŠŸï¼Œç”±å®ƒå¼•å‘çš„QPSå°±ä¼šå˜æˆ0ã€‚</p>
</li>
<li>
<p>å¦‚æœè¿™ä¸ªæ–°å¢çš„åŠŸèƒ½è·Ÿä¸»ä½“åŠŸèƒ½æ˜¯éƒ¨ç½²åœ¨ä¸€èµ·çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬åªèƒ½é€šè¿‡å¤„ç†è¯­å¥æ¥é™åˆ¶ã€‚è¿™æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸Šé¢æåˆ°çš„æŸ¥è¯¢é‡å†™åŠŸèƒ½ï¼ŒæŠŠå‹åŠ›æœ€å¤§çš„SQLè¯­å¥ç›´æ¥é‡å†™æˆ"select 1"è¿”å›ã€‚</p>
</li>
</ol><p>å½“ç„¶ï¼Œè¿™ä¸ªæ“ä½œçš„é£é™©å¾ˆé«˜ï¼Œéœ€è¦ä½ ç‰¹åˆ«ç»†è‡´ã€‚å®ƒå¯èƒ½å­˜åœ¨ä¸¤ä¸ªå‰¯ä½œç”¨ï¼š</p><ol>
<li>
<p>å¦‚æœåˆ«çš„åŠŸèƒ½é‡Œé¢ä¹Ÿç”¨åˆ°äº†è¿™ä¸ªSQLè¯­å¥æ¨¡æ¿ï¼Œä¼šæœ‰è¯¯ä¼¤ï¼›</p>
</li>
<li>
<p>å¾ˆå¤šä¸šåŠ¡å¹¶ä¸æ˜¯é è¿™ä¸€ä¸ªè¯­å¥å°±èƒ½å®Œæˆé€»è¾‘çš„ï¼Œæ‰€ä»¥å¦‚æœå•ç‹¬æŠŠè¿™ä¸€ä¸ªè¯­å¥ä»¥select 1çš„ç»“æœè¿”å›çš„è¯ï¼Œå¯èƒ½ä¼šå¯¼è‡´åé¢çš„ä¸šåŠ¡é€»è¾‘ä¸€èµ·å¤±è´¥ã€‚</p>
</li>
</ol><p>æ‰€ä»¥ï¼Œæ–¹æ¡ˆ3æ˜¯ç”¨äºæ­¢è¡€çš„ï¼Œè·Ÿå‰é¢æåˆ°çš„å»æ‰æƒé™éªŒè¯ä¸€æ ·ï¼Œåº”è¯¥æ˜¯ä½ æ‰€æœ‰é€‰é¡¹é‡Œä¼˜å…ˆçº§æœ€ä½çš„ä¸€ä¸ªæ–¹æ¡ˆã€‚</p><p>åŒæ—¶ä½ ä¼šå‘ç°ï¼Œå…¶å®æ–¹æ¡ˆ1å’Œ2éƒ½è¦ä¾èµ–äºè§„èŒƒçš„è¿ç»´ä½“ç³»ï¼šè™šæ‹ŸåŒ–ã€ç™½åå•æœºåˆ¶ã€ä¸šåŠ¡è´¦å·åˆ†ç¦»ã€‚ç”±æ­¤å¯è§ï¼Œæ›´å¤šçš„å‡†å¤‡ï¼Œå¾€å¾€æ„å‘³ç€æ›´ç¨³å®šçš„ç³»ç»Ÿã€‚</p><h1>å°ç»“</h1><p>ä»Šå¤©è¿™ç¯‡æ–‡ç« ï¼Œæˆ‘ä»¥ä¸šåŠ¡é«˜å³°æœŸçš„æ€§èƒ½é—®é¢˜ä¸ºèƒŒæ™¯ï¼Œå’Œä½ ä»‹ç»äº†ä¸€äº›ç´§æ€¥å¤„ç†çš„æ‰‹æ®µã€‚</p><p>è¿™äº›å¤„ç†æ‰‹æ®µä¸­ï¼Œæ—¢åŒ…æ‹¬äº†ç²—æš´åœ°æ‹’ç»è¿æ¥å’Œæ–­å¼€è¿æ¥ï¼Œä¹Ÿæœ‰é€šè¿‡é‡å†™è¯­å¥æ¥ç»•è¿‡ä¸€äº›å‘çš„æ–¹æ³•ï¼›æ—¢æœ‰ä¸´æ—¶çš„é«˜å±æ–¹æ¡ˆï¼Œä¹Ÿæœ‰æœªé›¨ç»¸ç¼ªçš„ã€ç›¸å¯¹å®‰å…¨çš„é¢„æ¡ˆã€‚</p><p>åœ¨å®é™…å¼€å‘ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿè¦å°½é‡é¿å…ä¸€äº›ä½æ•ˆçš„æ–¹æ³•ï¼Œæ¯”å¦‚é¿å…å¤§é‡åœ°ä½¿ç”¨çŸ­è¿æ¥ã€‚åŒæ—¶ï¼Œå¦‚æœä½ åšä¸šåŠ¡å¼€å‘çš„è¯ï¼Œè¦çŸ¥é“ï¼Œè¿æ¥å¼‚å¸¸æ–­å¼€æ˜¯å¸¸æœ‰çš„äº‹ï¼Œä½ çš„ä»£ç é‡Œè¦æœ‰æ­£ç¡®åœ°é‡è¿å¹¶é‡è¯•çš„æœºåˆ¶ã€‚</p><p>DBAè™½ç„¶å¯ä»¥é€šè¿‡è¯­å¥é‡å†™æ¥æš‚æ—¶å¤„ç†é—®é¢˜ï¼Œä½†æ˜¯è¿™æœ¬èº«æ˜¯ä¸€ä¸ªé£é™©é«˜çš„æ“ä½œï¼Œåšå¥½SQLå®¡è®¡å¯ä»¥å‡å°‘éœ€è¦è¿™ç±»æ“ä½œçš„æœºä¼šã€‚</p><p>å…¶å®ï¼Œä½ å¯ä»¥çœ‹å¾—å‡ºæ¥ï¼Œåœ¨è¿™ç¯‡æ–‡ç« ä¸­æˆ‘æåˆ°çš„è§£å†³æ–¹æ³•ä¸»è¦é›†ä¸­åœ¨serverå±‚ã€‚åœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä¼šç»§ç»­å’Œä½ è®¨è®ºä¸€äº›è·ŸInnoDBæœ‰å…³çš„å¤„ç†æ–¹æ³•ã€‚</p><p>æœ€åï¼Œåˆåˆ°äº†æˆ‘ä»¬çš„æ€è€ƒé¢˜æ—¶é—´äº†ã€‚</p><p>ä»Šå¤©ï¼Œæˆ‘ç•™ç»™ä½ çš„è¯¾åé—®é¢˜æ˜¯ï¼Œä½ æ˜¯å¦ç¢°åˆ°è¿‡ï¼Œåœ¨ä¸šåŠ¡é«˜å³°æœŸéœ€è¦ä¸´æ—¶æ•‘ç«çš„åœºæ™¯ï¼Ÿä½ åˆæ˜¯æ€ä¹ˆå¤„ç†çš„å‘¢ï¼Ÿ</p><p>ä½ å¯ä»¥æŠŠä½ çš„ç»å†å’Œç»éªŒå†™åœ¨ç•™è¨€åŒºï¼Œæˆ‘ä¼šåœ¨ä¸‹ä¸€ç¯‡æ–‡ç« çš„æœ«å°¾é€‰å–æœ‰è¶£çš„è¯„è®ºè·Ÿå¤§å®¶ä¸€èµ·åˆ†äº«å’Œåˆ†æã€‚æ„Ÿè°¢ä½ çš„æ”¶å¬ï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠè¿™ç¯‡æ–‡ç« åˆ†äº«ç»™æ›´å¤šçš„æœ‹å‹ä¸€èµ·é˜…è¯»ã€‚</p><h1>ä¸ŠæœŸé—®é¢˜æ—¶é—´</h1><p>å‰ä¸¤æœŸæˆ‘ç»™ä½ ç•™çš„é—®é¢˜æ˜¯ï¼Œä¸‹é¢è¿™ä¸ªå›¾çš„æ‰§è¡Œåºåˆ—ä¸­ï¼Œä¸ºä»€ä¹ˆsession Bçš„insertè¯­å¥ä¼šè¢«å µä½ã€‚</p><p><img src="https://static001.geekbang.org/resource/image/3a/1e/3a7578e104612a188a2d574eaa3bd81e.png" alt=""><br>
æˆ‘ä»¬ç”¨ä¸Šä¸€ç¯‡çš„åŠ é”è§„åˆ™æ¥åˆ†æä¸€ä¸‹ï¼Œçœ‹çœ‹session Açš„selectè¯­å¥åŠ äº†å“ªäº›é”ï¼š</p><ol>
<li>
<p>ç”±äºæ˜¯order by c descï¼Œç¬¬ä¸€ä¸ªè¦å®šä½çš„æ˜¯ç´¢å¼•cä¸Šâ€œæœ€å³è¾¹çš„â€c=20çš„è¡Œï¼Œæ‰€ä»¥ä¼šåŠ ä¸Šé—´éš™é”(20,25)å’Œnext-key lock (15,20]ã€‚</p>
</li>
<li>
<p>åœ¨ç´¢å¼•cä¸Šå‘å·¦éå†ï¼Œè¦æ‰«æåˆ°c=10æ‰åœä¸‹æ¥ï¼Œæ‰€ä»¥next-key lockä¼šåŠ åˆ°(5,10]ï¼Œè¿™æ­£æ˜¯é˜»å¡session Bçš„insertè¯­å¥çš„åŸå› ã€‚</p>
</li>
<li>
<p>åœ¨æ‰«æè¿‡ç¨‹ä¸­ï¼Œc=20ã€c=15ã€c=10è¿™ä¸‰è¡Œéƒ½å­˜åœ¨å€¼ï¼Œç”±äºæ˜¯select *ï¼Œæ‰€ä»¥ä¼šåœ¨ä¸»é”®idä¸ŠåŠ ä¸‰ä¸ªè¡Œé”ã€‚</p>
</li>
</ol><p>å› æ­¤ï¼Œsession A çš„selectè¯­å¥é”çš„èŒƒå›´å°±æ˜¯ï¼š</p><ol>
<li>
<p>ç´¢å¼•cä¸Š (5, 25)ï¼›</p>
</li>
<li>
<p>ä¸»é”®ç´¢å¼•ä¸Šid=10ã€15ã€20ä¸‰ä¸ªè¡Œé”ã€‚</p>
</li>
</ol><p>è¿™é‡Œï¼Œæˆ‘å†å•°å—¦ä¸‹ï¼Œä½ ä¼šå‘ç°æˆ‘åœ¨æ–‡ç« ä¸­ï¼Œæ¯æ¬¡åŠ é”éƒ½ä¼šè¯´æ˜æ˜¯åŠ åœ¨â€œå“ªä¸ªç´¢å¼•ä¸Šâ€çš„ã€‚å› ä¸ºï¼Œé”å°±æ˜¯åŠ åœ¨ç´¢å¼•ä¸Šçš„ï¼Œè¿™æ˜¯InnoDBçš„ä¸€ä¸ªåŸºç¡€è®¾å®šï¼Œéœ€è¦ä½ åœ¨åˆ†æé—®é¢˜çš„æ—¶å€™è¦ä¸€ç›´è®°å¾—ã€‚</p><p>è¯„è®ºåŒºç•™è¨€ç‚¹èµæ¿ï¼š</p><blockquote>
<p>@HuaMax ç»™å‡ºäº†æ­£ç¡®çš„è§£é‡Šã€‚</p>
</blockquote><blockquote>
<p>@Justin åŒå­¦æäº†ä¸ªå¥½é—®é¢˜ï¼Œ&lt;=åˆ°åº•æ˜¯é—´éš™é”è¿˜æ˜¯è¡Œé”ï¼Ÿå…¶å®ï¼Œè¿™ä¸ªé—®é¢˜ï¼Œä½ è¦è·Ÿâ€œæ‰§è¡Œè¿‡ç¨‹â€é…åˆèµ·æ¥åˆ†æã€‚åœ¨InnoDBè¦å»æ‰¾â€œç¬¬ä¸€ä¸ªå€¼â€çš„æ—¶å€™ï¼Œæ˜¯æŒ‰ç…§ç­‰å€¼å»æ‰¾çš„ï¼Œç”¨çš„æ˜¯ç­‰å€¼åˆ¤æ–­çš„è§„åˆ™ï¼›æ‰¾åˆ°ç¬¬ä¸€ä¸ªå€¼ä»¥åï¼Œè¦åœ¨ç´¢å¼•å†…æ‰¾â€œä¸‹ä¸€ä¸ªå€¼â€ï¼Œå¯¹åº”äºæˆ‘ä»¬è§„åˆ™ä¸­è¯´çš„èŒƒå›´æŸ¥æ‰¾ã€‚</p>
</blockquote><blockquote>
<p>@ä¿¡ä¿¡ æäº†ä¸€ä¸ªä¸é”™çš„é—®é¢˜ï¼Œè¦çŸ¥é“æœ€ç»ˆçš„åŠ é”æ˜¯æ ¹æ®å®é™…æ‰§è¡Œæƒ…å†µæ¥çš„ã€‚æ‰€ä»¥ï¼Œå¦‚æœä¸€ä¸ªselect * from ... for update è¯­å¥ï¼Œä¼˜åŒ–å™¨å†³å®šä½¿ç”¨å…¨è¡¨æ‰«æï¼Œé‚£ä¹ˆå°±ä¼šæŠŠä¸»é”®ç´¢å¼•ä¸Šnext-key lockå…¨åŠ ä¸Šã€‚</p>
</blockquote><blockquote>
<p>@nero åŒå­¦çš„é—®é¢˜ï¼Œæç¤ºæˆ‘éœ€è¦æé†’å¤§å®¶æ³¨æ„ï¼Œâ€œæœ‰è¡Œâ€æ‰ä¼šåŠ è¡Œé”ã€‚å¦‚æœæŸ¥è¯¢æ¡ä»¶æ²¡æœ‰å‘½ä¸­è¡Œï¼Œé‚£å°±åŠ next-key lockã€‚å½“ç„¶ï¼Œç­‰å€¼åˆ¤æ–­çš„æ—¶å€™ï¼Œéœ€è¦åŠ ä¸Šä¼˜åŒ–2ï¼ˆå³ï¼šç´¢å¼•ä¸Šçš„ç­‰å€¼æŸ¥è¯¢ï¼Œå‘å³éå†æ—¶ä¸”æœ€åä¸€ä¸ªå€¼ä¸æ»¡è¶³ç­‰å€¼æ¡ä»¶çš„æ—¶å€™ï¼Œnext-key locké€€åŒ–ä¸ºé—´éš™é”ã€‚ï¼‰ã€‚</p>
</blockquote><blockquote>
<p>@å°æå­ã€@å‘æ¡æ©™å­åŒå­¦ï¼Œéƒ½æäº†å¾ˆå¥½çš„é—®é¢˜ï¼Œè¿™æœŸé«˜è´¨é‡è¯„è®ºå¾ˆå¤šï¼Œä½ ä¹Ÿéƒ½å¯ä»¥å»çœ‹çœ‹ã€‚</p>
</blockquote><p>æœ€åï¼Œæˆ‘è¦ä¸ºå…ƒæ—¦æœŸé—´è¿˜åšæŒå­¦ä¹ çš„åŒå­¦ä»¬ï¼Œç‚¹ä¸ªèµ ^_^</p><p><img src="https://static001.geekbang.org/resource/image/09/77/09c1073f99cf71d2fb162a716b5fa577.jpg" alt=""></p>
                    </div>
                </div>

            </div>
            <div data-v-87ffcada="" class="article-comments pd"><h2 data-v-87ffcada=""><span
                    data-v-87ffcada="">ç²¾é€‰ç•™è¨€</span></h2>
                <ul data-v-87ffcada="">
                    
                    <li data-v-87ffcada="" class="comment-item"><img
                            src="https://static001.geekbang.org/account/avatar/00/13/f8/70/f3a33a14.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">æŸã€äºº</span>
                            </div>
                            <div class="bd">æœ€è¿‘æ‰å‘ç”Ÿäº†ä¸ªæ¡ˆåˆ—:<br>ç”±äºä¸€ä¸ªdeleteå¤§äº‹åŠ¡å¯¼è‡´ç£ç›˜ç©ºé—´æ»¡äº†,æ•°æ®åº“hangä½,è¿æ¥ä¸ä¸Š,æ‰€ä»¥æ— æ³•killæ‰è¯¥å¤§äº‹åŠ¡<br>å½“æ—¶çš„è§‚å¯Ÿåˆ°çš„ç°è±¡æ˜¯:<br>binlogæœ‰ä¸€ä¸ªæ–‡ä»¶å·²ç»è¾¾åˆ°50å¤šG<br>lsof | grep delete è¯¥tmpæ–‡ä»¶100å¤šG<br>redo logè¿˜æ˜¯åªæœ‰4ä¸ªç»„,æ¯ä¸ªæ–‡ä»¶1G<br>undo logå¤§æ¦‚æœ‰100æ¥G<br>ç”±äºæ•°æ®åº“è¿ä¸ä¸Š,åªæœ‰æŠŠè¿æ¥åˆ‡åˆ°ä»åº“,killæ‰ä¸»åº“çš„è¿›ç¨‹ã€‚è¿‡äº†å‡ åˆ†é’Ÿ,binlogæ–‡ä»¶æ‰ç¼©å°ä¸ºåŸæ¥çš„å¤§å°ã€‚æŠŠä¸»åº“å¯èµ·æ¥,ä½†æ˜¯recoveryéå¸¸æ…¢ã€‚åé¢killæ‰,åˆä»¥innodb_force_recovery=3æ¢å¤,recoveryä¹Ÿæ˜¯åŠå¤©æ²¡ååº”ã€‚ç”±äºè¿™ä¸ªåº“ä¹Ÿä¸æ˜¯é‡è¦çš„åº“,å°±æŠŠæ–°çš„ä¸»åº“çš„å¤‡ä»½æ–‡ä»¶é‡åšäº†ä¹‹å‰çš„ä¸»åº“,ä»¥ä»åº“å¯èµ·æ¥<br><br>é€šè¿‡æœ€è¿‘çš„å­¦ä¹ +æµ‹è¯•åˆ†æäº†ä¸‹,ä¸ºä»€ä¹ˆbinlogè¾¾åˆ°äº†50å¤šGã€‚tmpæ–‡ä»¶100å¤šG.<br>ç”±äºbinlog_cacheä¸å¤Ÿç”¨,æŠŠbinlogå†™è¿›äº†tmpæ–‡ä»¶ä¸­,binlogæ–‡ä»¶50å¤šG,è¯´æ˜äº‹åŠ¡å·²ç»æ‰§è¡Œå®Œæˆ,æ˜¯binlogåœ¨fsyncé˜¶æ®µ,æŠŠç©ºé—´å æ»¡äº†ã€‚fsyncå¹¶ä¸æ˜¯ä¸€ä¸ªmoveè€Œæ˜¯ç›¸å½“äºcopyã€‚è¦ç­‰binlogå®Œå…¨è½ç›˜ä»¥å,æ‰ä¼šåˆ é™¤ä¹‹å‰çš„tmpæ–‡ä»¶ã€‚redo logç”±äºæ˜¯å¾ªç¯å†™,è€Œä¸”åœ¨äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­,å°±ä¼šæŠŠredo logåˆ†ä¸ºmtxè½åœ°åˆ°ç£ç›˜ä¸Šã€‚æ‰€ä»¥æ²¡æœ‰ä¸€æ¬¡æ€§æš´å¢,è¿˜æ˜¯ä»¥1Gçš„å¤§å°æŒç»­å†™.<br>æˆ‘ä¹Ÿæ˜¯åç»­åšæµ‹è¯•,è§‚å¯Ÿåœ¨äº‹åŠ¡è¿›è¡Œä¸­,redo logæ–‡ä»¶ä¸€ç›´éƒ½æœ‰å˜åŒ–ã€‚binlogæ²¡æœ‰å˜åŒ–<br>binlogæ˜¯åœ¨äº‹åŠ¡æ‰§è¡Œå®Œä»¥å,æ‰ä¸€æ¬¡æ€§fsyncåˆ°ç£ç›˜<br>ä½†æ˜¯ä¸ºä»€ä¹ˆrecovery=3çš„æƒ…å†µä¸‹,è¿˜æ¯”è¾ƒè€—æ—¶ã€‚æˆ‘ä¼°è®¡æ˜¯ä¹‹å‰è„é¡µè¾ƒå¤š,è€Œredo logåˆå…¨éƒ¨è¢«è¦†ç›–æ‰,<br>éœ€è¦å…ˆé€šè¿‡binlogæ¥æ¢å¤redo log,ç„¶åå†é€šè¿‡redo logæ¥æ¢å¤æ•°æ®é¡µã€‚<br><br>è¯·é—®è€å¸ˆæœ‰æ²¡æœ‰æ›´å¥½çš„åŠæ³•æ¥å¤„ç†è¿™ç§hangä½çš„æƒ…å†µ?<br>å¦‚æœåœ¨æ“ä½œç³»ç»Ÿå±‚é¢killæ‰æ‰§è¡Œçš„çº¿ç¨‹,å°±å¥½äº†ã€‚<br>æ˜¨å¤©æåˆ°çš„é—®é¢˜3,æˆ‘ä¹Ÿæ²¡æœ‰æµ‹è¯•å‡ºæ¥Sending to clientè¿™ä¸ªçŠ¶æ€.æ˜¯ä¹‹å‰åˆ«äººé—®åˆ°çš„,æˆ‘ä¹ŸæŒºæ‡µ <br></div>
                            <span class="time">2019-01-03 19:56</span>
                            
                            <div class="reply">
                                <div class="reply-hd"><span>ä½œè€…å›å¤</span></div>
                                <p class="reply-content">å…ˆè¯´æ˜ä¸‹ï¼Œbinlogæ˜¯æ²¡æœ‰â€œæ¢å¤redologâ€çš„èƒ½åŠ›çš„å“ˆã€‚å…¶å®ƒéƒ¨åˆ†åˆ†æå¾—å¾ˆå¥½ğŸ‘ğŸ¿<br><br>Binlog è¿™ä¹ˆå¤§ï¼Œè¯´æ˜æ˜¯å¤§äº‹åŠ¡ï¼Œå´©æºƒæ¢å¤çš„æ—¶å€™è¦å¤„ç†çš„redolog å¾ˆå¤šï¼Œä¼°è®¡è€—æ—¶é—´è€—åœ¨è¿™ã€‚<br><br>è¿™ç§ç£ç›˜ç©ºé—´æ»¡çš„æƒ…å†µï¼Œä»¥å‰æˆ‘çš„å¤„ç†æ–¹æ³•æ˜¯æŠŠæœ€è€çš„binlogç§»åŠ¨åˆ°åˆ«çš„ç›˜ï¼ˆå¦‚æœç¡®å®šæ—¥å¿—å·²ç»å¤‡ä»½åˆ°å¤‡ä»½ç³»ç»Ÿäº†å°±åˆ æ‰ï¼‰ï¼Œç›®çš„æ˜¯è…¾å‡ºç©ºé—´è®©è¿™ä¸ªäº‹åŠ¡æ‰§è¡Œå®Œæˆã€‚<br>åé¢å¯ä»¥è€ƒè™‘è¿™ç§æ–¹æ¡ˆï¼Œå¼ºåˆ¶é‡å¯è¿˜æ˜¯æœ‰ç‚¹ä¼¤çš„ï¼Œä¸è¿‡æ ¸å¿ƒè¿˜æ˜¯åšå¥½ç›‘æ§ï¼Œä¸è®©å‡ºç°ç£ç›˜100%å†™æ»¡çš„æƒ…å†µ</p>
                                <p class="reply-time">2019-01-03 22:09</p>
                            </div>
                            
                        </div>
                    </li>
                    
                    <li data-v-87ffcada="" class="comment-item"><img
                            src="https://static001.geekbang.org/account/avatar/00/14/20/3a/90db6a24.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">Long</span>
                            </div>
                            <div class="bd">ä¸æ˜¯ä¸“ä¸šDBAï¼Œé‡åˆ°è¿‡å‡ æ¬¡æ•°æ®åº“é—®é¢˜ï¼Œæœ‰çš„èƒ½è§£å†³ï¼Œæœ‰çš„å¥½åƒé™¤äº†é‡å¯æˆ–è€…å¹²ç­‰ç€æ²¡å•¥å¥½åŠæ³•ã€‚<br>MySQL5.6ç‰ˆæœ¬é‡åˆ°çš„éƒ¨åˆ†é—®é¢˜ï¼š<br><br>1. å‡ ä¸ªçº¿ç¨‹å¤„äºkilledçŠ¶æ€ä¸€ç›´killä¸æ‰ï¼ˆ1å¤©ï¼‰ï¼Œç„¶åå¤‡ä»½çš„æ—¶å€™MySQL backup flush all tables with read lockçš„æ—¶å€™è¢«é˜»å¡ï¼Œåé¢çš„çº¿ç¨‹åªèƒ½ç­‰å¾…flush table, kill backupä»¥åä¹Ÿæ²¡æœ‰åŠæ³•killé‚£å‡ ä¸ªkilledçŠ¶æ€çš„è¯­å¥ï¼ˆprocesslistæ˜¾ç¤ºçš„killedçŠ¶æ€çš„è¯­å¥çš„å°±æ˜¯show columns, show create tableè¿™æ ·çš„ï¼‰ï¼Œåé¢æ²¡åŠæ³•ï¼Œé‡å¯äº†serverã€‚ï¼ˆçœ‹åˆ°è€å¸ˆåé¢ç¬¬25è®²æœ‰å…³äºkillçš„è§£é‡Šï¼Œéå¸¸æœŸå¾…æ–°çŸ¥è¯†ï¼‰<br><br>2. ä¸€ä¸ªéå¸¸å¤§ï¼ˆå¤§å‡ ç™¾ä¸‡è¡Œï¼‰çš„è¡¨truncateï¼Œç»“æœåé¢æ‰€æœ‰çš„çº¿ç¨‹éƒ½é˜»å¡äº†ï¼Œç±»ä¼¼äºä¸‹é¢è¿™ä¸ªMySQL bugçš„åœºæ™¯ï¼Œç»“æœå°±æ˜¯ç­‰è¿™ä¸ªtruncateç»“æŸã€‚æ²¡æœ‰ç»§ç»­å¹²é¢„ã€‚<br>https:&#47;&#47;bugs.mysql.com&#47;bug.php?id=80060<br><br>3.  æŸä¸ªæ–°åŠŸèƒ½ä¸Šçº¿ä»¥åï¼Œä¸€ä¸ªè®°å½•æ“ä½œäººå‘˜æ“ä½œé¡µé¢æ“ä½œæ—¶é—´KPIçš„åŠŸèƒ½ï¼Œç”±äºsqlæ€§èƒ½ä¸å¥½ï¼Œåœ¨ä¸šåŠ¡ä¸Šçº¿è·‘äº†3å¤©åæ•°æ®é‡å¢å¤šåˆ°ä¸´ç•Œå€¼ï¼Œçªç„¶å½±å“äº†æ•´ä¸ªç³»ç»Ÿæ€§èƒ½ã€‚æ•°æ®åº“å‘ç°æ˜¯å¤§é‡çš„sqlæ‰§è¡ŒçŠ¶æ€æ˜¯converting heap to MyISAMï¼Œsqlå†™æ³•ç±»ä¼¼ select (select * from table) where id(æœ‰ç´¢å¼•)= xxxx order by yyyy<br>DBAä»¥åŠä»–ä»¬å›¢é˜Ÿè¦æ±‚é‡å¯ã€‚ä½†æ˜¯åˆ†æäº†å‡ åˆ†é’Ÿåæä¾›äº†å‡ ä¸ªæ„è§ç»™&quot;DBA&quot;ï¼Œå¹¶è§£é‡Šé‡å¯è§£å†³ä¸äº†é—®é¢˜ï¼šé¦–å…ˆè¿™ä¸ªé—®é¢˜é‡å¯æ˜¯è§£å†³ä¸äº†ï¼Œå› ä¸ºæ¯æ¬¡è¿™ä¸ªsqlæŸ¥è¯¢å…¨è¡¨ï¼ŒæŸ¥è¯¢åˆ†é…çš„ä¸´æ—¶è¡¨ç©ºé—´ä¸è¶³äº†ï¼Œéœ€è¦æŠŠç»“æœé›†è½¬åˆ°ç£ç›˜ä¸Šï¼Œé‡å¯äº†sqlåŠ¨ä½œæ²¡å˜ï¼Œå‚æ•°æ²¡å˜æ‰€ä»¥é‡å¯è§£å†³ä¸äº†é—®é¢˜ã€‚<br>é¡µé¢æŸ¥è¯¢ä¹Ÿæ²¡æ³•å±è”½ï¼Œé¡µé¢æŸ¥è¯¢ä¹Ÿæ— æ³•è¿‡æ»¤æ¡ä»¶ï¼Œ<br>ï¼ˆ1ï¼‰å’Œç ”å‘ç¡®è®¤åï¼Œè¡¨æ•°æ®åˆ é™¤ä¸å½±å“åŠŸèƒ½ï¼Œåªå½±å“å®¢æˆ·çš„KPIæŠ¥è¡¨ï¼Œå…ˆå¤‡ä»½è¡¨ï¼Œç„¶ååˆ é™¤ï¼Œåé¢ç­‰åŠŸèƒ½ä¿®å¤äº†å†è¡¥å›å»ã€‚<br>ï¼ˆ2ï¼‰è°ƒæ•´max_heap_table_sizeï¼Œtmp_table_sizeï¼Œæ‰©å¤§å‡ å€<br>ï¼ˆ3ï¼‰ç»™è¿™ä¸ªsqlçš„å”¯ä¸€çš„ä¸€ä¸ªorder byå­—æ®µåŠ ä¸ªç´¢å¼•ã€‚<br>åŒæ—¶å‚¬ä¿ƒç ”å‘æä¾›hotfixã€‚æœ€ç»ˆé€‰æ‹©äº†æœ€ç®€å•æœ‰æ•ˆçš„ï¼ˆ1ï¼‰é—®é¢˜è§£å†³ï¼Œç ”å‘è¿…é€Ÿåé¢ä¹Ÿå‘äº†hotfixè§£å†³äº†ã€‚<br><br>4. æŸä¸ªæ¶ˆè´¹é«˜å³°æ—¶é—´æ®µï¼Œé«˜é¢‘æŸ¥è¯¢è¢«è§¦å‘ï¼Œä¸€å¤©å‡ åä¸‡æ¬¡æ‰§è¡Œï¼Œç”±äºå­˜é‡æ•°æ®è¶Šæ¥è¶Šå¤šï¼ŒæŸ¥è¯¢æ€§èƒ½è¶Šæ¥è¶Šæ…¢ï¼Œä¸»è¦æ˜¯ç´¢å¼•æ²¡æœ‰å¾ˆå¥½è§„åˆ’ï¼Œå¯¼è‡´CPUèµ„æºä½¿ç”¨é£™å‡ï¼Œåé¢çš„sqlæ‰§è¡Œè¶Šæ¥è¶Šæ…¢ã€‚ æœ€åå°è¯•äº†ç»™2ä¸ªå­—æ®µæ·»åŠ å•ç‹¬çš„ç´¢å¼•ï¼Œè§£å†³äº†50%çš„é—®é¢˜ï¼Œçœ‹åˆ°æ‰§è¡Œè®¡åˆ’ï¼Œextraé‡Œé¢ï¼Œç´¢å¼•åˆå¹¶ä½¿ç”¨äº†intersectï¼Œæ€§èƒ½è¿˜æ˜¯æ…¢ï¼Œç„¶åç«‹é©¬dropåŸå…ˆçš„2ä¸ªå•ç‹¬ç´¢å¼•ï¼Œåˆ›å»ºä¸¤ä¸ªå­—æ®µçš„è”åˆç´¢å¼•ï¼Œé—®é¢˜è§£å†³äº†ã€‚<br><br>5. æ­»é”å›æ»šï¼Œå¯¼è‡´çš„MySQL hangä½äº†ï¼Œå½“æ—¶åˆšå…¥é—¨ï¼Œåªèƒ½ç®€å•å¤ç°æ­»é”ï¼Œæ²¡æœ‰ä¿ç•™æ‰€æœ‰çš„æ—¥å¿—ï¼Œç°åœ¨æƒ³æŸ¥ä¹ŸæŸ¥ä¸äº†äº†ã€‚ã€‚ã€‚<br>æ„Ÿè§‰å¤§éƒ¨åˆ†éƒ½æ˜¯æ…¢sqlå’Œé«˜é¢‘äº‹åŠ¡å¯¼è‡´çš„ã€‚<br><br>ï¼ˆå½“ç„¶åé¢çš„æ…¢sqlç›‘æ§åˆ†æï¼Œé¡¹ç›®ä¸Šå°±å¾ˆé‡è§†äº†ã€‚ã€‚ï¼‰<br><br><br>ä»Šå¤©çœ‹äº†è¿™æœŸä¸“æ ï¼Œå‘ç°5.7çš„è¿™ä¸ªåŠŸèƒ½ï¼Œquery_rewriteï¼Œå—æ•™äº†ã€‚ç­‰æˆ‘ä»¬å‡åˆ°5.7ä»¥åï¼Œå¯ä»¥å®é™…æ“ç»ƒä¸‹ã€‚ä¸Šé¢çš„é—®é¢˜3ï¼Œä¹Ÿå¯ä»¥ç”¨è¿™ä¸ªåŠŸèƒ½äº†ï¼ˆå› ä¸ºæ˜¯æ–°ä¸šåŠ¡ï¼Œæ–°è¡¨ï¼Œç‰¹æ®Šsqlï¼Œå®Œå…¨å¯ä»¥èµ·åˆ°hotfixçš„ä½œç”¨ï¼‰ã€‚<br><br><br>è¯·è€å¸ˆå¸®å¿™çœ‹ä¸‹ä¸Šé¢å‡ æ¬¡æ•…éšœæ˜¯å¦æœ‰æ›´å¥½ï¼Œæ›´ä¸“ä¸šçš„è§£å†³æ–¹æ¡ˆã€‚å¤šè°¢ <br></div>
                            <span class="time">2019-01-02 03:08</span>
                            
                            <div class="reply">
                                <div class="reply-hd"><span>ä½œè€…å›å¤</span></div>
                                <p class="reply-content">1. Kill æ‰å¤‡ä»½çº¿ç¨‹åœ¨å½“æ—¶æ˜¯æœ€å¥½çš„åŠæ³•äº†ã€‚ä¸è¿‡æˆ‘ä¹‹å‰ç¡®å®ä¹Ÿæ²¡ç¢°åˆ°è¿‡show create table ä¸èƒ½killçš„æƒ…å†µï¼Œæˆ‘çœ‹ä¸‹ä»£ç ï¼Œå¦‚æœèƒ½å¤ç°å‡ºæ¥åŠ å…¥é‚£ç¯‡æ–‡ç« ä¸­<br>2. å—¯ï¼Œ80060è¿™ä¸ªé—®é¢˜æ˜¯å› ä¸ºè¦truncateï¼Œæ‰€ä»¥è¦å›æ”¶è„é¡µå¯¼è‡´æ…¢ï¼Œä¸è¿‡è¿™ä¸ªé—®é¢˜åœ¨5.5.23å°±ä¼˜åŒ–æ‰äº†å“¦ï¼Œçœ‹ä½ ä½¿ç”¨çš„æ˜¯5.6ï¼Œå¯èƒ½æ˜¯åˆ«çš„åŸå› ã€‚truncateå¦‚æœä¸æ˜¯è¢«é”ï¼Œè€Œæ˜¯å·²ç»åœ¨æ‰§è¡Œäº†ï¼Œç¡®å®è¿˜æ˜¯åˆ«åšåˆ«çš„äº‹æƒ…ï¼Œç­‰ç»“æŸæœ€å¥½ï¼›<br>3. è¿™ä¸ªè¯­å¥æ˜¯å› ä¸ºå­æŸ¥è¯¢è¦ç”¨ä¸´æ—¶è¡¨ï¼Œè·Ÿorder by æ— å…³çš„ï¼ˆä½ çœ‹åˆ°çš„é˜¶æ®µè¿˜æ²¡å¼€å§‹order by æ“ä½œï¼‰ã€‚è¿™ä¸ªè¯­å¥çš„ä¸´æ—¶è¡¨éƒ½èƒ½å¤šåˆ°æŠŠç£ç›˜æ‰“æ»¡ï¼Œå¢åŠ tmp_table_sizeæ˜¯æ²¡ç”¨çš„ã€‚<br>å°±æ˜¯è¯´è¿™ä¸‰ä¸ªæ–¹æ³•é‡Œé¢2å’Œ3å…¶å®éƒ½æ— æ•ˆã€‚ä½ ä»¬å½“æ—¶çš„é€‰æ‹©å¾ˆç²¾å‡†å‘€ã€‚<br>è€Œä¸”å‰é¢æå‡ºâ€œé‡å¯æ— æ•ˆâ€çš„è¿™ä¸ªäººå€¼å¾—å›¢é˜Ÿå†…å¤§åŠ›è¡¨æ‰¬ï¼ˆæ˜¯ä¸æ˜¯å°±æ˜¯ä½ ğŸ˜„ï¼‰<br>å¦å¤–è¿™ä¸ªè¯­å¥ï¼Œçœ‹ç€åƒæœ‰æœºä¼šä¼˜åŒ–çš„æ ·å­ï¼Œæ ¸å¿ƒæ–¹å‘æ˜¯å»æ‰ä¸´æ—¶è¡¨<br>4.å¯ä»¥åªåˆ æ‰å…¶ä¸­ä¸€ä¸ªç‹¬ç«‹ç´¢å¼•ï¼Œå†åŠ ä¸€ä¸ªè”åˆç´¢å¼•ï¼Œå°±æ˜¯å˜æˆ(a,b)å’Œ(b)è¿™ä¸¤ç§ç´¢å¼•ï¼Œä¹Ÿå°±æ˜¯æŠŠ(a)æ”¹æˆ(a,b)ï¼Œè¿™æ ·æ˜¯åŠ æ³•ï¼Œç›¸å¯¹æ¯”è¾ƒå®‰å…¨ã€‚åˆ é™¤ç´¢å¼•æ˜¯ä¸€ä¸ªè¦å¾ˆå°å¿ƒçš„æ“ä½œï¼Œå°‘åˆ ä¸€ä¸ªå¤šä¸€ä»½å®‰å…¨ï¼Œä¹‹åå†é€šè¿‡è§‚å¯Ÿç´¢å¼•bçš„ä½¿ç”¨æƒ…å†µï¼Œç¡®å®šæ²¡å¿…è¦å†åˆ ã€‚intersetç¡®å®ä¸€èˆ¬éƒ½æ¯”è¾ƒæ…¢ã€‚<br>5. æ­£å¸¸å›æ»šå¾ˆå¿«çš„ï¼Œæ˜¯ä¸æ˜¯å¤§äº‹åŠ¡å›æ»šï¼Ÿè¿™ç§è¿˜æ˜¯å¾—ä»æ¶ˆé™¤å¤§äº‹åŠ¡å…¥æ‰‹<br><br></p>
                                <p class="reply-time">2019-01-02 09:35</p>
                            </div>
                            
                        </div>
                    </li>
                    
                    <li data-v-87ffcada="" class="comment-item"><img
                            src="https://static001.geekbang.org/account/avatar/00/13/f8/70/f3a33a14.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">æŸã€äºº</span>
                            </div>
                            <div class="bd">è€å¸ˆ,æˆ‘æœ‰å‡ ä¸ªé—®é¢˜:<br>1.å¦‚æœæŠŠorder byå»æ‰æˆ–è€…order by c asc,å¾€å³æ‰«æ,ä¸ºä»€ä¹ˆæ²¡æœ‰åŠ [25,30)next-key lock?<br>2.æ‰§è¡Œsession A,ä¸ºä»€ä¹ˆslow logé‡Œçš„Rows_examinedä¸º2?æŒ‰ç…§ç­”æ¡ˆæ¥è®²ä¸åº”è¯¥æ˜¯ä¸º3å˜›<br>3.thread statesé‡Œsending dataåŒ…æ‹¬sending data to the client,<br>å¦å¤–è¿˜æœ‰ä¸€ç§stateæ˜¯Sending to client(5.7.8ä¹‹å‰å«Writing to net)æ˜¯writing a packet to the client.<br>è¯·é—®é’ˆå¯¹å‘é€æ•°æ®ç»™å®¢æˆ·ç«¯,è¿™ä¸¤ç§çŠ¶æ€æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ <br></div>
                            <span class="time">2019-01-02 16:50</span>
                            
                            <div class="reply">
                                <div class="reply-hd"><span>ä½œè€…å›å¤</span></div>
                                <p class="reply-content">1. Next-key lockæ˜¯å‰å¼€åé—­åŒºé—´å‘€ï¼Œæœ‰æ‰«æåˆ°25ï¼Œæ‰€ä»¥(20,25]<br><br>2. Rows_examined æ˜¯serverå±‚ç»Ÿè®¡çš„ï¼Œè¿™ä¸ªä¸æ»¡è¶³çš„å€¼æ²¡è¿”å›ç»™server<br><br>3. ä½ show processlist ç»“æœå‘æˆ‘çœ‹ä¸‹ï¼Œä»£ç ä¸­æ²¡æœåˆ°ğŸ˜“</p>
                                <p class="reply-time">2019-01-02 23:20</p>
                            </div>
                            
                        </div>
                    </li>
                    
                    <li data-v-87ffcada="" class="comment-item"><img
                            src="https://static001.geekbang.org/account/avatar/00/0f/48/bd/6c7d4230.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">Tony Du</span>
                            </div>
                            <div class="bd">å¯¹äºä¸ŠæœŸé—®é¢˜çš„è§£ç­”ï¼Œæœ‰ä¸€ç‚¹ä¸æ˜¯ç‰¹åˆ«ç†è§£ï¼Œ<br>å› ä¸ºorder by descï¼Œåœ¨ç´¢å¼•cä¸Šå‘å·¦éå†ï¼Œå¯¹äºï¼ˆ15ï¼Œ 25ï¼‰è¿™æ®µåŒºé—´æ²¡æœ‰é—®é¢˜ï¼Œ<br>ç„¶åï¼Œæ‰«æåˆ°c=10æ‰åœä¸‹æ¥ï¼Œç†è®ºä¸ŠæŠŠï¼ˆ10ï¼Œ15]è¿™ä¸ªåŒºé—´é”ä¸Šå°±åº”è¯¥æ˜¯å®Œå¤‡çš„äº†å‘€ã€‚ï¼ˆ5ï¼Œ10]è¿™æ®µåŒºé—´æ˜¯å¦é”ä¸Šå¯¹ç»“æœåº”è¯¥æ²¡æœ‰å½±å“å‘€ï¼Œä¸ºä»€ä¹ˆä¼šéœ€è¦ï¼ˆ5ï¼Œ10] è¿™æ®µçš„next-key lock ?<br> <br></div>
                            <span class="time">2019-01-02 16:00</span>
                            
                            <div class="reply">
                                <div class="reply-hd"><span>ä½œè€…å›å¤</span></div>
                                <p class="reply-content">å°±æ˜¯è¿™ä¹ˆå®ç°çš„ğŸ˜“<br><br>C=10è¿˜æ˜¯è¦é”çš„ï¼Œå¦‚æœä¸é”å¯èƒ½è¢«åˆ é™¤</p>
                                <p class="reply-time">2019-01-02 17:29</p>
                            </div>
                            
                        </div>
                    </li>
                    
                    <li data-v-87ffcada="" class="comment-item"><img
                            src="https://static001.geekbang.org/account/avatar/00/0f/48/bd/6c7d4230.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">Tony Du</span>
                            </div>
                            <div class="bd">å¯¹äºä¸ŠæœŸé—®é¢˜çš„è§£ç­”ï¼Œæœ‰ä¸€ç‚¹ä¸æ˜¯ç‰¹åˆ«ç†è§£ï¼Œ<br>å› ä¸ºorder by descï¼Œåœ¨ç´¢å¼•cä¸Šå‘å·¦éå†ï¼Œå¯¹äºï¼ˆ15ï¼Œ 25ï¼‰è¿™æ®µåŒºé—´æ²¡æœ‰é—®é¢˜ï¼Œ<br>ç„¶åï¼Œæ‰«æåˆ°c=10æ‰åœä¸‹æ¥ï¼Œç†è®ºä¸ŠæŠŠï¼ˆ10ï¼Œ15]è¿™ä¸ªåŒºé—´é”ä¸Šå°±åº”è¯¥æ˜¯å®Œå¤‡çš„äº†å‘€ã€‚ï¼ˆ5ï¼Œ10]è¿™æ®µåŒºé—´æ˜¯å¦é”ä¸Šå¯¹ç»“æœåº”è¯¥æ²¡æœ‰å½±å“å‘€ï¼Œä¸ºä»€ä¹ˆä¼šéœ€è¦ï¼ˆ5ï¼Œ10] è¿™æ®µçš„next-key lock ?<br>2019-01-02<br>î˜ˆ ä½œè€…å›å¤<br>å°±æ˜¯è¿™ä¹ˆå®ç°çš„ğŸ˜“<br><br>C=10è¿˜æ˜¯è¦é”çš„ï¼Œå¦‚æœä¸é”å¯èƒ½è¢«åˆ é™¤<br><br>æˆ‘çš„å›å¤ï¼š<br>æ‰€ä»¥ï¼Œå¦‚æœæŠŠsqlæ”¹æˆ<br>select * from t where c&gt;=15 and c&lt;=20 order by c asc lock in share mode;<br>é‚£é”çš„èŒƒå›´å°±åº”è¯¥æ˜¯ç´¢å¼•cä¸Šï¼ˆ10ï¼Œ25ï¼‰äº†å§ã€‚<br>åŒæ ·æŸ¥è¯¢æ¡ä»¶ï¼Œä¸åŒçš„orderé¡ºåºï¼Œé”çš„èŒƒå›´ä¸ä¸€æ ·ï¼Œç¨å¾®æ„Ÿè§‰æœ‰ä¸€ç‚¹å¥‡æ€ª...<br> <br></div>
                            <span class="time">2019-01-03 09:51</span>
                            
                            <div class="reply">
                                <div class="reply-hd"><span>ä½œè€…å›å¤</span></div>
                                <p class="reply-content">å—¯ï¼Œå› ä¸ºæ‰§è¡Œç´¢å¼•éå†çš„é¡ºåºä¸ä¸€æ ·ï¼Œå…¶å®é”èŒƒå›´ä¸ä¸€æ ·ä¹Ÿç®—åˆç†å•¦ğŸ˜„</p>
                                <p class="reply-time">2019-01-03 10:13</p>
                            </div>
                            
                        </div>
                    </li>
                    
                    <li data-v-87ffcada="" class="comment-item"><img
                            src="https://static001.geekbang.org/account/avatar/00/14/20/3a/90db6a24.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">Long</span>
                            </div>
                            <div class="bd">è€å¸ˆå¥½ï¼Œçœ‹åˆ°æœ‰çš„åŒå­¦åœ¨è®¨è®ºé”çš„é‡Šæ”¾é—®é¢˜ã€‚<br><br>ä¹‹å‰åˆ†æè¿‡ä¸€ä¸ªé”è¡¨å¼‚å¸¸ï¼Œå¾ˆå¤šç”¨workbenchæˆ–è€…ç±»ä¼¼å®¢æˆ·ç«¯çš„åŒå­¦å¯èƒ½ä¼šé‡åˆ°ï¼Œ<br>å¤ç°æ–¹å¼ï¼š<br>Step 1ï¼šæ˜¾ç¤ºçš„æ‰“å¼€ä¸€ä¸ªäº‹åŠ¡ï¼Œæˆ–è€…æŠŠautocommit=0ï¼Œæˆ–è€…mysql workbenchä¸­æŠŠè‡ªåŠ¨æäº¤çš„ç½®ç°æŒ‰é’®æ‰“å¼€ä»¥å<br>Step 2: æ‰§è¡Œä¸€ä¸ªsqlï¼ˆæ¯”å¦‚ï¼Œupdateæˆ–è€…deleteä¹‹ç±»çš„ï¼‰ï¼Œç„¶åsqlè¿˜æ²¡æœ‰è¿”å›æ‰§è¡Œç»“æœçš„ä¸­é€”ç‚¹å‡»workbench è‡ªå¸¦çš„é‚£ä¸ªstopçš„çº¢è‰²çš„æŒ‰é’®ã€‚<br>è¿™ä¸ªæ—¶å€™å¾ˆå¤šäººå¯èƒ½å°±ä¸å†åšå…¶ä»–æ“ä½œï¼Œå¤§å¤šä¼šè®¤ä¸ºæ‰§è¡Œå·²ç»ç»“æŸäº†ã€‚ä½†æ˜¯å®é™…ä¸Šï¼Œé”è¿˜åœ¨ç»§ç»­é”ç€çš„å¹¶ä¸ä¼šé‡Šæ”¾ã€‚<br><br>ç³»ç»Ÿæ—¥å¿—è®°å½•ï¼š<br>ï¼ˆ1ï¼‰processlistçš„çŠ¶æ€æ˜¯sleepï¼Œinfoä¸ºnull<br>ï¼ˆ2ï¼‰innodb_trxçš„çŠ¶æ€æ˜¯runningï¼Œtrx_queryä¸ºnull<br>ï¼ˆ3ï¼‰performance_schema.events_statements_currentè¡¨ä¸­çš„ï¼Œ<br>sql_textï¼Œdigest_textï¼šæ˜¯æœ‰æ­£ç¡®çš„sqlçš„ã€‚---è¿™ä¸ª5.6ä»¥åå°±æœ‰äº†ï¼Œå¦‚æœpsæ‰“å¼€çš„è¯ï¼Œåº”è¯¥æ˜¯å¯ä»¥çœ‹åˆ°çš„ã€‚<br>message_text ï¼šQuery execution was interrupted<br>ï¼ˆ4ï¼‰inoodb_locksï¼Œlock_waitsï¼Œä»¥åŠshow engine innodb statusï¼Œåªæœ‰å‡ºç°é”ç­‰å¾…çš„æ—¶å€™æ‰ä¼šè®°å½•ï¼Œå¦‚æœåªæœ‰ä¸€ä¸ªäº‹åŠ¡çš„è®°å½•è¡Œé”ï¼Œæˆ–è€…è¡¨é”ï¼Œæ˜¯ä¸ä¼šè®°å½•çš„ã€‚ï¼ˆä¸çŸ¥é“æ˜¯å¦æœ‰å‚è€ƒæ§åˆ¶ï¼Œè¿˜æ˜¯é»˜è®¤çš„ï¼‰<br>ï¼ˆ5ï¼‰å…³äºè¡Œé”è®°å½•æ•°çš„é—®é¢˜ï¼Œä»æµ‹è¯•çš„ç»“æœçœ‹ï¼Œinoodb_trxçš„locked rowsï¼Œå½“æˆ‘ç‚¹åœæ­¢çš„æ—¶å€™ï¼Œé”å®šè¡Œæ•°ä¿æŒä¸å˜äº†ï¼Œå½“æˆ‘ç»§ç»­ç‚¹å‡»æ‰§è¡Œçš„æ—¶å€™ï¼Œé”å®šè®°å½•è¡Œæ•°ä¼šåœ¨ä¹‹å‰çš„è®°å½•ä¸Šå‘ä¸Šç´¯åŠ ï¼Œå¹¶ä¸æ˜¯ä»0å¼€å§‹ã€‚<br><br>ç„¶åæŸ¥äº†audit logä»¥åå‘ç°ï¼Œå®¢æˆ·ç«¯ï¼ˆmysqlworkbenchï¼‰é€ç»™serverç«¯çš„æ˜¯KILL QUERY thread_idï¼Œè€Œä¸æ˜¯Kill thread_idï¼Œ<br>æ‰€ä»¥MySQLåªæ˜¯ç»ˆæ­¢äº†äº‹åŠ¡ä¸­çš„statementæ‰§è¡Œï¼Œä½†æ˜¯å¹¶ä¸ä¼šé‡Šæ”¾é”ï¼Œå› ä¸ºç›®å‰çš„ççš„è·å–å’Œé‡Šæ”¾éƒ½æ˜¯åŸºäºäº‹åŠ¡ç»“æŸçš„ï¼ˆæäº¤æˆ–è€…å›æ»šï¼‰ã€‚<br>è¿™é‡Œé¢å…³äºkill query&#47; thread_idçš„åŒºåˆ«è§£é‡Š<br>https:&#47;&#47;dev.mysql.com&#47;doc&#47;refman&#47;5.6&#47;en&#47;kill.html<br><br>è§£å†³æ–¹æ³•ï¼š<br>è‡ªå·±è§£å†³ï¼škill å¯¹åº”çš„thread_idï¼Œæˆ–è€…å…³é—­æ‰§è¡Œçª—å£ï¼ˆè¿™ä¸ªæ—¶å€™ä¼šé€ä¸ªquitç»™serverç«¯ï¼‰ã€‚<br>åˆ«äººè§£å†³ï¼šæœ‰superæƒé™çš„äººkill thread_idã€‚<br><br>å…³äºkillçš„é‚£ä¸ªæ–‡ç« ï¼Œå…¶å®å¯¹æ‰€æœ‰DDLï¼ŒDMLçš„æ“ä½œé‡Šæ”¾è¿‡ç¨‹ï¼Œè¿˜æ²¡æœ‰å…¨éƒ¨ææ¸…æ¥šï¼ŒæœŸå¾…è€å¸ˆçš„ç¬¬25è®²ã€‚ <br></div>
                            <span class="time">2019-01-02 22:36</span>
                            
                            <div class="reply">
                                <div class="reply-hd"><span>ä½œè€…å›å¤</span></div>
                                <p class="reply-content">æ€»ç»“çš„éå¸¸å¥½ï¼Œè€Œä¸”ç°è±¡å¾ˆå…¨é¢ã€‚<br>æ ¸å¿ƒçš„ä¸€ä¸ªç‚¹æ˜¯ï¼škill query åªæ˜¯ç»ˆæ­¢å½“å‰æ‰§è¡Œè¯­å¥ï¼Œå¹¶ä¸ä¼šè®©äº‹åŠ¡å›æ»šğŸ‘ğŸ¿</p>
                                <p class="reply-time">2019-01-03 10:16</p>
                            </div>
                            
                        </div>
                    </li>
                    
                    <li data-v-87ffcada="" class="comment-item"><img
                            src="https://static001.geekbang.org/account/avatar/00/13/e9/5a/a6f2ec4b.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">æ›¾å‰‘</span>
                            </div>
                            <div class="bd">è€å¸ˆï¼Œå…³äºä¸ŠæœŸé—ç•™é—®é¢˜çš„è§£ç­”ï¼Œæˆ‘æœ‰ä¸€ç‚¹ç–‘æƒ‘ï¼š<br>è§£ç­”ä¸­çš„1ä¸­ï¼Œç¬¬ä¸€ä¸ªè¦å®šä½çš„æ˜¯ç´¢å¼• c ä¸Šâ€œæœ€å³è¾¹çš„â€c=20 çš„è¡Œï¼Œä¸ºå•¥åªä¼šåŠ ä¸Šé—´éš™é”ï¼ˆ20,25ï¼‰å’Œnext-key lock(15,20]å‘¢ï¼Œä¸ºå•¥ä¸æ˜¯ä¸¤ä¸ªnext-key lock(15,20]å’Œ(20,25]å‘¢ï¼Ÿ25ä¸Šçš„è¡Œé”éš¾é“æ˜¯é€€åŒ–çš„ï¼Ÿè€å¸ˆä¸Šä¸€ç¯‡æ–‡ç« ä¸­è¯´åˆ°åŠ é”çš„åŸºæœ¬åŸåˆ™ä¸­ç¬¬ä¸€ç‚¹æ˜¯åŠ é”çš„åŸºæœ¬å•ä½æ˜¯next-key lockï¼Œè€Œé€€åŒ–éƒ½æ˜¯åŸºäºç´¢å¼•ä¸Šçš„ç­‰å€¼æŸ¥è¯¢æ‰ä¼šå‘ç”Ÿå‘€ï¼Ÿç›¼è€å¸ˆæŒ‡ç‚¹è¿·æ´¥ã€‚<br> <br></div>
                            <span class="time">2019-01-02 14:13</span>
                            
                            <div class="reply">
                                <div class="reply-hd"><span>ä½œè€…å›å¤</span></div>
                                <p class="reply-content">å°±æ˜¯ä¼˜åŒ–2ï¼Œæ‰¾ç¬¬ä¸€ä¸ªå€¼çš„æ—¶å€™æ˜¯ç­‰å€¼æŸ¥è¯¢</p>
                                <p class="reply-time">2019-01-02 14:50</p>
                            </div>
                            
                        </div>
                    </li>
                    
                    <li data-v-87ffcada="" class="comment-item"><img
                            src="https://static001.geekbang.org/account/avatar/00/12/da/ec/779c1a78.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">å¾€äº‹éšé£ï¼Œé¡ºå…¶è‡ªç„¶</span>
                            </div>
                            <div class="bd">ä¸ºä»€ä¹ˆæˆ‘çš„ç”µè„‘ä¸Šæ²¡æœ‰æ…¢æŸ¥è¯¢çš„æ—¥å¿—æ–‡ä»¶ï¼Œmysql5.7<br>ysql&gt; show VARIABLES like &#39;%slow%&#39;;<br>+---------------------------+--------------------------+<br>| Variable_name             | Value                    |<br>+---------------------------+--------------------------+<br>| log_slow_admin_statements | OFF                      |<br>| log_slow_slave_statements | OFF                      |<br>| slow_launch_time          | 2                        |<br>| slow_query_log            | ON                       |<br>| slow_query_log_file       | DESKTOP-76FNKS3-slow.log |<br>+---------------------------+--------------------------+<br><br>DESKTOP-76FNKS3-slow.log è¿™ä¸ªæ–‡ä»¶å†æœ¬åœ°ç£ç›˜æ‰¾ä¸åˆ° <br></div>
                            <span class="time">2019-01-04 20:35</span>
                            
                            <div class="reply">
                                <div class="reply-hd"><span>ä½œè€…å›å¤</span></div>
                                <p class="reply-content">Show variables like â€œoutputâ€</p>
                                <p class="reply-time">2019-01-04 21:40</p>
                            </div>
                            
                        </div>
                    </li>
                    
                    <li data-v-87ffcada="" class="comment-item"><img
                            src="https://static001.geekbang.org/account/avatar/00/12/da/ec/779c1a78.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">å¾€äº‹éšé£ï¼Œé¡ºå…¶è‡ªç„¶</span>
                            </div>
                            <div class="bd">mysql5.7ä¸ºä»€ä¹ˆä¸å­˜åœ¨ä¸‹é¢çš„æ•°æ®åº“å’Œè¡¨ <br>mysql&gt; use query_rewrite;<br>ERROR 1049 (42000): Unknown database &#39;query_rewrite&#39;<br>mysql&gt;<br> <br></div>
                            <span class="time">2019-01-04 20:20</span>
                            
                            <div class="reply">
                                <div class="reply-hd"><span>ä½œè€…å›å¤</span></div>
                                <p class="reply-content">æœä¸€ä¸‹ç”¨æ³•å§ğŸ˜„</p>
                                <p class="reply-time">2019-01-04 21:29</p>
                            </div>
                            
                        </div>
                    </li>
                    
                    <li data-v-87ffcada="" class="comment-item"><img
                            src="" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">å •è½å¤©ä½¿</span>
                            </div>
                            <div class="bd">è€å¸ˆï¼Œæ‚¨å¥½ï¼š<br>æˆ‘å¼•ç”¨ä¸€ä¸‹ Ryoma çš„ç•™è¨€ï¼Œå¦‚ä¸‹ï¼š<br>Ryoma<br>æˆ‘ä¹‹å‰çš„æè¿°æœ‰ç‚¹é—®é¢˜ï¼Œå…¶å®æƒ³é—®çš„æ˜¯ï¼šä¸ºä»€ä¹ˆåŠ äº† order by c descï¼Œç¬¬ä¸€ä¸ªå®šä½c=20 çš„è¡Œï¼Œä¼šåŠ ä¸Šé—´éš™é” (20,25) å’Œ next-key lock (15,20]ï¼Ÿ<br>å¦‚æœæ²¡æœ‰order by c descï¼Œç¬¬ä¸€æ¬¡å‘½ä¸­c=15æ—¶ï¼Œåªä¼šåŠ ä¸Šnext-key lock(10.15]ï¼›<br>è€Œæœ‰äº†order by c descï¼Œæˆ‘çš„ç†è§£æ˜¯ç¬¬ä¸€æ¬¡å‘½ä¸­c=20åªéœ€è¦åŠ ä¸Šnext-key lock (15,20]<br>å½“ç„¶æœ€å(20,25)è¿˜æ˜¯åŠ ä¸Šäº†é”ï¼Œè€å¸ˆçš„ç»“è®ºæ˜¯å¯¹çš„ï¼Œæˆ‘ä¹Ÿæµ‹è¯•è¿‡äº†ï¼Œä½†æ˜¯æˆ‘ä¸çŸ¥é“å¦‚ä½•è§£é‡Šã€‚<br>å”¯ä¸€èƒ½æƒ³åˆ°çš„è§£é‡Šæ˜¯order by c desc å¹¶ä¸ä¼šæ”¹å˜ä¼˜åŒ–2è¿™ä¸ªåŸåˆ™ï¼šå³ç­‰å€¼æŸ¥è¯¢æ—¶ï¼Œä¼šå‘å³éå†ä¸”æœ€åä¸€ä¸ªå€¼ä¸æ»¡è¶³ç­‰å€¼æ¡ä»¶ï¼›åŒæ—¶order by c desc å¸¦æ¥ä¸€ä¸ªç±»ä¼¼äºä¼˜åŒ–2çš„å‘å·¦éå†åŸåˆ™ã€‚<br>è¿›è€Œå¯¼è‡´æœ€åçš„é”èŒƒå›´æ˜¯(5,25)ï¼›è€Œæ²¡æœ‰order by c descçš„èŒƒå›´æ˜¯(10,25]ã€‚<br>2019-01-03<br>î˜ˆ ä½œè€…å›å¤<br>å› ä¸ºæ‰§è¡Œc=20çš„æ—¶å€™ï¼Œç”±äºè¦order by c desc, å°±è¦å…ˆæ‰¾åˆ°â€œæœ€å³è¾¹ç¬¬ä¸€ä¸ªc=20çš„è¡Œâ€ï¼Œ<br>è¿™ä¸ªæ€ä¹ˆæ‰¾å‘¢ï¼Œåªèƒ½å‘å³æ‰¾åˆ°25ï¼Œæ‰èƒ½çŸ¥é“å®ƒå·¦è¾¹é‚£ä¸ª20æ˜¯â€œæœ€å³çš„20â€<br><br>æˆ‘çš„é—®é¢˜æ˜¯ï¼š<br>1. æŒ‰ç…§è€å¸ˆæ‚¨è¯´çš„ï¼Œå…ˆæ‰¾c=20ï¼Œç”±äºæ˜¯order by c descï¼Œæ‰€ä»¥è¦æ‰¾æœ€å³è¾¹çš„20ï¼Œå³æ‰¾åˆ°25ã€‚é‚£å¦‚æœcæ˜¯å”¯ä¸€ç´¢å¼•å‘¢ï¼Ÿæ˜¯ä¸æ˜¯å°±ä¸ä¼šæ‰¾åˆ°25äº†ï¼ˆæ˜¯å¦ä¼šåŠ  (20,25) çš„gap lockï¼‰ï¼Ÿæˆ‘æŠŠè¯­å¥æ”¹é€ äº†ä¸€ä¸‹ï¼Œâ€œselect * from t_20 where id &gt;= 15 and id&lt;=20 ORDER BY id desc lock in share mode;â€ã€‚å‘ç°å½“ session A æ‰§è¡Œå®Œè¿™è¡Œè¯­å¥ä¸æäº¤çš„æ—¶å€™ï¼Œsession B æ‰§è¡Œ â€œinsert into t_20 values(24,24,24);â€ æ˜¯é˜»å¡çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ä¹ŸåŠ äº†(20,25)çš„é—´éš™é”ã€‚è¿™åˆæ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ<br>2. é—´éš™é”æœ¬èº«ä¸å†²çªï¼Œä½†å’Œæ’å…¥è¯­å¥å†²çªã€‚é‚£ä¹ˆdeleteè¯­å¥å‘¢?<br>æˆ‘åšäº†ä¸ªå¦‚ä¸‹å®éªŒï¼ˆä»¥ä¸‹è¯­å¥æŒ‰æ—¶é—´é¡ºåºæ’åºï¼‰ï¼š<br>session A<br>begin;<br>select * from t_20 where c=10 lock in share mode;<br><br>session B<br>delete from t_20 where c=15;<br>insert into t_20 values(16,16,16); <br>(blocked)<br><br>session B ä¸­ç¬¬ä¸€æ¡deleteè¯­å¥æ‰§è¡Œæ­£å¸¸ï¼Œç¬¬äºŒæ¡insertè¯­å¥è¢«é˜»å¡ã€‚<br>æˆ‘çš„åˆ†ææ˜¯ï¼šsession Aåœ¨ç´¢å¼•cä¸Šçš„é”æ˜¯ï¼š(5,10]  (10,15)ï¼›å½“session BæŠŠ(15,15,15)è¿™æ¡è®°å½•åˆ äº†ä¹‹åï¼Œ(10,15)çš„é—´éš™å°±ä¸å­˜åœ¨äº†ï¼Œæ‰€ä»¥æ­¤æ—¶session Aåœ¨ç´¢å¼•cä¸Šçš„é”å˜ä¸ºï¼š(5,10]  (10,20)ã€‚è¿™æ—¶å†åœ¨session Bä¸­æ’å…¥(16,16,16)å°±è¢«é˜»å¡äº†ã€‚è¿™ä¸ªåˆ†ææ­£ç¡®å—ï¼Ÿ <br></div>
                            <span class="time">2019-01-04 19:17</span>
                            
                            <div class="reply">
                                <div class="reply-hd"><span>ä½œè€…å›å¤</span></div>
                                <p class="reply-content">å¯¹ï¼Œæˆ‘åœ¨ç¬¬30ç¯‡ä¼šè¯´åˆ°è¿™ä¸ªé—®é¢˜å“ˆ</p>
                                <p class="reply-time">2019-01-10 16:10</p>
                            </div>
                            
                        </div>
                    </li>
                    
                    <li data-v-87ffcada="" class="comment-item"><img
                            src="https://static001.geekbang.org/account/avatar/00/11/68/d7/714c3d89.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">ä¸äºŒ</span>
                            </div>
                            <div class="bd">è€å¸ˆï¼Œæ›¾å‰‘åŒå­¦çš„é—®é¢˜<br>å…³äºä¸ŠæœŸé—ç•™é—®é¢˜çš„è§£ç­”ï¼Œæˆ‘æœ‰ä¸€ç‚¹ç–‘æƒ‘ï¼š<br>è§£ç­”ä¸­çš„1ä¸­ï¼Œç¬¬ä¸€ä¸ªè¦å®šä½çš„æ˜¯ç´¢å¼• c ä¸Šâ€œæœ€å³è¾¹çš„â€c=20 çš„è¡Œï¼Œä¸ºå•¥åªä¼šåŠ ä¸Šé—´éš™é”ï¼ˆ20,25ï¼‰å’Œnext-key lock(15,20]å‘¢ï¼Œä¸ºå•¥ä¸æ˜¯ä¸¤ä¸ªnext-key lock(15,20]å’Œ(20,25]å‘¢ï¼Ÿ25ä¸Šçš„è¡Œé”éš¾é“æ˜¯é€€åŒ–çš„ï¼Ÿè€å¸ˆä¸Šä¸€ç¯‡æ–‡ç« ä¸­è¯´åˆ°åŠ é”çš„åŸºæœ¬åŸåˆ™ä¸­ç¬¬ä¸€ç‚¹æ˜¯åŠ é”çš„åŸºæœ¬å•ä½æ˜¯next-key lockï¼Œè€Œé€€åŒ–éƒ½æ˜¯åŸºäºç´¢å¼•ä¸Šçš„ç­‰å€¼æŸ¥è¯¢æ‰ä¼šå‘ç”Ÿå‘€ï¼Ÿç›¼è€å¸ˆæŒ‡ç‚¹è¿·æ´¥ã€‚<br>æ‚¨ç»™å›ç­”æ˜¯å®šä½åˆ°c=20çš„æ—¶å€™ï¼Œæ˜¯ç­‰å€¼æŸ¥è¯¢ï¼Œæ‰€ä»¥åŠ çš„æ˜¯(20,25)çš„é—´éš™é”ï¼Œ25çš„è¡Œé”é€€åŒ–äº†ï¼Œé‚£ä¹ˆåœ¨ä¸Šä¸€æœŸä¸­çš„æ¡ˆä¾‹äº”ï¼šå”¯ä¸€ç´¢å¼•èŒƒå›´é” bugï¼Œé‚£id&lt;=15,ä¸ä¹Ÿæ˜¯å…ˆå®šä½åˆ°id=15ï¼Œç„¶åå‘å³æ‰«æï¼Œé‚£åº”è¯¥ä¹Ÿæ˜¯ç­‰å€¼æŸ¥è¯¢ï¼Œé‚£ä¹ˆåº”è¯¥åŠ çš„æ˜¯ï¼ˆ15ï¼Œ20ï¼‰é—´éš™é”ï¼Œé‚£ä¸ºå•¥ä½ è¯´çš„åŠ çš„æ˜¯ï¼ˆ15ï¼Œ20],ä¸ºå•¥è¿™ä¸ªid=20çš„è¡Œé”ä¹ŸåŠ ä¸Šäº†å‘¢ï¼Œä¸ºå•¥åŒæ ·æ˜¯èŒƒå›´æŸ¥è¯¢ï¼Œä¸€ä¸ªè¡Œé”é€€åŒ–äº†ï¼Œä¸€ä¸ªæ²¡æœ‰é€€åŒ–å‘¢ï¼Œæ±‚è€å¸ˆæŒ‡ç‚¹è¿·æ´¥<br><br> <br></div>
                            <span class="time">2019-01-04 11:41</span>
                            
                            <div class="reply">
                                <div class="reply-hd"><span>ä½œè€…å›å¤</span></div>
                                <p class="reply-content">1. ç¬¬ä¸€æ¬¡å°±æ˜¯æ‰¾c=20,è¿™ä¸ªå°±æ˜¯ä¸€æ¬¡ç­‰å€¼æŸ¥æ‰¾<br>2. æ¡ˆä¾‹5é‚£ä¸ªï¼Œç­‰å€¼æŸ¥çš„æ˜¯id=10,ç„¶åå‘å³éå†ã€‚è¿™ä¸¤ä¸ªï¼Œä¸€ä¸ªæ˜¯æœ‰order by desc,ç´¢å¼•çš„æ‰«ææ–¹å‘ä¸ä¸€æ ·ï¼Œâ€œæ‰¾ç¬¬ä¸€ä¸ªâ€çš„å€¼ä¹Ÿæ˜¯ä¸ä¸€æ ·çš„</p>
                                <p class="reply-time">2019-01-04 12:52</p>
                            </div>
                            
                        </div>
                    </li>
                    
                    <li data-v-87ffcada="" class="comment-item"><img
                            src="https://static001.geekbang.org/account/avatar/00/12/71/97/09bc55dc.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">å¼ æ°¸å¿—</span>
                            </div>
                            <div class="bd">è¯´ä¸€ä¸ªé”å…¨åº“(schema)çš„æ¡ˆä¾‹ï¼Œæ•°æ®åº“æ™šé—´å®šæ—¶ä»»åŠ¡æ‰§è¡ŒCTASæ“ä½œï¼Œç”±äºéœ€è¦æ‰§è¡Œåå‡ åˆ†é’Ÿï¼Œå¯¼è‡´ä¸¥é‡ä¼šè¯é˜»å¡ï¼Œå…¨åº“æ‰€æœ‰è¡¨ä¸Šçš„å¢åˆ æ”¹æŸ¥å…¨è¢«é˜»å¡ã€‚<br>åæ”¹ä¸ºå…ˆå»ºè¡¨å†æ’æ•°è§£å†³ã€‚ <br></div>
                            <span class="time">2019-01-04 08:28</span>
                            
                            <div class="reply">
                                <div class="reply-hd"><span>ä½œè€…å›å¤</span></div>
                                <p class="reply-content">å—¯å—¯ã€‚çœ‹æ¥ä½ ä¹Ÿæ˜¯è¶Ÿè¿‡å¥½å¤šå‘å•¦ï¼Œ<br>CTASä¸æ˜¯å¥½ç”¨æ³•ğŸ˜„<br></p>
                                <p class="reply-time">2019-01-04 09:19</p>
                            </div>
                            
                        </div>
                    </li>
                    
                    <li data-v-87ffcada="" class="comment-item"><img
                            src="https://static001.geekbang.org/account/avatar/00/12/71/97/09bc55dc.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">å¼ æ°¸å¿—</span>
                            </div>
                            <div class="bd">æˆ‘æ˜¯ä»Oracleè½¬åˆ°MySQLæ¥çš„ï¼Œå…ˆæ¥è§¦çš„Oracleå†çœ‹MySQLå°±ç»å¸¸å–œæ¬¢æ‹¿ä¸¤è€…å¯¹æ¯”ï¼ŒåŒ…æ‹¬è¡¨æ•°æ®å­˜å‚¨ç»“æ„ï¼ŒäºŒçº§ç´¢å¼•çš„å¼‚åŒï¼Œredoï¼Œbinlogï¼Œé”æœºåˆ¶ï¼Œä»¥åŠé»˜è®¤éš”ç¦»çº§åˆ«ã€‚<br>ç ”ç©¶é”åï¼Œæ ¹æ®è‡ªå·±çš„ç†è§£å¾—å‡ºä¸€ä¸ªç»“è®ºï¼ŒMySQLé»˜è®¤éš”ç¦»çº§åˆ«é€‰ä¸ºRRä¹Ÿæ˜¯æ— å¥ˆä¹‹ä¸¾ï¼<br>å› ä¸ºå½“æ—¶binlogè¿˜æ˜¯è¯­å¥æ ¼å¼ï¼Œä¸ºäº†ä¿è¯binlogäº‹åŠ¡é¡ºåºæ­£ç¡®å°±å¾—æœ‰gapå’Œnext keyé”ã€‚<br>è€Œå¯¹å¼€å‘äººå‘˜æ¥è¯´ï¼Œä»–ä»¬æœªå¿…æ¸…æ¥šäº‹åŠ¡éš”ç¦»çº§åˆ«ï¼Œä¸”å¤§å¤šæ•°å¼€å‘éƒ½æ˜¯ä»Oracleè½¬å‘MySQLçš„ï¼Œæ•…æœæ–­å°†éš”ç¦»çº§åˆ«å…¨éƒ¨è°ƒæ•´ä¸ºRCã€‚<br><br> <br></div>
                            <span class="time">2019-01-04 08:14</span>
                            
                            <div class="reply">
                                <div class="reply-hd"><span>ä½œè€…å›å¤</span></div>
                                <p class="reply-content">æ˜¯çš„ï¼Œä»¥å‰æœ‰å¾ˆå¤šoracleä¸“å®¶ï¼Œç„¶åå¤§å®¶å°±è§‰å¾—RCå¤Ÿç”¨ã€‚<br><br>ä¸è¿‡ä»–ä»¬ä¸æ˜¯â€œä»¥ä¸ºå¤Ÿç”¨â€ï¼Œä»–ä»¬æ˜¯çœŸçš„åˆ†æè¿‡ä¸šåŠ¡åœºæ™¯ï¼Œåˆ†æä¸šåŠ¡çš„ç”¨æ³•ï¼Œç¡®è®¤å¤Ÿç”¨ã€‚è¿™ç§æ˜¯å¾ˆå¥½çš„å®è·µ</p>
                                <p class="reply-time">2019-01-04 09:22</p>
                            </div>
                            
                        </div>
                    </li>
                    
                    <li data-v-87ffcada="" class="comment-item"><img
                            src="https://static001.geekbang.org/account/avatar/00/12/71/97/09bc55dc.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">å¼ æ°¸å¿—</span>
                            </div>
                            <div class="bd">åˆ†äº«ä¸€ä¸ªä¸»ä»åˆ‡æ¢æ—¶é‡åˆ°çš„é—®é¢˜ï¼Œä¸»ä»åˆ‡æ¢å‰ä¸»åº“è¦æ”¹ä¸ºåªè¯»ï¼Œè®¾ç½®åªè¯»åï¼Œshow master statuså‘ç°binlogä¸€ç›´åœ¨å˜åŒ–ï¼Œå½“æ—¶åº”ç”¨æ²¡æ–­å¼€ã€‚<br>ä¸»åº“å¹¶ä¸æ˜¯å…¶ä»–åº“çš„ä»åº“ï¼Œæ€ä¹ˆæçš„å‘¢ï¼Ÿ<br>æ£€æŸ¥ä¸šåŠ¡ç”¨æˆ·æƒé™å‘ç°æ‹¥æœ‰superæƒé™ï¼ŒæŸ¥çœ‹æˆæƒè¯­å¥åŸæ¥æ˜¯grant all on *.* to userï¼Œè¿™é‡Œè¦è¯´çš„æ˜¯*.* æƒé™å°±å¤ªå¤§äº†ï¼Œè€Œä¸”è¿™ä¸ªä¹Ÿå¾ˆå®¹æ˜“è¢«è¯¯è§£ï¼Œéœ€è¦ç‰¹åˆ«æ³¨æ„ã€‚ <br></div>
                            <span class="time">2019-01-04 08:00</span>
                            
                            <div class="reply">
                                <div class="reply-hd"><span>ä½œè€…å›å¤</span></div>
                                <p class="reply-content">å¯¹çš„ï¼Œreadonlyå¯¹superæ— æ•ˆï¼›<br>ä¸€æ–¹é¢æ˜¯å°½é‡ä¸è¦ç»™ä¸šåŠ¡super<br>ä¸€æ–¹é¢ä½ åšå®Œreadonlyè¿˜ä¼šå»ç¡®è®¤binlogæœ‰æ²¡æœ‰å˜ï¼Œè¿™ä¸ªæ„è¯†å¾ˆå¥½å“¦</p>
                                <p class="reply-time">2019-01-04 09:15</p>
                            </div>
                            
                        </div>
                    </li>
                    
                    <li data-v-87ffcada="" class="comment-item"><img
                            src="https://static001.geekbang.org/account/avatar/00/12/71/97/09bc55dc.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">å¼ æ°¸å¿—</span>
                            </div>
                            <div class="bd">å°ç³»ç»Ÿï¼Œæ˜¨å¤©ä¸€ç›´æŠ¥CPUä½¿ç”¨ç‡é«˜ï¼ŒæŠ¥è­¦é˜ˆå€¼è®¾å®šä¸ºCPUå¹³å‡ä½¿ç”¨ç‡0.8ã€‚<br>ç™»å½•çœ‹è¿›ç¨‹éƒ½åœ¨æ‰§è¡ŒåŒä¸€æ¡SQLï¼Œæ´»åŠ¨ä¼šè¯æœ‰40ä¸ªï¼Œä¸»æœºé€»è¾‘CPUåªæœ‰4ä¸ªï¼Œè¿™è´Ÿè½½èƒ½ä¸é«˜å—ï¼Ÿ<br>æ£€æŸ¥SQLï¼Œè¡¨å¾ˆå°ä¸åˆ°ä¸¤ä¸‡è¡Œï¼Œåˆ›å»ºä¸€ä¸ªå¤åˆç´¢å¼•åï¼Œè´Ÿè½½ç«‹åˆ»å°±æ¶ˆå¤±ä¸è§å•¦ğŸ˜„ <br></div>
                            <span class="time">2019-01-04 07:40</span>
                            
                            <div class="reply">
                                <div class="reply-hd"><span>ä½œè€…å›å¤</span></div>
                                <p class="reply-content">ğŸ‘ğŸ¿ ç«‹ç«¿è§å½±</p>
                                <p class="reply-time">2019-01-04 08:20</p>
                            </div>
                            
                        </div>
                    </li>
                    
                    <li data-v-87ffcada="" class="comment-item"><img
                            src="https://static001.geekbang.org/account/avatar/00/13/f8/70/f3a33a14.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">æŸã€äºº</span>
                            </div>
                            <div class="bd">ç»è¿‡è€å¸ˆè¿™ä¹ˆä¸€æé†’,åˆæƒ³èµ·äº†ä¹‹å‰è®²çš„redo logæ–‡ä»¶åœ¨åˆ‡æ¢çš„æ—¶å€™,æ˜¯è¦æŠŠè„é¡µæŒä¹…åŒ–çš„,æ‰€ä»¥redo logè¢«å¤§äº‹åŠ¡å ç”¨äº†ä¹Ÿæ²¡å…³ç³».è„é¡µæŒä¹…åŒ–åªéœ€è¦ç”¨æœ€åæ›´æ–°çš„é‚£ä¸ªredo logæ–‡ä»¶,å› ä¸ºcheckpointéšç€redo logåˆ‡æ¢å·²ç»å¾€å‰æ¨äº†ã€‚æ‰€ä»¥ä¹Ÿæ²¡æœ‰è¦æ¢å¤redo logè¿™ä¹ˆä¸€è¯´äº†ã€‚è€Œä¸”redo logæ¯”binlogè¿˜è¦å…ˆè½ç›˜,ç¡®å®binlogä¸åº”è¯¥æœ‰èƒ½åŠ›æ¢å¤redo logã€‚<br>è¿™ä¸ªå®ä¾‹æœ¬æ¥ä¹Ÿå°±æ˜¯å­˜ç›‘æ§æ•°æ®çš„,æ‰€ä»¥æ²¡æœ‰åšå¥½ç›‘æ§ã€‚(ç¯ä¸‹é»‘) <br></div>
                            <span class="time">2019-01-03 23:17</span>
                            
                            <div class="reply">
                                <div class="reply-hd"><span>ä½œè€…å›å¤</span></div>
                                <p class="reply-content">ğŸ‘ğŸ¿ çŸ¥è¯†ç‚¹åæ¥å°±æ˜¯äº’ç›¸äº¤ç»‡çš„ğŸ˜„</p>
                                <p class="reply-time">2019-01-04 00:28</p>
                            </div>
                            
                        </div>
                    </li>
                    
                    <li data-v-87ffcada="" class="comment-item"><img
                            src="https://static001.geekbang.org/account/avatar/00/13/ea/9a/02d589f9.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">æ–œé¢é•œå­ Bill</span>
                            </div>
                            <div class="bd">ä¸šåŠ¡ä¾§æŸ¥è¯¢ç‰¹åœ°è¡¨Açš„SQLå‡é€šè¿‡æ˜¾å¼åœ°å¼€å¯äº‹åŠ¡æ§åˆ¶ï¼Œå­˜åœ¨éƒ¨åˆ†çš„æ…¢SQLï¼Œé«˜å¹¶å‘çš„æŸ¥è¯¢å½±å“äº†è¡¨AæŸ¥è¯¢çš„commitæ•ˆç‡ï¼Œæ²¡æœ‰åŠæ—¶é‡Šæ”¾DMLé”ï¼Œæ­¤æ—¶ä¸šåŠ¡å‘èµ·DDLæ“ä½œï¼Œè·å–MDLå†™é”è¢«é˜»å¡ï¼Œå¯¼è‡´åç»­éœ€è¦è·å–MDLè¯»é”çš„SQLè¢«é˜»å¡ï¼Œå¿«é€Ÿå¯¼è‡´è¿™ä¸ªåº“çš„è¿æ¥æ± è¢«ç”¨å®Œï¼Œé˜»å¡äº†æ•´ä¸ªå®ä¾‹çš„æŸ¥è¯¢ï¼<br> <br></div>
                            <span class="time">2019-01-03 20:44</span>
                            
                            <div class="reply">
                                <div class="reply-hd"><span>ä½œè€…å›å¤</span></div>
                                <p class="reply-content">æ˜¯çš„ï¼Œæˆ‘è§è¿‡å¤ªå¤šè¿™ç§æ‚²å‰§äº†ğŸ˜“<br>è¿˜æ˜¯å¾—è®©åšDDLçš„åŒå­¦ç»†å¿ƒçœ‹ç€ï¼Œæ‹¿ä¸åˆ°MDLé”å°±æš‚æ—¶æ”¾å¼ƒï¼Œ<br>è¿™ç§æœ‰å®¢æˆ·ç«¯é‡è¯•çš„æ—¶å€™ç³»ç»Ÿå¾ˆå¿«å°±è¿æ¥è€—å°½äº†</p>
                                <p class="reply-time">2019-01-03 22:11</p>
                            </div>
                            
                        </div>
                    </li>
                    
                    <li data-v-87ffcada="" class="comment-item"><img
                            src="https://static001.geekbang.org/account/avatar/00/13/ea/9a/02d589f9.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">æ–œé¢é•œå­ Bill</span>
                            </div>
                            <div class="bd">ä¸šåŠ¡ä¾§æŸ¥è¯¢ç‰¹åœ°è¡¨Açš„SQLå‡é€šè¿‡æ˜¾å¼åœ°å¼€å¯äº‹åŠ¡æ§åˆ¶ï¼Œå­˜åœ¨éƒ¨åˆ†çš„æ…¢SQLï¼Œé«˜å¹¶å‘çš„æŸ¥è¯¢å½±å“äº†è¡¨AæŸ¥è¯¢çš„commitæ•ˆç‡ï¼Œæ²¡æœ‰åŠæ—¶é‡Šæ”¾DMLé”ï¼Œæ­¤æ—¶ä¸šåŠ¡å‘èµ·DDLæ“ä½œï¼Œè·å–MDLå†™é”è¢«é˜»å¡ï¼Œå¯¼è‡´åç»­éœ€è¦è·å–MDLè¯»é”çš„SQLè¢«é˜»å¡ï¼Œå¿«é€Ÿå¯¼è‡´è¿™ä¸ªåº“çš„è¿æ¥æ± è¢«ç”¨å®Œï¼Œé˜»å¡äº†æ•´ä¸ªå®ä¾‹çš„æŸ¥è¯¢ï¼ <br></div>
                            <span class="time">2019-01-03 20:44</span>
                            
                            <div class="reply">
                                <div class="reply-hd"><span>ä½œè€…å›å¤</span></div>
                                <p class="reply-content">æ˜¯ï¼Œè¿™ä¸ªå¾ˆå¯æ€•çš„ï¼ˆçœ‹æ¥è¿˜æŒºå¸¸è§ğŸ˜“</p>
                                <p class="reply-time">2019-01-10 14:14</p>
                            </div>
                            
                        </div>
                    </li>
                    
                    <li data-v-87ffcada="" class="comment-item"><img
                            src="https://static001.geekbang.org/account/avatar/00/11/40/5e/b8fada94.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">Ryoma</span>
                            </div>
                            <div class="bd">æˆ‘ä¹‹å‰çš„æè¿°æœ‰ç‚¹é—®é¢˜ï¼Œå…¶å®æƒ³é—®çš„æ˜¯ï¼šä¸ºä»€ä¹ˆåŠ äº† order by c descï¼Œç¬¬ä¸€ä¸ªå®šä½c=20 çš„è¡Œï¼Œä¼šåŠ ä¸Šé—´éš™é” (20,25) å’Œ next-key lock (15,20]ï¼Ÿ<br><br>å¦‚æœæ²¡æœ‰order by c descï¼Œç¬¬ä¸€æ¬¡å‘½ä¸­c=15æ—¶ï¼Œåªä¼šåŠ ä¸Šnext-key lock(10.15]ï¼›<br>è€Œæœ‰äº†order by c descï¼Œæˆ‘çš„ç†è§£æ˜¯ç¬¬ä¸€æ¬¡å‘½ä¸­c=20åªéœ€è¦åŠ ä¸Šnext-key lock (15,20]<br><br>å½“ç„¶æœ€å(20,25)è¿˜æ˜¯åŠ ä¸Šäº†é”ï¼Œè€å¸ˆçš„ç»“è®ºæ˜¯å¯¹çš„ï¼Œæˆ‘ä¹Ÿæµ‹è¯•è¿‡äº†ï¼Œä½†æ˜¯æˆ‘ä¸çŸ¥é“å¦‚ä½•è§£é‡Šã€‚<br>å”¯ä¸€èƒ½æƒ³åˆ°çš„è§£é‡Šæ˜¯order by c desc å¹¶ä¸ä¼šæ”¹å˜ä¼˜åŒ–2è¿™ä¸ªåŸåˆ™ï¼šå³ç­‰å€¼æŸ¥è¯¢æ—¶ï¼Œä¼šå‘å³éå†ä¸”æœ€åä¸€ä¸ªå€¼ä¸æ»¡è¶³ç­‰å€¼æ¡ä»¶ï¼›åŒæ—¶order by c desc å¸¦æ¥ä¸€ä¸ªç±»ä¼¼äºä¼˜åŒ–2çš„å‘å·¦éå†åŸåˆ™ã€‚<br>è¿›è€Œå¯¼è‡´æœ€åçš„é”èŒƒå›´æ˜¯(5,25)ï¼›è€Œæ²¡æœ‰order by c descçš„èŒƒå›´æ˜¯(10,25]ã€‚<br> <br></div>
                            <span class="time">2019-01-03 20:06</span>
                            
                            <div class="reply">
                                <div class="reply-hd"><span>ä½œè€…å›å¤</span></div>
                                <p class="reply-content">å› ä¸ºæ‰§è¡Œc=20çš„æ—¶å€™ï¼Œç”±äºè¦order by c desc, å°±è¦å…ˆæ‰¾åˆ°â€œæœ€å³è¾¹ç¬¬ä¸€ä¸ªc=20çš„è¡Œâ€ï¼Œ<br>è¿™ä¸ªæ€ä¹ˆæ‰¾å‘¢ï¼Œåªèƒ½å‘å³æ‰¾åˆ°25ï¼Œæ‰èƒ½çŸ¥é“å®ƒå·¦è¾¹é‚£ä¸ª20æ˜¯â€œæœ€å³çš„20â€<br><br></p>
                                <p class="reply-time">2019-01-03 22:22</p>
                            </div>
                            
                        </div>
                    </li>
                    
                    <li data-v-87ffcada="" class="comment-item"><img
                            src="https://static001.geekbang.org/account/avatar/00/14/00/f0/08409e78.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">ä¸€å¤§åªğŸ˜´</span>
                            </div>
                            <div class="bd">è€å¸ˆï¼Œæˆ‘æ‰¾åˆ°æˆ‘ä¸Šæ¬¡è¯´RRéš”ç¦»çº§åˆ«ä¸‹ï¼Œsession 1:begin;select * from t where d=5 for update;  session 2:update t set d=5 where id=0;å¯ä»¥æ‰§è¡Œçš„åŸå› äº†ï¼Œæˆ‘é…ç½®æ–‡ä»¶ä¸­ç¦ç”¨äº†é—´éš™é”ï¼Œinnodb_locks_unsafe_for_binlog=on,æ”¹æˆoffé»˜è®¤å€¼å°±æ­£å¸¸äº†ã€‚ <br></div>
                            <span class="time">2019-01-03 15:20</span>
                            
                            <div class="reply">
                                <div class="reply-hd"><span>ä½œè€…å›å¤</span></div>
                                <p class="reply-content">ğŸ˜“å±…ç„¶å¼€äº†è¿™ä¸ªï¼Œç”Ÿäº§ä¸å»ºè®®å¼€å“¦</p>
                                <p class="reply-time">2019-01-03 22:24</p>
                            </div>
                            
                        </div>
                    </li>
                    


                </ul>
            </div>
        </div>
    </div>
</div>
</body>
</html>