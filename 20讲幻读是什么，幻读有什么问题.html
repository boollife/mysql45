<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport"
          content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no,viewport-fit=cover">
    <meta name="format-detection" content="telephone=no">
    <style type="text/css">

#watermark {

  position: relative;
  overflow: hidden;
}

#watermark .x {
  position: absolute;
  top: 800;
  left: 400;
  color: #3300ff;
  font-size: 50px;
  pointer-events: none;
  opacity:0.3;
  filter:Alpha(opacity=50);
  
  
}
    </style>


    <style type="text/css">
 html{color:#333;-webkit-text-size-adjust:100%;-ms-text-size-adjust:100%;text-rendering:optimizelegibility;font-family:Helvetica Neue,PingFang SC,Verdana,Microsoft Yahei,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif}html.borderbox *,html.borderbox :after,html.borderbox :before{box-sizing:border-box}article,aside,blockquote,body,button,code,dd,details,dl,dt,fieldset,figcaption,figure,footer,form,h1,h2,h3,h4,h5,h6,header,hr,input,legend,li,menu,nav,ol,p,pre,section,td,textarea,th,ul{margin:0;padding:0}article,aside,details,figcaption,figure,footer,header,menu,nav,section{display:block}audio,canvas,video{display:inline-block}body,button,input,select,textarea{font:300 1em/1.8 PingFang SC,Lantinghei SC,Microsoft Yahei,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,Helvetica,sans-serif}button::-moz-focus-inner,input::-moz-focus-inner{padding:0;border:0}table{border-collapse:collapse;border-spacing:0}fieldset,img{border:0}blockquote{position:relative;color:#999;font-weight:400;border-left:1px solid #1abc9c;padding-left:1em;margin:1em 3em 1em 2em}@media only screen and (max-width:640px){blockquote{margin:1em 0}}abbr,acronym{border-bottom:1px dotted;font-variant:normal}abbr{cursor:help}del{text-decoration:line-through}address,caption,cite,code,dfn,em,th,var{font-style:normal;font-weight:400}ol,ul{list-style:none}caption,th{text-align:left}q:after,q:before{content:""}sub,sup{font-size:75%;line-height:0;position:relative}:root sub,:root sup{vertical-align:baseline}sup{top:-.5em}sub{bottom:-.25em}a{color:#1abc9c}a:hover{text-decoration:underline}.typo a{border-bottom:1px solid #1abc9c}.typo a:hover{border-bottom-color:#555;color:#555}.typo a:hover,a,ins{text-decoration:none}.typo-u,u{text-decoration:underline}mark{background:#fffdd1;border-bottom:1px solid #ffedce;padding:2px;margin:0 5px}code,pre,pre tt{font-family:Courier,Courier New,monospace}pre{background:hsla(0,0%,97%,.7);border:1px solid #ddd;padding:1em 1.5em;display:block;-webkit-overflow-scrolling:touch}hr{border:none;border-bottom:1px solid #cfcfcf;margin-bottom:.8em;height:10px}.typo-small,figcaption,small{font-size:.9em;color:#888}b,strong{font-weight:700;color:#000}[draggable]{cursor:move}.clearfix:after,.clearfix:before{content:"";display:table}.clearfix:after{clear:both}.clearfix{zoom:1}.textwrap,.textwrap td,.textwrap th{word-wrap:break-word;word-break:break-all}.textwrap-table{table-layout:fixed}.serif{font-family:Palatino,Optima,Georgia,serif}.typo-dl,.typo-form,.typo-hr,.typo-ol,.typo-p,.typo-pre,.typo-table,.typo-ul,.typo dl,.typo form,.typo hr,.typo ol,.typo p,.typo pre,.typo table,.typo ul,blockquote{margin-bottom:1rem}h1,h2,h3,h4,h5,h6{font-family:PingFang SC,Helvetica Neue,Verdana,Microsoft Yahei,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#000;line-height:1.35}.typo-h1,.typo-h2,.typo-h3,.typo-h4,.typo-h5,.typo-h6,.typo h1,.typo h2,.typo h3,.typo h4,.typo h5,.typo h6{margin-top:1.2em;margin-bottom:.6em;line-height:1.35}.typo-h1,.typo h1{font-size:2em}.typo-h2,.typo h2{font-size:1.8em}.typo-h3,.typo h3{font-size:1.6em}.typo-h4,.typo h4{font-size:1.4em}.typo-h5,.typo-h6,.typo h5,.typo h6{font-size:1.2em}.typo-ul,.typo ul{margin-left:1.3em;list-style:disc}.typo-ol,.typo ol{list-style:decimal;margin-left:1.9em}.typo-ol ol,.typo-ol ul,.typo-ul ol,.typo-ul ul,.typo li ol,.typo li ul{margin-bottom:.8em;margin-left:2em}.typo-ol ul,.typo-ul ul,.typo li ul{list-style:circle}.typo-table td,.typo-table th,.typo table caption,.typo table td,.typo table th{border:1px solid #ddd;padding:.5em 1em;color:#666}.typo-table th,.typo table th{background:#fbfbfb}.typo-table thead th,.typo table thead th{background:hsla(0,0%,95%,.7)}.typo table caption{border-bottom:none}.typo-input,.typo-textarea{-webkit-appearance:none;border-radius:0}.typo-em,.typo em,caption,legend{color:#000;font-weight:inherit}.typo-em{position:relative}.typo-em:after{position:absolute;top:.65em;left:0;width:100%;overflow:hidden;white-space:nowrap;content:"\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB"}.typo img{max-width:100%}.common-content{font-weight:400;color:#353535;line-height:1.75rem;white-space:normal;word-break:normal;font-size:1rem}.common-content img{display:block;max-width:100%;background-color:#eee}.common-content audio,.common-content video{width:100%;background-color:#eee}.common-content center,.common-content font{margin-top:1rem;display:inline-block}.common-content center{width:100%}.common-content pre{margin-top:1rem;padding-left:0;padding-right:0;position:relative;overflow:hidden}.common-content pre code{font-size:.8rem;font-family:Consolas,Liberation Mono,Menlo,monospace,Courier;display:block;width:100%;box-sizing:border-box;padding-left:1rem;padding-right:1rem;overflow-x:auto}.common-content hr{border:none;margin-top:1.5rem;margin-bottom:1.5rem;border-top:1px solid #f5f5f5;height:1px;background:none}.common-content b,.common-content h1,.common-content h2,.common-content h3,.common-content h4,.common-content h5,.common-content strong{font-weight:700}.common-content h1,.common-content h2{font-size:1.125rem;margin-bottom:.45rem}.common-content h3,.common-content h4,.common-content h5{font-size:1rem;margin-bottom:.45rem}.common-content p{font-weight:400;color:#353535;margin-top:.15rem}.common-content .orange{color:#ff5a05}.common-content .reference{font-size:1rem;color:#888}.custom-rich-content h1{margin-top:0;font-weight:400;font-size:15.25px;border-bottom:1px solid #eee;line-height:2.8}.custom-rich-content li,.custom-rich-content p{font-size:14px;color:#888;line-height:1.6}table.hljs-ln{margin-bottom:0;border-spacing:0;border-collapse:collapse}table.hljs-ln,table.hljs-ln tbody,table.hljs-ln td,table.hljs-ln tr{box-sizing:border-box}table.hljs-ln td{padding:0;border:0}table.hljs-ln td.hljs-ln-numbers{min-width:15px;color:rgba(27,31,35,.3);text-align:right;white-space:nowrap;cursor:pointer;user-select:none}table.hljs-ln td.hljs-ln-code,table.hljs-ln td.hljs-ln-numbers{font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,Courier,monospace;font-size:12px;line-height:20px;vertical-align:top}table.hljs-ln td.hljs-ln-code{position:relative;padding-right:10px;padding-left:10px;overflow:visible;color:#24292e;word-wrap:normal;white-space:pre}video::-webkit-media-controls{overflow:hidden!important}video::-webkit-media-controls-enclosure{width:calc(100% + 32px);margin-left:auto}.button-cancel{color:#888;border:1px solid #888;border-radius:3px;margin-right:12px}.button-cancel,.button-primary{-ms-flex-positive:1;flex-grow:1;height:35px;display:inline-block;font-size:15px;text-align:center;line-height:36px}.button-primary{color:#fff;background-color:#ff5a05;border-radius:3px}@font-face{font-family:iconfont;src:url(//at.alicdn.com/t/font_372689_bwwwtosxtzp.eot);src:url(//at.alicdn.com/t/font_372689_bwwwtosxtzp.eot#iefix) format("embedded-opentype"),url(//at.alicdn.com/t/font_372689_bwwwtosxtzp.woff) format("woff"),url(//at.alicdn.com/t/font_372689_bwwwtosxtzp.ttf) format("truetype"),url(//at.alicdn.com/t/font_372689_bwwwtosxtzp.svg#iconfont) format("svg")}@font-face{font-family:player-font;src:url(//at.alicdn.com/t/font_509397_1cyjv4o90qiod2t9.eot);src:url(//at.alicdn.com/t/font_509397_1cyjv4o90qiod2t9.eot#iefix) format("embedded-opentype"),url(//at.alicdn.com/t/font_509397_1cyjv4o90qiod2t9.woff) format("woff"),url(//at.alicdn.com/t/font_509397_1cyjv4o90qiod2t9.ttf) format("truetype"),url(//at.alicdn.com/t/font_509397_1cyjv4o90qiod2t9.svg#player-font) format("svg")}.iconfont{font-family:iconfont!important;font-size:16px;font-style:normal;-webkit-font-smoothing:antialiased;-webkit-text-stroke-width:.2px;-moz-osx-font-smoothing:grayscale}html{background:#fff;min-height:100%;-webkit-tap-highlight-color:rgba(0,0,0,0)}body{width:100%}body.fixed{overflow:hidden;position:fixed;width:100vw;height:100vh}i{font-style:normal}a{word-wrap:break-word;-webkit-tap-highlight-color:rgba(0,0,0,0)}a:hover{text-decoration:none}.fade-enter-active,.fade-leave-active{transition:opacity .3s}.fade-enter,.fade-leave-to{opacity:0}.MathJax,.MathJax_CHTML,.MathJax_MathContainer,.MathJax_MathML,.MathJax_PHTML,.MathJax_PlainSource,.MathJax_SVG{outline:0}.ios-app-switch .js-audit{display:none}._loading_wrap_{position:fixed;width:100vw;height:100vh;top:50%;left:50%;transform:translate(-50%,-50%);z-index:999}._loading_div_class_,._loading_wrap_{display:-ms-flexbox;display:flex;-ms-flex-pack:center;justify-content:center;-ms-flex-align:center;align-items:center}._loading_div_class_{word-wrap:break-word;padding:.5rem .75rem;text-align:center;z-index:9999;font-size:.6rem;max-width:60%;color:#fff;border-radius:.25rem;-ms-flex-direction:column;flex-direction:column}._loading_div_class_ .message{color:#353535;font-size:16px;line-height:3}.spinner{animation:circle-rotator 1.4s linear infinite}.spinner *{line-height:0;box-sizing:border-box}@keyframes circle-rotator{0%{transform:rotate(0deg)}to{transform:rotate(270deg)}}.path{stroke-dasharray:187;stroke-dashoffset:0;transform-origin:center;animation:circle-dash 1.4s ease-in-out infinite,circle-colors 5.6s ease-in-out infinite}@keyframes circle-colors{0%{stroke:#ff5a05}to{stroke:#ff5a05}}@keyframes circle-dash{0%{stroke-dashoffset:187}50%{stroke-dashoffset:46.75;transform:rotate(135deg)}to{stroke-dashoffset:187;transform:rotate(450deg)}}.confirm-box-wrapper,.confirm-box-wrapper .mask{position:absolute;top:0;left:0;right:0;bottom:0}.confirm-box-wrapper .mask{background:rgba(0,0,0,.6)}.confirm-box-wrapper .confirm-box{position:fixed;top:50%;left:50%;width:267px;background:#fff;transform:translate(-50%,-50%);border-radius:7px}.confirm-box-wrapper .confirm-box .head{margin:0 18px;font-size:18px;text-align:center;line-height:65px;border-bottom:1px solid #d9d9d9}.confirm-box-wrapper .confirm-box .body{padding:18px;padding-bottom:0;color:#353535;font-size:12.5px;max-height:150px;overflow:auto}.confirm-box-wrapper .confirm-box .foot{display:-ms-flexbox;display:flex;-ms-flex-direction:row;flex-direction:row;padding:18px}.confirm-box-wrapper .confirm-box .foot .button-cancel{border:1px solid #d9d9d9}.hljs{display:block;overflow-x:auto;padding:.5em;color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}




    </style>
    <style type="text/css">
        .button-cancel[data-v-87ffcada]{color:#888;border:1px solid #888;border-radius:3px;margin-right:12px}.button-cancel[data-v-87ffcada],.button-primary[data-v-87ffcada]{-webkit-box-flex:1;-ms-flex-positive:1;flex-grow:1;height:35px;display:inline-block;font-size:15px;text-align:center;line-height:36px}.button-primary[data-v-87ffcada]{color:#fff;background-color:#ff5a05;border-radius:3px}.pd[data-v-87ffcada]{padding-left:1.375rem;padding-right:1.375rem}.article[data-v-87ffcada]{max-width:70rem;margin:0 auto}.article .article-unavailable[data-v-87ffcada]{color:#fa8919;font-size:15px;font-weight:600;line-height:24px;border-radius:5px;padding:12px;background-color:#f6f7fb;margin-top:20px}.article .article-unavailable .iconfont[data-v-87ffcada]{font-size:12px}.article .main[data-v-87ffcada]{padding:1.25rem 0;margin-bottom:52px}.article-title[data-v-87ffcada]{color:#353535;font-weight:400;line-height:1.65rem;font-size:1.34375rem}.article-info[data-v-87ffcada]{color:#888;font-size:.9375rem;margin-top:1.0625rem}.article-content[data-v-87ffcada]{margin-top:1.0625rem}.article-content.android video[data-v-87ffcada]::-webkit-media-controls-fullscreen-button{display:none}.copyright[data-v-87ffcada]{color:#b2b2b2;padding-bottom:20px;margin-top:20px;font-size:13px}.audio-player[data-v-87ffcada]{width:100%;margin:20px 0}.to-comment[data-v-87ffcada]{overflow:hidden;padding-top:10px;margin-bottom:-30px}.to-comment a.button-primary[data-v-87ffcada]{float:right;height:20px;font-size:12px;line-height:20px;padding:4px 8px;cursor:pointer}.article-comments[data-v-87ffcada]{margin-top:2rem}.article-comments h2[data-v-87ffcada]{text-align:center;color:#888;position:relative;z-index:1;margin-bottom:1rem}.article-comments h2[data-v-87ffcada]:before{border-top:1px dotted #888;content:"";position:absolute;top:56%;left:0;width:100%;z-index:-1}.article-comments h2 span[data-v-87ffcada]{font-size:15.25px;font-weight:400;padding:0 1rem;background:#fff;display:inline-block}.article-sub-bottom[data-v-87ffcada]{z-index:10;cursor:pointer}.switch-btns[data-v-87ffcada]{height:76px;cursor:pointer;padding-top:24px;padding-bottom:24px;border-bottom:10px solid #f6f7fb;position:relative}.switch-btns[data-v-87ffcada]:before{content:" ";height:1px;background:#e8e8e8;position:absolute;top:0;left:0;-webkit-box-sizing:border-box;box-sizing:border-box;left:1.375rem;right:1.375rem}.switch-btns .btn[data-v-87ffcada]{height:38px;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center}.switch-btns .btn .tag[data-v-87ffcada]{-webkit-box-flex:0;-ms-flex:0 0 62px;flex:0 0 62px;text-align:center;color:#888;font-size:14px;border-radius:10px;height:22px;line-height:22px;background:#f6f7fb;font-weight:400}.switch-btns .btn .txt[data-v-87ffcada]{margin-left:10px;-webkit-box-flex:1;-ms-flex:1 1 auto;flex:1 1 auto;color:#888;font-size:15px;height:22px;line-height:22px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-weight:400}@media (max-width:769px){.article .breadcrumb[data-v-87ffcada]{padding-top:10px;padding-bottom:10px}}





    </style>

    <style type="text/css">
        .comment-item{list-style-position:inside;width:100%;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin-bottom:1rem}.comment-item a{border-bottom:none}.comment-item .avatar{width:2.625rem;height:2.625rem;-ms-flex-negative:0;flex-shrink:0;border-radius:50%}.comment-item .info{margin-left:.5rem;-webkit-box-flex:1;-ms-flex-positive:1;flex-grow:1}.comment-item .info .hd{width:100%;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between;-webkit-box-align:center;-ms-flex-align:center;align-items:center}.comment-item .info .hd .username{color:#888;font-size:15.25px;font-weight:400;line-height:1.2}.comment-item .info .hd .control{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-align:center;-ms-flex-align:center;align-items:center}.comment-item .info .hd .control .btn-share{color:#888;font-size:.75rem;margin-right:1rem}.comment-item .info .hd .control .btn-praise{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-align:center;-ms-flex-align:center;align-items:center;font-size:15.25px;text-decoration:none}.comment-item .info .hd .control .btn-praise i{color:#888;display:inline-block;font-size:.75rem;margin-right:.3rem;margin-top:-.01rem}.comment-item .info .hd .control .btn-praise i.on,.comment-item .info .hd .control .btn-praise span{color:#ff5a05}.comment-item .info .bd{color:#353535;font-size:15.25px;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6}.comment-item .info .time{color:#888;font-size:9px;line-height:1}.comment-item .info .reply .reply-hd{font-size:15.25px}.comment-item .info .reply .reply-hd span{margin-left:-12px;color:#888;font-weight:400}.comment-item .info .reply .reply-hd i{color:#ff5a05;font-size:15.25px}.comment-item .info .reply .reply-content{color:#353535;font-size:15.25px;font-weight:400;white-space:normal;word-break:break-all}.comment-item .info .reply .reply-time{color:#888;font-size:9px}




    </style>
</head>
<body>
<div id="app">


    <div data-v-87ffcada="" class="article" id="watermark">
        <div data-v-87ffcada="" class="main main-app">
            <h1 data-v-87ffcada="" class="article-title pd">
                20è®²å¹»è¯»æ˜¯ä»€ä¹ˆï¼Œå¹»è¯»æœ‰ä»€ä¹ˆé—®é¢˜
            </h1>
            <div data-v-87ffcada="" class="article-content typo common-content pd"><img data-v-87ffcada=""
                                                                                        src="https://static001.geekbang.org/resource/image/97/b7/9719ecdc5d6f443817438205259f8bb7.jpg">

                <div>
                    <audio controls="controls" height="100" width="100">
                        <source src="20è®²å¹»è¯»æ˜¯ä»€ä¹ˆï¼Œå¹»è¯»æœ‰ä»€ä¹ˆé—®é¢˜.mp3" type="audio/mp3" />
                        <embed height="100" width="100" src="20è®²å¹»è¯»æ˜¯ä»€ä¹ˆï¼Œå¹»è¯»æœ‰ä»€ä¹ˆé—®é¢˜.mp3" />
                    </audio>
                </div>
                <div data-v-87ffcada="" id="article-content" class="">
                    <div class="text">
                        <p>åœ¨ä¸Šä¸€ç¯‡æ–‡ç« æœ€åï¼Œæˆ‘ç»™ä½ ç•™äº†ä¸€ä¸ªå…³äºåŠ é”è§„åˆ™çš„é—®é¢˜ã€‚ä»Šå¤©ï¼Œæˆ‘ä»¬å°±ä»è¿™ä¸ªé—®é¢˜è¯´èµ·å§ã€‚</p><p>ä¸ºäº†ä¾¿äºè¯´æ˜é—®é¢˜ï¼Œè¿™ä¸€ç¯‡æ–‡ç« ï¼Œæˆ‘ä»¬å°±å…ˆä½¿ç”¨ä¸€ä¸ªå°ä¸€ç‚¹å„¿çš„è¡¨ã€‚å»ºè¡¨å’Œåˆå§‹åŒ–è¯­å¥å¦‚ä¸‹ï¼ˆä¸ºäº†ä¾¿äºæœ¬æœŸçš„ä¾‹å­è¯´æ˜ï¼Œæˆ‘æŠŠä¸Šç¯‡æ–‡ç« ä¸­ç”¨åˆ°çš„è¡¨ç»“æ„åšäº†ç‚¹å„¿ä¿®æ”¹ï¼‰ï¼š</p><pre><code>CREATE TABLE `t` (
  `id` int(11) NOT NULL,
  `c` int(11) DEFAULT NULL,
  `d` int(11) DEFAULT NULL,
  PRIMARY KEY (`id`),
  KEY `c` (`c`)
) ENGINE=InnoDB;

insert into t values(0,0,0),(5,5,5),
(10,10,10),(15,15,15),(20,20,20),(25,25,25);
</code></pre><p>è¿™ä¸ªè¡¨é™¤äº†ä¸»é”®idå¤–ï¼Œè¿˜æœ‰ä¸€ä¸ªç´¢å¼•cï¼Œåˆå§‹åŒ–è¯­å¥åœ¨è¡¨ä¸­æ’å…¥äº†6è¡Œæ•°æ®ã€‚</p><p>ä¸ŠæœŸæˆ‘ç•™ç»™ä½ çš„é—®é¢˜æ˜¯ï¼Œä¸‹é¢çš„è¯­å¥åºåˆ—ï¼Œæ˜¯æ€ä¹ˆåŠ é”çš„ï¼ŒåŠ çš„é”åˆæ˜¯ä»€ä¹ˆæ—¶å€™é‡Šæ”¾çš„å‘¢ï¼Ÿ</p><pre><code>begin;
select * from t where d=5 for update;
commit;
</code></pre><p>æ¯”è¾ƒå¥½ç†è§£çš„æ˜¯ï¼Œè¿™ä¸ªè¯­å¥ä¼šå‘½ä¸­d=5çš„è¿™ä¸€è¡Œï¼Œå¯¹åº”çš„ä¸»é”®id=5ï¼Œå› æ­¤åœ¨select è¯­å¥æ‰§è¡Œå®Œæˆåï¼Œid=5è¿™ä¸€è¡Œä¼šåŠ ä¸€ä¸ªå†™é”ï¼Œè€Œä¸”ç”±äºä¸¤é˜¶æ®µé”åè®®ï¼Œè¿™ä¸ªå†™é”ä¼šåœ¨æ‰§è¡Œcommitè¯­å¥çš„æ—¶å€™é‡Šæ”¾ã€‚</p><p>ç”±äºå­—æ®µdä¸Šæ²¡æœ‰ç´¢å¼•ï¼Œå› æ­¤è¿™æ¡æŸ¥è¯¢è¯­å¥ä¼šåšå…¨è¡¨æ‰«æã€‚é‚£ä¹ˆï¼Œå…¶ä»–è¢«æ‰«æåˆ°çš„ï¼Œä½†æ˜¯ä¸æ»¡è¶³æ¡ä»¶çš„5è¡Œè®°å½•ä¸Šï¼Œä¼šä¸ä¼šè¢«åŠ é”å‘¢ï¼Ÿ</p><p>æˆ‘ä»¬çŸ¥é“ï¼ŒInnoDBçš„é»˜è®¤äº‹åŠ¡éš”ç¦»çº§åˆ«æ˜¯å¯é‡å¤è¯»ï¼Œæ‰€ä»¥æœ¬æ–‡æ¥ä¸‹æ¥æ²¡æœ‰ç‰¹æ®Šè¯´æ˜çš„éƒ¨åˆ†ï¼Œéƒ½æ˜¯è®¾å®šåœ¨å¯é‡å¤è¯»éš”ç¦»çº§åˆ«ä¸‹ã€‚</p><h1>å¹»è¯»æ˜¯ä»€ä¹ˆï¼Ÿ</h1><p>ç°åœ¨ï¼Œæˆ‘ä»¬å°±æ¥åˆ†æä¸€ä¸‹ï¼Œå¦‚æœåªåœ¨id=5è¿™ä¸€è¡ŒåŠ é”ï¼Œè€Œå…¶ä»–è¡Œçš„ä¸åŠ é”çš„è¯ï¼Œä¼šæ€ä¹ˆæ ·ã€‚</p><p>ä¸‹é¢å…ˆæ¥çœ‹ä¸€ä¸‹è¿™ä¸ªåœºæ™¯ï¼š</p><p><img src="https://static001.geekbang.org/resource/image/5b/8b/5bc506e5884d21844126d26bbe6fa68b.png" alt=""></p><center><span class="reference">å›¾ 1 å‡è®¾åªåœ¨id=5è¿™ä¸€è¡ŒåŠ è¡Œé”</span></center><!-- [[[read_end]]] --><p>å¯ä»¥çœ‹åˆ°ï¼Œsession Aé‡Œæ‰§è¡Œäº†ä¸‰æ¬¡æŸ¥è¯¢ï¼Œåˆ†åˆ«æ˜¯Q1ã€Q2å’ŒQ3ã€‚å®ƒä»¬çš„SQLè¯­å¥ç›¸åŒï¼Œéƒ½æ˜¯select * from t where d=5 for updateã€‚è¿™ä¸ªè¯­å¥çš„æ„æ€ä½ åº”è¯¥å¾ˆæ¸…æ¥šäº†ï¼ŒæŸ¥æ‰€æœ‰d=5çš„è¡Œï¼Œè€Œä¸”ä½¿ç”¨çš„æ˜¯å½“å‰è¯»ï¼Œå¹¶ä¸”åŠ ä¸Šå†™é”ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è¿™ä¸‰æ¡SQLè¯­å¥ï¼Œåˆ†åˆ«ä¼šè¿”å›ä»€ä¹ˆç»“æœã€‚</p><ol>
<li>
<p>Q1åªè¿”å›id=5è¿™ä¸€è¡Œï¼›</p>
</li>
<li>
<p>åœ¨T2æ—¶åˆ»ï¼Œsession BæŠŠid=0è¿™ä¸€è¡Œçš„då€¼æ”¹æˆäº†5ï¼Œå› æ­¤T3æ—¶åˆ»Q2æŸ¥å‡ºæ¥çš„æ˜¯id=0å’Œid=5è¿™ä¸¤è¡Œï¼›</p>
</li>
<li>
<p>åœ¨T4æ—¶åˆ»ï¼Œsession Cåˆæ’å…¥ä¸€è¡Œï¼ˆ1,1,5ï¼‰ï¼Œå› æ­¤T5æ—¶åˆ»Q3æŸ¥å‡ºæ¥çš„æ˜¯id=0ã€id=1å’Œid=5çš„è¿™ä¸‰è¡Œã€‚</p>
</li>
</ol><p>å…¶ä¸­ï¼ŒQ3è¯»åˆ°id=1è¿™ä¸€è¡Œçš„ç°è±¡ï¼Œè¢«ç§°ä¸ºâ€œå¹»è¯»â€ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¹»è¯»æŒ‡çš„æ˜¯ä¸€ä¸ªäº‹åŠ¡åœ¨å‰åä¸¤æ¬¡æŸ¥è¯¢åŒä¸€ä¸ªèŒƒå›´çš„æ—¶å€™ï¼Œåä¸€æ¬¡æŸ¥è¯¢çœ‹åˆ°äº†å‰ä¸€æ¬¡æŸ¥è¯¢æ²¡æœ‰çœ‹åˆ°çš„è¡Œã€‚</p><p>è¿™é‡Œï¼Œæˆ‘éœ€è¦å¯¹â€œå¹»è¯»â€åšä¸€ä¸ªè¯´æ˜ï¼š</p><ol>
<li>
<p>åœ¨å¯é‡å¤è¯»éš”ç¦»çº§åˆ«ä¸‹ï¼Œæ™®é€šçš„æŸ¥è¯¢æ˜¯å¿«ç…§è¯»ï¼Œæ˜¯ä¸ä¼šçœ‹åˆ°åˆ«çš„äº‹åŠ¡æ’å…¥çš„æ•°æ®çš„ã€‚å› æ­¤ï¼Œå¹»è¯»åœ¨â€œå½“å‰è¯»â€ä¸‹æ‰ä¼šå‡ºç°ã€‚</p>
</li>
<li>
<p>ä¸Šé¢session Bçš„ä¿®æ”¹ç»“æœï¼Œè¢«session Aä¹‹åçš„selectè¯­å¥ç”¨â€œå½“å‰è¯»â€çœ‹åˆ°ï¼Œä¸èƒ½ç§°ä¸ºå¹»è¯»ã€‚å¹»è¯»ä»…ä¸“æŒ‡â€œæ–°æ’å…¥çš„è¡Œâ€ã€‚</p>
</li>
</ol><p>å¦‚æœåªä»ç¬¬8ç¯‡æ–‡ç« <a href="https://time.geekbang.org/column/article/70562">ã€Šäº‹åŠ¡åˆ°åº•æ˜¯éš”ç¦»çš„è¿˜æ˜¯ä¸éš”ç¦»çš„ï¼Ÿã€‹</a>æˆ‘ä»¬å­¦åˆ°çš„äº‹åŠ¡å¯è§æ€§è§„åˆ™æ¥åˆ†æçš„è¯ï¼Œä¸Šé¢è¿™ä¸‰æ¡SQLè¯­å¥çš„è¿”å›ç»“æœéƒ½æ²¡æœ‰é—®é¢˜ã€‚</p><p>å› ä¸ºè¿™ä¸‰ä¸ªæŸ¥è¯¢éƒ½æ˜¯åŠ äº†for updateï¼Œéƒ½æ˜¯å½“å‰è¯»ã€‚è€Œå½“å‰è¯»çš„è§„åˆ™ï¼Œå°±æ˜¯è¦èƒ½è¯»åˆ°æ‰€æœ‰å·²ç»æäº¤çš„è®°å½•çš„æœ€æ–°å€¼ã€‚å¹¶ä¸”ï¼Œsession Bå’ŒsessionCçš„ä¸¤æ¡è¯­å¥ï¼Œæ‰§è¡Œåå°±ä¼šæäº¤ï¼Œæ‰€ä»¥Q2å’ŒQ3å°±æ˜¯åº”è¯¥çœ‹åˆ°è¿™ä¸¤ä¸ªäº‹åŠ¡çš„æ“ä½œæ•ˆæœï¼Œè€Œä¸”ä¹Ÿçœ‹åˆ°äº†ï¼Œè¿™è·Ÿäº‹åŠ¡çš„å¯è§æ€§è§„åˆ™å¹¶ä¸çŸ›ç›¾ã€‚</p><p>ä½†æ˜¯ï¼Œè¿™æ˜¯ä¸æ˜¯çœŸçš„æ²¡é—®é¢˜å‘¢ï¼Ÿ</p><p>ä¸ï¼Œè¿™é‡Œè¿˜çœŸå°±æœ‰é—®é¢˜ã€‚</p><h1>å¹»è¯»æœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿ</h1><p><strong>é¦–å…ˆæ˜¯è¯­ä¹‰ä¸Šçš„ã€‚</strong>session Aåœ¨T1æ—¶åˆ»å°±å£°æ˜äº†ï¼Œâ€œæˆ‘è¦æŠŠæ‰€æœ‰d=5çš„è¡Œé”ä½ï¼Œä¸å‡†åˆ«çš„äº‹åŠ¡è¿›è¡Œè¯»å†™æ“ä½œâ€ã€‚è€Œå®é™…ä¸Šï¼Œè¿™ä¸ªè¯­ä¹‰è¢«ç ´åäº†ã€‚</p><p>å¦‚æœç°åœ¨è¿™æ ·çœ‹æ„Ÿè§‰è¿˜ä¸æ˜æ˜¾çš„è¯ï¼Œæˆ‘å†å¾€session Bå’Œsession Cé‡Œé¢åˆ†åˆ«åŠ ä¸€æ¡SQLè¯­å¥ï¼Œä½ å†çœ‹çœ‹ä¼šå‡ºç°ä»€ä¹ˆç°è±¡ã€‚</p><p><img src="https://static001.geekbang.org/resource/image/7a/07/7a9ffa90ac3cc78db6a51ff9b9075607.png" alt=""></p><center><span class="reference">å›¾ 2 å‡è®¾åªåœ¨id=5è¿™ä¸€è¡ŒåŠ è¡Œé”--è¯­ä¹‰è¢«ç ´å</span></center><p>session Bçš„ç¬¬äºŒæ¡è¯­å¥update t set c=5 where id=0ï¼Œè¯­ä¹‰æ˜¯â€œæˆ‘æŠŠid=0ã€d=5è¿™ä¸€è¡Œçš„cå€¼ï¼Œæ”¹æˆäº†5â€ã€‚</p><p>ç”±äºåœ¨T1æ—¶åˆ»ï¼Œsession A è¿˜åªæ˜¯ç»™id=5è¿™ä¸€è¡ŒåŠ äº†è¡Œé”ï¼Œ å¹¶æ²¡æœ‰ç»™id=0è¿™è¡ŒåŠ ä¸Šé”ã€‚å› æ­¤ï¼Œsession Båœ¨T2æ—¶åˆ»ï¼Œæ˜¯å¯ä»¥æ‰§è¡Œè¿™ä¸¤æ¡updateè¯­å¥çš„ã€‚è¿™æ ·ï¼Œå°±ç ´åäº† session A é‡ŒQ1è¯­å¥è¦é”ä½æ‰€æœ‰d=5çš„è¡Œçš„åŠ é”å£°æ˜ã€‚</p><p>session Cä¹Ÿæ˜¯ä¸€æ ·çš„é“ç†ï¼Œå¯¹id=1è¿™ä¸€è¡Œçš„ä¿®æ”¹ï¼Œä¹Ÿæ˜¯ç ´åäº†Q1çš„åŠ é”å£°æ˜ã€‚</p><p><strong>å…¶æ¬¡ï¼Œæ˜¯æ•°æ®ä¸€è‡´æ€§çš„é—®é¢˜ã€‚</strong></p><p>æˆ‘ä»¬çŸ¥é“ï¼Œé”çš„è®¾è®¡æ˜¯ä¸ºäº†ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ã€‚è€Œè¿™ä¸ªä¸€è‡´æ€§ï¼Œä¸æ­¢æ˜¯æ•°æ®åº“å†…éƒ¨æ•°æ®çŠ¶æ€åœ¨æ­¤åˆ»çš„ä¸€è‡´æ€§ï¼Œè¿˜åŒ…å«äº†æ•°æ®å’Œæ—¥å¿—åœ¨é€»è¾‘ä¸Šçš„ä¸€è‡´æ€§ã€‚</p><p>ä¸ºäº†è¯´æ˜è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ç»™session Aåœ¨T1æ—¶åˆ»å†åŠ ä¸€ä¸ªæ›´æ–°è¯­å¥ï¼Œå³ï¼šupdate t set d=100 where d=5ã€‚</p><p><img src="https://static001.geekbang.org/resource/image/dc/92/dcea7845ff0bdbee2622bf3c67d31d92.png" alt=""></p><center><span class="reference">å›¾ 3 å‡è®¾åªåœ¨id=5è¿™ä¸€è¡ŒåŠ è¡Œé”--æ•°æ®ä¸€è‡´æ€§é—®é¢˜</span></center><p>updateçš„åŠ é”è¯­ä¹‰å’Œselect ...for update æ˜¯ä¸€è‡´çš„ï¼Œæ‰€ä»¥è¿™æ—¶å€™åŠ ä¸Šè¿™æ¡updateè¯­å¥ä¹Ÿå¾ˆåˆç†ã€‚session Aå£°æ˜è¯´â€œè¦ç»™d=5çš„è¯­å¥åŠ ä¸Šé”â€ï¼Œå°±æ˜¯ä¸ºäº†è¦æ›´æ–°æ•°æ®ï¼Œæ–°åŠ çš„è¿™æ¡updateè¯­å¥å°±æ˜¯æŠŠå®ƒè®¤ä¸ºåŠ ä¸Šäº†é”çš„è¿™ä¸€è¡Œçš„då€¼ä¿®æ”¹æˆäº†100ã€‚</p><p>ç°åœ¨ï¼Œæˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹å›¾3æ‰§è¡Œå®Œæˆåï¼Œæ•°æ®åº“é‡Œä¼šæ˜¯ä»€ä¹ˆç»“æœã€‚</p><ol>
<li>
<p>ç»è¿‡T1æ—¶åˆ»ï¼Œid=5è¿™ä¸€è¡Œå˜æˆ (5,5,100)ï¼Œå½“ç„¶è¿™ä¸ªç»“æœæœ€ç»ˆæ˜¯åœ¨T6æ—¶åˆ»æ­£å¼æäº¤çš„;</p>
</li>
<li>
<p>ç»è¿‡T2æ—¶åˆ»ï¼Œid=0è¿™ä¸€è¡Œå˜æˆ(0,5,5);</p>
</li>
<li>
<p>ç»è¿‡T4æ—¶åˆ»ï¼Œè¡¨é‡Œé¢å¤šäº†ä¸€è¡Œ(1,5,5);</p>
</li>
<li>
<p>å…¶ä»–è¡Œè·Ÿè¿™ä¸ªæ‰§è¡Œåºåˆ—æ— å…³ï¼Œä¿æŒä¸å˜ã€‚</p>
</li>
</ol><p>è¿™æ ·çœ‹ï¼Œè¿™äº›æ•°æ®ä¹Ÿæ²¡å•¥é—®é¢˜ï¼Œä½†æ˜¯æˆ‘ä»¬å†æ¥çœ‹çœ‹è¿™æ—¶å€™binlogé‡Œé¢çš„å†…å®¹ã€‚</p><ol>
<li>
<p>T2æ—¶åˆ»ï¼Œsession Bäº‹åŠ¡æäº¤ï¼Œå†™å…¥äº†ä¸¤æ¡è¯­å¥ï¼›</p>
</li>
<li>
<p>T4æ—¶åˆ»ï¼Œsession Cäº‹åŠ¡æäº¤ï¼Œå†™å…¥äº†ä¸¤æ¡è¯­å¥ï¼›</p>
</li>
<li>
<p>T6æ—¶åˆ»ï¼Œsession Aäº‹åŠ¡æäº¤ï¼Œå†™å…¥äº†update t set d=100 where d=5 è¿™æ¡è¯­å¥ã€‚</p>
</li>
</ol><p>æˆ‘ç»Ÿä¸€æ”¾åˆ°ä¸€èµ·çš„è¯ï¼Œå°±æ˜¯è¿™æ ·çš„ï¼š</p><pre><code>update t set d=5 where id=0; /*(0,0,5)*/
update t set c=5 where id=0; /*(0,5,5)*/

insert into t values(1,1,5); /*(1,1,5)*/
update t set c=5 where id=1; /*(1,5,5)*/

update t set d=100 where d=5;/*æ‰€æœ‰d=5çš„è¡Œï¼Œdæ”¹æˆ100*/
</code></pre><p>å¥½ï¼Œä½ åº”è¯¥çœ‹å‡ºé—®é¢˜äº†ã€‚è¿™ä¸ªè¯­å¥åºåˆ—ï¼Œä¸è®ºæ˜¯æ‹¿åˆ°å¤‡åº“å»æ‰§è¡Œï¼Œè¿˜æ˜¯ä»¥åç”¨binlogæ¥å…‹éš†ä¸€ä¸ªåº“ï¼Œè¿™ä¸‰è¡Œçš„ç»“æœï¼Œéƒ½å˜æˆäº† (0,5,100)ã€(1,5,100)å’Œ(5,5,100)ã€‚</p><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œid=0å’Œid=1è¿™ä¸¤è¡Œï¼Œå‘ç”Ÿäº†æ•°æ®ä¸ä¸€è‡´ã€‚è¿™ä¸ªé—®é¢˜å¾ˆä¸¥é‡ï¼Œæ˜¯ä¸è¡Œçš„ã€‚</p><p>åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å†å›é¡¾ä¸€ä¸‹ï¼Œ<strong>è¿™ä¸ªæ•°æ®ä¸ä¸€è‡´åˆ°åº•æ˜¯æ€ä¹ˆå¼•å…¥çš„ï¼Ÿ</strong></p><p>æˆ‘ä»¬åˆ†æä¸€ä¸‹å¯ä»¥çŸ¥é“ï¼Œè¿™æ˜¯æˆ‘ä»¬å‡è®¾â€œselect * from t where d=5 for updateè¿™æ¡è¯­å¥åªç»™d=5è¿™ä¸€è¡Œï¼Œä¹Ÿå°±æ˜¯id=5çš„è¿™ä¸€è¡ŒåŠ é”â€å¯¼è‡´çš„ã€‚</p><p>æ‰€ä»¥æˆ‘ä»¬è®¤ä¸ºï¼Œä¸Šé¢çš„è®¾å®šä¸åˆç†ï¼Œè¦æ”¹ã€‚</p><p>é‚£æ€ä¹ˆæ”¹å‘¢ï¼Ÿæˆ‘ä»¬æŠŠæ‰«æè¿‡ç¨‹ä¸­ç¢°åˆ°çš„è¡Œï¼Œä¹Ÿéƒ½åŠ ä¸Šå†™é”ï¼Œå†æ¥çœ‹çœ‹æ‰§è¡Œæ•ˆæœã€‚</p><p><img src="https://static001.geekbang.org/resource/image/34/47/34ad6478281709da833856084a1e3447.png" alt=""></p><center><span class="reference">å›¾ 4 å‡è®¾æ‰«æåˆ°çš„è¡Œéƒ½è¢«åŠ ä¸Šäº†è¡Œé”</span></center><p>ç”±äºsession AæŠŠæ‰€æœ‰çš„è¡Œéƒ½åŠ äº†å†™é”ï¼Œæ‰€ä»¥session Båœ¨æ‰§è¡Œç¬¬ä¸€ä¸ªupdateè¯­å¥çš„æ—¶å€™å°±è¢«é”ä½äº†ã€‚éœ€è¦ç­‰åˆ°T6æ—¶åˆ»session Aæäº¤ä»¥åï¼Œsession Bæ‰èƒ½ç»§ç»­æ‰§è¡Œã€‚</p><p>è¿™æ ·å¯¹äºid=0è¿™ä¸€è¡Œï¼Œåœ¨æ•°æ®åº“é‡Œçš„æœ€ç»ˆç»“æœè¿˜æ˜¯ (0,5,5)ã€‚åœ¨binlogé‡Œé¢ï¼Œæ‰§è¡Œåºåˆ—æ˜¯è¿™æ ·çš„ï¼š</p><pre><code>insert into t values(1,1,5); /*(1,1,5)*/
update t set c=5 where id=1; /*(1,5,5)*/

update t set d=100 where d=5;/*æ‰€æœ‰d=5çš„è¡Œï¼Œdæ”¹æˆ100*/

update t set d=5 where id=0; /*(0,0,5)*/
update t set c=5 where id=0; /*(0,5,5)*/
</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼ŒæŒ‰ç…§æ—¥å¿—é¡ºåºæ‰§è¡Œï¼Œid=0è¿™ä¸€è¡Œçš„æœ€ç»ˆç»“æœä¹Ÿæ˜¯(0,5,5)ã€‚æ‰€ä»¥ï¼Œid=0è¿™ä¸€è¡Œçš„é—®é¢˜è§£å†³äº†ã€‚</p><p>ä½†åŒæ—¶ä½ ä¹Ÿå¯ä»¥çœ‹åˆ°ï¼Œid=1è¿™ä¸€è¡Œï¼Œåœ¨æ•°æ®åº“é‡Œé¢çš„ç»“æœæ˜¯(1,5,5)ï¼Œè€Œæ ¹æ®binlogçš„æ‰§è¡Œç»“æœæ˜¯(1,5,100)ï¼Œä¹Ÿå°±æ˜¯è¯´å¹»è¯»çš„é—®é¢˜è¿˜æ˜¯æ²¡æœ‰è§£å†³ã€‚ä¸ºä»€ä¹ˆæˆ‘ä»¬å·²ç»è¿™ä¹ˆâ€œå‡¶æ®‹â€åœ°ï¼ŒæŠŠæ‰€æœ‰çš„è®°å½•éƒ½ä¸Šäº†é”ï¼Œè¿˜æ˜¯é˜»æ­¢ä¸äº†id=1è¿™ä¸€è¡Œçš„æ’å…¥å’Œæ›´æ–°å‘¢ï¼Ÿ</p><p>åŸå› å¾ˆç®€å•ã€‚åœ¨T3æ—¶åˆ»ï¼Œæˆ‘ä»¬ç»™æ‰€æœ‰è¡ŒåŠ é”çš„æ—¶å€™ï¼Œid=1è¿™ä¸€è¡Œè¿˜ä¸å­˜åœ¨ï¼Œä¸å­˜åœ¨ä¹Ÿå°±åŠ ä¸ä¸Šé”ã€‚</p><p><strong>ä¹Ÿå°±æ˜¯è¯´ï¼Œå³ä½¿æŠŠæ‰€æœ‰çš„è®°å½•éƒ½åŠ ä¸Šé”ï¼Œè¿˜æ˜¯é˜»æ­¢ä¸äº†æ–°æ’å…¥çš„è®°å½•ï¼Œ</strong>è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆâ€œå¹»è¯»â€ä¼šè¢«å•ç‹¬æ‹¿å‡ºæ¥è§£å†³çš„åŸå› ã€‚</p><p>åˆ°è¿™é‡Œï¼Œå…¶å®æˆ‘ä»¬åˆšè¯´æ˜å®Œæ–‡ç« çš„æ ‡é¢˜ ï¼šå¹»è¯»çš„å®šä¹‰å’Œå¹»è¯»æœ‰ä»€ä¹ˆé—®é¢˜ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å†çœ‹çœ‹InnoDBæ€ä¹ˆè§£å†³å¹»è¯»çš„é—®é¢˜ã€‚</p><h1>å¦‚ä½•è§£å†³å¹»è¯»ï¼Ÿ</h1><p>ç°åœ¨ä½ çŸ¥é“äº†ï¼Œäº§ç”Ÿå¹»è¯»çš„åŸå› æ˜¯ï¼Œè¡Œé”åªèƒ½é”ä½è¡Œï¼Œä½†æ˜¯æ–°æ’å…¥è®°å½•è¿™ä¸ªåŠ¨ä½œï¼Œè¦æ›´æ–°çš„æ˜¯è®°å½•ä¹‹é—´çš„â€œé—´éš™â€ã€‚å› æ­¤ï¼Œä¸ºäº†è§£å†³å¹»è¯»é—®é¢˜ï¼ŒInnoDBåªå¥½å¼•å…¥æ–°çš„é”ï¼Œä¹Ÿå°±æ˜¯é—´éš™é”(Gap Lock)ã€‚</p><p>é¡¾åæ€ä¹‰ï¼Œé—´éš™é”ï¼Œé”çš„å°±æ˜¯ä¸¤ä¸ªå€¼ä¹‹é—´çš„ç©ºéš™ã€‚æ¯”å¦‚æ–‡ç« å¼€å¤´çš„è¡¨tï¼Œåˆå§‹åŒ–æ’å…¥äº†6ä¸ªè®°å½•ï¼Œè¿™å°±äº§ç”Ÿäº†7ä¸ªé—´éš™ã€‚</p><p><img src="https://static001.geekbang.org/resource/image/e7/61/e7f7ca0d3dab2f48c588d714ee3ac861.png" alt=""></p><center><span class="reference">å›¾ 5 è¡¨tä¸»é”®ç´¢å¼•ä¸Šçš„è¡Œé”å’Œé—´éš™é”</span></center><p>è¿™æ ·ï¼Œå½“ä½ æ‰§è¡Œ select * from t where d=5 for updateçš„æ—¶å€™ï¼Œå°±ä¸æ­¢æ˜¯ç»™æ•°æ®åº“ä¸­å·²æœ‰çš„6ä¸ªè®°å½•åŠ ä¸Šäº†è¡Œé”ï¼Œè¿˜åŒæ—¶åŠ äº†7ä¸ªé—´éš™é”ã€‚è¿™æ ·å°±ç¡®ä¿äº†æ— æ³•å†æ’å…¥æ–°çš„è®°å½•ã€‚</p><p>ä¹Ÿå°±æ˜¯è¯´è¿™æ—¶å€™ï¼Œåœ¨ä¸€è¡Œè¡Œæ‰«æçš„è¿‡ç¨‹ä¸­ï¼Œä¸ä»…å°†ç»™è¡ŒåŠ ä¸Šäº†è¡Œé”ï¼Œè¿˜ç»™è¡Œä¸¤è¾¹çš„ç©ºéš™ï¼Œä¹ŸåŠ ä¸Šäº†é—´éš™é”ã€‚</p><p>ç°åœ¨ä½ çŸ¥é“äº†ï¼Œæ•°æ®è¡Œæ˜¯å¯ä»¥åŠ ä¸Šé”çš„å®ä½“ï¼Œæ•°æ®è¡Œä¹‹é—´çš„é—´éš™ï¼Œä¹Ÿæ˜¯å¯ä»¥åŠ ä¸Šé”çš„å®ä½“ã€‚ä½†æ˜¯é—´éš™é”è·Ÿæˆ‘ä»¬ä¹‹å‰ç¢°åˆ°è¿‡çš„é”éƒ½ä¸å¤ªä¸€æ ·ã€‚</p><p>æ¯”å¦‚è¡Œé”ï¼Œåˆ†æˆè¯»é”å’Œå†™é”ã€‚ä¸‹å›¾å°±æ˜¯è¿™ä¸¤ç§ç±»å‹è¡Œé”çš„å†²çªå…³ç³»ã€‚</p><p><img src="https://static001.geekbang.org/resource/image/c4/51/c435c765556c0f3735a6eda0779ff151.png" alt=""></p><center><span class="reference">å›¾6 ä¸¤ç§è¡Œé”é—´çš„å†²çªå…³ç³»</span></center><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œè·Ÿè¡Œé”æœ‰å†²çªå…³ç³»çš„æ˜¯â€œå¦å¤–ä¸€ä¸ªè¡Œé”â€ã€‚</p><p>ä½†æ˜¯é—´éš™é”ä¸ä¸€æ ·ï¼Œ<strong>è·Ÿé—´éš™é”å­˜åœ¨å†²çªå…³ç³»çš„ï¼Œæ˜¯â€œå¾€è¿™ä¸ªé—´éš™ä¸­æ’å…¥ä¸€ä¸ªè®°å½•â€è¿™ä¸ªæ“ä½œã€‚</strong>é—´éš™é”ä¹‹é—´éƒ½ä¸å­˜åœ¨å†²çªå…³ç³»ã€‚</p><p>è¿™å¥è¯ä¸å¤ªå¥½ç†è§£ï¼Œæˆ‘ç»™ä½ ä¸¾ä¸ªä¾‹å­ï¼š</p><p><img src="https://static001.geekbang.org/resource/image/7c/98/7c37732d936650f1cda7dbf27daf7498.png" alt=""></p><center><span class="reference">å›¾7 é—´éš™é”ä¹‹é—´ä¸äº’é”</span></center><p>è¿™é‡Œsession Bå¹¶ä¸ä¼šè¢«å µä½ã€‚å› ä¸ºè¡¨té‡Œå¹¶æ²¡æœ‰c=7è¿™ä¸ªè®°å½•ï¼Œå› æ­¤session AåŠ çš„æ˜¯é—´éš™é”(5,10)ã€‚è€Œsession Bä¹Ÿæ˜¯åœ¨è¿™ä¸ªé—´éš™åŠ çš„é—´éš™é”ã€‚å®ƒä»¬æœ‰å…±åŒçš„ç›®æ ‡ï¼Œå³ï¼šä¿æŠ¤è¿™ä¸ªé—´éš™ï¼Œä¸å…è®¸æ’å…¥å€¼ã€‚ä½†ï¼Œå®ƒä»¬ä¹‹é—´æ˜¯ä¸å†²çªçš„ã€‚</p><p>é—´éš™é”å’Œè¡Œé”åˆç§°next-key lockï¼Œæ¯ä¸ªnext-key lockæ˜¯å‰å¼€åé—­åŒºé—´ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬çš„è¡¨tåˆå§‹åŒ–ä»¥åï¼Œå¦‚æœç”¨select * from t for updateè¦æŠŠæ•´ä¸ªè¡¨æ‰€æœ‰è®°å½•é”èµ·æ¥ï¼Œå°±å½¢æˆäº†7ä¸ªnext-key lockï¼Œåˆ†åˆ«æ˜¯ (-âˆ,0]ã€(0,5]ã€(5,10]ã€(10,15]ã€(15,20]ã€(20, 25]ã€(25, +suprenum]ã€‚</p><blockquote>
<p>å¤‡æ³¨ï¼šè¿™ç¯‡æ–‡ç« ä¸­ï¼Œå¦‚æœæ²¡æœ‰ç‰¹åˆ«è¯´æ˜ï¼Œæˆ‘ä»¬æŠŠé—´éš™é”è®°ä¸ºå¼€åŒºé—´ï¼ŒæŠŠnext-key lockè®°ä¸ºå‰å¼€åé—­åŒºé—´ã€‚</p>
</blockquote><p>ä½ å¯èƒ½ä¼šé—®è¯´ï¼Œè¿™ä¸ªsuprenumä»å“ªå„¿æ¥çš„å‘¢ï¼Ÿ</p><p>è¿™æ˜¯å› ä¸º+âˆæ˜¯å¼€åŒºé—´ã€‚å®ç°ä¸Šï¼ŒInnoDBç»™æ¯ä¸ªç´¢å¼•åŠ äº†ä¸€ä¸ªä¸å­˜åœ¨çš„æœ€å¤§å€¼suprenumï¼Œè¿™æ ·æ‰ç¬¦åˆæˆ‘ä»¬å‰é¢è¯´çš„â€œéƒ½æ˜¯å‰å¼€åé—­åŒºé—´â€ã€‚</p><p><strong>é—´éš™é”å’Œnext-key lockçš„å¼•å…¥ï¼Œå¸®æˆ‘ä»¬è§£å†³äº†å¹»è¯»çš„é—®é¢˜ï¼Œä½†åŒæ—¶ä¹Ÿå¸¦æ¥äº†ä¸€äº›â€œå›°æ‰°â€ã€‚</strong></p><p>åœ¨å‰é¢çš„æ–‡ç« ä¸­ï¼Œå°±æœ‰åŒå­¦æåˆ°äº†è¿™ä¸ªé—®é¢˜ã€‚æˆ‘æŠŠä»–çš„é—®é¢˜è½¬è¿°ä¸€ä¸‹ï¼Œå¯¹åº”åˆ°æˆ‘ä»¬è¿™ä¸ªä¾‹å­çš„è¡¨æ¥è¯´ï¼Œä¸šåŠ¡é€»è¾‘è¿™æ ·çš„ï¼šä»»æ„é”ä½ä¸€è¡Œï¼Œå¦‚æœè¿™ä¸€è¡Œä¸å­˜åœ¨çš„è¯å°±æ’å…¥ï¼Œå¦‚æœå­˜åœ¨è¿™ä¸€è¡Œå°±æ›´æ–°å®ƒçš„æ•°æ®ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><pre><code>begin;
select * from t where id=N for update;

/*å¦‚æœè¡Œä¸å­˜åœ¨*/
insert into t values(N,N,N);
/*å¦‚æœè¡Œå­˜åœ¨*/
update t set d=N set id=N;

commit;
</code></pre><p>å¯èƒ½ä½ ä¼šè¯´ï¼Œè¿™ä¸ªä¸æ˜¯insert ... on duplicate key update å°±èƒ½è§£å†³å—ï¼Ÿä½†å…¶å®åœ¨æœ‰å¤šä¸ªå”¯ä¸€é”®çš„æ—¶å€™ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯ä¸èƒ½æ»¡è¶³è¿™ä½æé—®åŒå­¦çš„éœ€æ±‚çš„ã€‚è‡³äºä¸ºä»€ä¹ˆï¼Œæˆ‘ä¼šåœ¨åé¢çš„æ–‡ç« ä¸­å†å±•å¼€è¯´æ˜ã€‚</p><p>ç°åœ¨ï¼Œæˆ‘ä»¬å°±åªè®¨è®ºè¿™ä¸ªé€»è¾‘ã€‚</p><p>è¿™ä¸ªåŒå­¦ç¢°åˆ°çš„ç°è±¡æ˜¯ï¼Œè¿™ä¸ªé€»è¾‘ä¸€æ—¦æœ‰å¹¶å‘ï¼Œå°±ä¼šç¢°åˆ°æ­»é”ã€‚ä½ ä¸€å®šä¹Ÿè§‰å¾—å¥‡æ€ªï¼Œè¿™ä¸ªé€»è¾‘æ¯æ¬¡æ“ä½œå‰ç”¨for updateé”èµ·æ¥ï¼Œå·²ç»æ˜¯æœ€ä¸¥æ ¼çš„æ¨¡å¼äº†ï¼Œæ€ä¹ˆè¿˜ä¼šæœ‰æ­»é”å‘¢ï¼Ÿ</p><p>è¿™é‡Œï¼Œæˆ‘ç”¨ä¸¤ä¸ªsessionæ¥æ¨¡æ‹Ÿå¹¶å‘ï¼Œå¹¶å‡è®¾N=9ã€‚</p><p><img src="https://static001.geekbang.org/resource/image/df/be/df37bf0bb9f85ea59f0540e24eb6bcbe.png" alt=""></p><center><span class="reference">å›¾8 é—´éš™é”å¯¼è‡´çš„æ­»é”</span></center><p>ä½ çœ‹åˆ°äº†ï¼Œå…¶å®éƒ½ä¸éœ€è¦ç”¨åˆ°åé¢çš„updateè¯­å¥ï¼Œå°±å·²ç»å½¢æˆæ­»é”äº†ã€‚æˆ‘ä»¬æŒ‰è¯­å¥æ‰§è¡Œé¡ºåºæ¥åˆ†æä¸€ä¸‹ï¼š</p><ol>
<li>
<p>session A æ‰§è¡Œselect ... for updateè¯­å¥ï¼Œç”±äºid=9è¿™ä¸€è¡Œå¹¶ä¸å­˜åœ¨ï¼Œå› æ­¤ä¼šåŠ ä¸Šé—´éš™é”(5,10);</p>
</li>
<li>
<p>session B æ‰§è¡Œselect ... for updateè¯­å¥ï¼ŒåŒæ ·ä¼šåŠ ä¸Šé—´éš™é”(5,10)ï¼Œé—´éš™é”ä¹‹é—´ä¸ä¼šå†²çªï¼Œå› æ­¤è¿™ä¸ªè¯­å¥å¯ä»¥æ‰§è¡ŒæˆåŠŸï¼›</p>
</li>
<li>
<p>session B è¯•å›¾æ’å…¥ä¸€è¡Œ(9,9,9)ï¼Œè¢«session Açš„é—´éš™é”æŒ¡ä½äº†ï¼Œåªå¥½è¿›å…¥ç­‰å¾…ï¼›</p>
</li>
<li>
<p>session Aè¯•å›¾æ’å…¥ä¸€è¡Œ(9,9,9)ï¼Œè¢«session Bçš„é—´éš™é”æŒ¡ä½äº†ã€‚</p>
</li>
</ol><p>è‡³æ­¤ï¼Œä¸¤ä¸ªsessionè¿›å…¥äº’ç›¸ç­‰å¾…çŠ¶æ€ï¼Œå½¢æˆæ­»é”ã€‚å½“ç„¶ï¼ŒInnoDBçš„æ­»é”æ£€æµ‹é©¬ä¸Šå°±å‘ç°äº†è¿™å¯¹æ­»é”å…³ç³»ï¼Œè®©session Açš„insertè¯­å¥æŠ¥é”™è¿”å›äº†ã€‚</p><p>ä½ ç°åœ¨çŸ¥é“äº†ï¼Œ<strong>é—´éš™é”çš„å¼•å…¥ï¼Œå¯èƒ½ä¼šå¯¼è‡´åŒæ ·çš„è¯­å¥é”ä½æ›´å¤§çš„èŒƒå›´ï¼Œè¿™å…¶å®æ˜¯å½±å“äº†å¹¶å‘åº¦çš„</strong>ã€‚å…¶å®ï¼Œè¿™è¿˜åªæ˜¯ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼Œåœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­æˆ‘ä»¬è¿˜ä¼šç¢°åˆ°æ›´å¤šã€æ›´å¤æ‚çš„ä¾‹å­ã€‚</p><p>ä½ å¯èƒ½ä¼šè¯´ï¼Œä¸ºäº†è§£å†³å¹»è¯»çš„é—®é¢˜ï¼Œæˆ‘ä»¬å¼•å…¥äº†è¿™ä¹ˆä¸€å¤§ä¸²å†…å®¹ï¼Œæœ‰æ²¡æœ‰æ›´ç®€å•ä¸€ç‚¹çš„å¤„ç†æ–¹æ³•å‘¢ã€‚</p><p>æˆ‘åœ¨æ–‡ç« ä¸€å¼€å§‹å°±è¯´è¿‡ï¼Œå¦‚æœæ²¡æœ‰ç‰¹åˆ«è¯´æ˜ï¼Œä»Šå¤©å’Œä½ åˆ†æçš„é—®é¢˜éƒ½æ˜¯åœ¨å¯é‡å¤è¯»éš”ç¦»çº§åˆ«ä¸‹çš„ï¼Œé—´éš™é”æ˜¯åœ¨å¯é‡å¤è¯»éš”ç¦»çº§åˆ«ä¸‹æ‰ä¼šç”Ÿæ•ˆçš„ã€‚æ‰€ä»¥ï¼Œä½ å¦‚æœæŠŠéš”ç¦»çº§åˆ«è®¾ç½®ä¸ºè¯»æäº¤çš„è¯ï¼Œå°±æ²¡æœ‰é—´éš™é”äº†ã€‚ä½†åŒæ—¶ï¼Œä½ è¦è§£å†³å¯èƒ½å‡ºç°çš„æ•°æ®å’Œæ—¥å¿—ä¸ä¸€è‡´é—®é¢˜ï¼Œéœ€è¦æŠŠbinlogæ ¼å¼è®¾ç½®ä¸ºrowã€‚è¿™ï¼Œä¹Ÿæ˜¯ç°åœ¨ä¸å°‘å…¬å¸ä½¿ç”¨çš„é…ç½®ç»„åˆã€‚</p><p>å‰é¢æ–‡ç« çš„è¯„è®ºåŒºæœ‰åŒå­¦ç•™è¨€è¯´ï¼Œä»–ä»¬å…¬å¸å°±ä½¿ç”¨çš„æ˜¯è¯»æäº¤éš”ç¦»çº§åˆ«åŠ binlog_format=rowçš„ç»„åˆã€‚ä»–æ›¾é—®ä»–ä»¬å…¬å¸çš„DBAè¯´ï¼Œä½ ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆé…ç½®ã€‚DBAç›´æ¥ç­”å¤è¯´ï¼Œå› ä¸ºå¤§å®¶éƒ½è¿™ä¹ˆç”¨å‘€ã€‚</p><p>æ‰€ä»¥ï¼Œè¿™ä¸ªåŒå­¦åœ¨è¯„è®ºåŒºå°±é—®è¯´ï¼Œè¿™ä¸ªé…ç½®åˆ°åº•åˆä¸åˆç†ã€‚</p><p>å…³äºè¿™ä¸ªé—®é¢˜æœ¬èº«çš„ç­”æ¡ˆæ˜¯ï¼Œå¦‚æœè¯»æäº¤éš”ç¦»çº§åˆ«å¤Ÿç”¨ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä¸šåŠ¡ä¸éœ€è¦å¯é‡å¤è¯»çš„ä¿è¯ï¼Œè¿™æ ·è€ƒè™‘åˆ°è¯»æäº¤ä¸‹æ“ä½œæ•°æ®çš„é”èŒƒå›´æ›´å°ï¼ˆæ²¡æœ‰é—´éš™é”ï¼‰ï¼Œè¿™ä¸ªé€‰æ‹©æ˜¯åˆç†çš„ã€‚</p><p>ä½†å…¶å®æˆ‘æƒ³è¯´çš„æ˜¯ï¼Œé…ç½®æ˜¯å¦åˆç†ï¼Œè·Ÿä¸šåŠ¡åœºæ™¯æœ‰å…³ï¼Œéœ€è¦å…·ä½“é—®é¢˜å…·ä½“åˆ†æã€‚</p><p>ä½†æ˜¯ï¼Œå¦‚æœDBAè®¤ä¸ºä¹‹æ‰€ä»¥è¿™ä¹ˆç”¨çš„åŸå› æ˜¯â€œå¤§å®¶éƒ½è¿™ä¹ˆç”¨â€ï¼Œé‚£å°±æœ‰é—®é¢˜äº†ï¼Œæˆ–è€…è¯´ï¼Œè¿Ÿæ—©ä¼šå‡ºé—®é¢˜ã€‚</p><p>æ¯”å¦‚è¯´ï¼Œå¤§å®¶éƒ½ç”¨è¯»æäº¤ï¼Œå¯æ˜¯é€»è¾‘å¤‡ä»½çš„æ—¶å€™ï¼Œmysqldumpä¸ºä»€ä¹ˆè¦æŠŠå¤‡ä»½çº¿ç¨‹è®¾ç½®æˆå¯é‡å¤è¯»å‘¢ï¼Ÿï¼ˆè¿™ä¸ªæˆ‘åœ¨å‰é¢çš„æ–‡ç« ä¸­å·²ç»è§£é‡Šè¿‡äº†ï¼Œä½ å¯ä»¥å†å›é¡¾ä¸‹ç¬¬6ç¯‡æ–‡ç« <a href="https://time.geekbang.org/column/article/69862">ã€Šå…¨å±€é”å’Œè¡¨é” ï¼šç»™è¡¨åŠ ä¸ªå­—æ®µæ€ä¹ˆæœ‰è¿™ä¹ˆå¤šé˜»ç¢ï¼Ÿã€‹</a>çš„å†…å®¹ï¼‰</p><p>ç„¶åï¼Œåœ¨å¤‡ä»½æœŸé—´ï¼Œå¤‡ä»½çº¿ç¨‹ç”¨çš„æ˜¯å¯é‡å¤è¯»ï¼Œè€Œä¸šåŠ¡çº¿ç¨‹ç”¨çš„æ˜¯è¯»æäº¤ã€‚åŒæ—¶å­˜åœ¨ä¸¤ç§äº‹åŠ¡éš”ç¦»çº§åˆ«ï¼Œä¼šä¸ä¼šæœ‰é—®é¢˜ï¼Ÿ</p><p>è¿›ä¸€æ­¥åœ°ï¼Œè¿™ä¸¤ä¸ªä¸åŒçš„éš”ç¦»çº§åˆ«ç°è±¡æœ‰ä»€ä¹ˆä¸ä¸€æ ·çš„ï¼Œå…³äºæˆ‘ä»¬çš„ä¸šåŠ¡ï¼Œâ€œç”¨è¯»æäº¤å°±å¤Ÿäº†â€è¿™ä¸ªç»“è®ºæ˜¯æ€ä¹ˆå¾—åˆ°çš„ï¼Ÿ</p><p>å¦‚æœä¸šåŠ¡å¼€å‘å’Œè¿ç»´å›¢é˜Ÿè¿™äº›é—®é¢˜éƒ½æ²¡æœ‰å¼„æ¸…æ¥šï¼Œé‚£ä¹ˆâ€œæ²¡é—®é¢˜â€è¿™ä¸ªç»“è®ºï¼Œæœ¬èº«å°±æ˜¯æœ‰é—®é¢˜çš„ã€‚</p><h1>å°ç»“</h1><p>ä»Šå¤©æˆ‘ä»¬ä»ä¸Šä¸€ç¯‡æ–‡ç« çš„è¯¾åé—®é¢˜è¯´èµ·ï¼Œæåˆ°äº†å…¨è¡¨æ‰«æçš„åŠ é”æ–¹å¼ã€‚æˆ‘ä»¬å‘ç°å³ä½¿ç»™æ‰€æœ‰çš„è¡Œéƒ½åŠ ä¸Šè¡Œé”ï¼Œä»ç„¶æ— æ³•è§£å†³å¹»è¯»é—®é¢˜ï¼Œå› æ­¤å¼•å…¥äº†é—´éš™é”çš„æ¦‚å¿µã€‚</p><p>æˆ‘ç¢°åˆ°è¿‡å¾ˆå¤šå¯¹æ•°æ®åº“æœ‰ä¸€å®šäº†è§£çš„ä¸šåŠ¡å¼€å‘äººå‘˜ï¼Œä»–ä»¬åœ¨è®¾è®¡æ•°æ®è¡¨ç»“æ„å’Œä¸šåŠ¡SQLè¯­å¥çš„æ—¶å€™ï¼Œå¯¹è¡Œé”æœ‰å¾ˆå‡†ç¡®çš„è®¤è¯†ï¼Œä½†å´å¾ˆå°‘è€ƒè™‘åˆ°é—´éš™é”ã€‚æœ€åçš„ç»“æœï¼Œå°±æ˜¯ç”Ÿäº§åº“ä¸Šä¼šç»å¸¸å‡ºç°ç”±äºé—´éš™é”å¯¼è‡´çš„æ­»é”ç°è±¡ã€‚</p><p>è¡Œé”ç¡®å®æ¯”è¾ƒç›´è§‚ï¼Œåˆ¤æ–­è§„åˆ™ä¹Ÿç›¸å¯¹ç®€å•ï¼Œé—´éš™é”çš„å¼•å…¥ä¼šå½±å“ç³»ç»Ÿçš„å¹¶å‘åº¦ï¼Œä¹Ÿå¢åŠ äº†é”åˆ†æçš„å¤æ‚åº¦ï¼Œä½†ä¹Ÿæœ‰ç« å¯å¾ªã€‚ä¸‹ä¸€ç¯‡æ–‡ç« ï¼Œæˆ‘å°±ä¼šä¸ºä½ è®²è§£InnoDBçš„åŠ é”è§„åˆ™ï¼Œå¸®ä½ ç†é¡ºè¿™å…¶ä¸­çš„â€œç« æ³•â€ã€‚</p><p>ä½œä¸ºå¯¹ä¸‹ä¸€ç¯‡æ–‡ç« çš„é¢„ä¹ ï¼Œæˆ‘ç»™ä½ ç•™ä¸‹ä¸€ä¸ªæ€è€ƒé¢˜ã€‚</p><p><img src="https://static001.geekbang.org/resource/image/0d/3d/0d796060073668ca169166a8903fbf3d.png" alt=""></p><center><span class="reference">å›¾9 äº‹åŠ¡è¿›å…¥é”ç­‰å¾…çŠ¶æ€</span></center><p>å¦‚æœä½ ä¹‹å‰æ²¡æœ‰äº†è§£è¿‡æœ¬ç¯‡æ–‡ç« çš„ç›¸å…³å†…å®¹ï¼Œä¸€å®šè§‰å¾—è¿™ä¸‰ä¸ªè¯­å¥ç®€ç›´æ˜¯é£é©¬ç‰›ä¸ç›¸åŠã€‚ä½†å®é™…ä¸Šï¼Œè¿™é‡Œsession Bå’Œsession Cçš„insert è¯­å¥éƒ½ä¼šè¿›å…¥é”ç­‰å¾…çŠ¶æ€ã€‚</p><p>ä½ å¯ä»¥è¯•ç€åˆ†æä¸€ä¸‹ï¼Œå‡ºç°è¿™ç§æƒ…å†µçš„åŸå› æ˜¯ä»€ä¹ˆï¼Ÿ</p><p>è¿™é‡Œéœ€è¦è¯´æ˜çš„æ˜¯ï¼Œè¿™å…¶å®æ˜¯æˆ‘åœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ä»‹ç»åŠ é”è§„åˆ™åæ‰èƒ½å›ç­”çš„é—®é¢˜ï¼Œæ˜¯ç•™ç»™ä½ ä½œä¸ºé¢„ä¹ çš„ï¼Œå…¶ä¸­session Cè¢«é”ä½è¿™ä¸ªåˆ†ææ˜¯æœ‰ç‚¹éš¾åº¦çš„ã€‚å¦‚æœä½ æ²¡æœ‰åˆ†æå‡ºæ¥ï¼Œä¹Ÿä¸è¦æ°”é¦ï¼Œæˆ‘ä¼šåœ¨ä¸‹ä¸€ç¯‡æ–‡ç« å’Œä½ è¯¦ç»†è¯´æ˜ã€‚</p><p>ä½ ä¹Ÿå¯ä»¥è¯´è¯´ï¼Œä½ çš„çº¿ä¸ŠMySQLé…ç½®çš„æ˜¯ä»€ä¹ˆéš”ç¦»çº§åˆ«ï¼Œä¸ºä»€ä¹ˆä¼šè¿™ä¹ˆé…ç½®ï¼Ÿä½ æœ‰æ²¡æœ‰ç¢°åˆ°ä»€ä¹ˆåœºæ™¯ï¼Œæ˜¯å¿…é¡»ä½¿ç”¨å¯é‡å¤è¯»éš”ç¦»çº§åˆ«çš„å‘¢ï¼Ÿ</p><p>ä½ å¯ä»¥æŠŠä½ çš„ç¢°åˆ°çš„åœºæ™¯å’Œåˆ†æå†™åœ¨ç•™è¨€åŒºé‡Œï¼Œæˆ‘ä¼šåœ¨ä¸‹ä¸€ç¯‡æ–‡ç« é€‰å–æœ‰è¶£çš„è¯„è®ºè·Ÿå¤§å®¶ä¸€èµ·åˆ†äº«å’Œåˆ†æã€‚æ„Ÿè°¢ä½ çš„æ”¶å¬ï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠè¿™ç¯‡æ–‡ç« åˆ†äº«ç»™æ›´å¤šçš„æœ‹å‹ä¸€èµ·é˜…è¯»ã€‚</p><h1>ä¸ŠæœŸé—®é¢˜æ—¶é—´</h1><p>æˆ‘ä»¬åœ¨æœ¬æ–‡çš„å¼€å¤´å›ç­”äº†ä¸ŠæœŸé—®é¢˜ã€‚æœ‰åŒå­¦çš„å›ç­”ä¸­è¿˜è¯´æ˜äº†è¯»æäº¤éš”ç¦»çº§åˆ«ä¸‹ï¼Œåœ¨è¯­å¥æ‰§è¡Œå®Œæˆåï¼Œæ˜¯åªæœ‰è¡Œé”çš„ã€‚è€Œä¸”è¯­å¥æ‰§è¡Œå®Œæˆåï¼ŒInnoDBå°±ä¼šæŠŠä¸æ»¡è¶³æ¡ä»¶çš„è¡Œè¡Œé”å»æ‰ã€‚</p><p>å½“ç„¶äº†ï¼Œc=5è¿™ä¸€è¡Œçš„è¡Œé”ï¼Œè¿˜æ˜¯ä¼šç­‰åˆ°commitçš„æ—¶å€™æ‰é‡Šæ”¾çš„ã€‚</p><p>è¯„è®ºåŒºç•™è¨€ç‚¹èµæ¿ï¼š</p><blockquote>
<p>@è–›ç•… ã€@å¼ æ°¸å¿—åŒå­¦ç»™å‡ºäº†æ­£ç¡®ç­”æ¡ˆã€‚è€Œä¸”æåˆ°äº†åœ¨è¯»æäº¤éš”ç¦»çº§åˆ«ä¸‹ï¼Œæ˜¯åªæœ‰è¡Œé”çš„ã€‚<br>
@å¸†å¸†å¸†å¸†å¸†å¸†å¸†å¸†ã€@æ¬§é˜³æˆ å¯¹ä¸ŠæœŸçš„ä¾‹å­åšäº†éªŒè¯ï¼Œéœ€è¦è¯´æ˜ä¸€ä¸‹ï¼Œéœ€è¦åœ¨å¯åŠ¨é…ç½®é‡Œé¢å¢åŠ performance_schema=onï¼Œæ‰èƒ½ç”¨ä¸Šè¿™ä¸ªåŠŸèƒ½ï¼Œperformance_schemaåº“é‡Œçš„è¡¨æ‰æœ‰æ•°æ®ã€‚</p>
</blockquote><p><img src="https://static001.geekbang.org/resource/image/09/77/09c1073f99cf71d2fb162a716b5fa577.jpg" alt=""></p>
                    </div>
                </div>

            </div>
            <div data-v-87ffcada="" class="article-comments pd"><h2 data-v-87ffcada=""><span
                    data-v-87ffcada="">ç²¾é€‰ç•™è¨€</span></h2>
                <ul data-v-87ffcada="">
                    
                    <li data-v-87ffcada="" class="comment-item"><img
                            src="https://static001.geekbang.org/account/avatar/00/14/5c/f4/88f107d9.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">ä»¤ç‹å°‘ä¾ </span>
                            </div>
                            <div class="bd">è€å¸ˆï¼Œä»Šå¤©çš„æ–‡ç« å¯¹æˆ‘å½±å“å¾ˆå¤§ï¼Œå‘ç°ä¹‹å‰æŒæ¡çš„çŸ¥è¯†æœ‰äº›é”™è¯¯çš„åœ°æ–¹ï¼Œè¯¾åæˆ‘ç”¨ä½ çš„è¡¨ç»“æ„æ ¹æ®ä»¥å‰ä¸æ¸…æ¥šçš„åœ°æ–¹å®è·µäº†ä¸€éï¼Œç°åœ¨æœ‰ä¸¤ä¸ªé—®é¢˜ï¼Œéº»çƒ¦æ‚¨è§£ç­”ä¸‹<br>1.æˆ‘åœ¨äº‹åŠ¡1ä¸­æ‰§è¡Œ begin;select * from t where c=5 for update;äº‹åŠ¡æœªæäº¤ï¼Œç„¶åäº‹åŠ¡2ä¸­begin;update t set c=5 where id=0;æ‰§è¡Œé˜»å¡ï¼Œæ›¿æ¢æˆupdate t set c=11 where id=0;æ‰§è¡Œä¸é˜»å¡ï¼Œæˆ‘è§‰å¾—åŸå› æ˜¯äº‹åŠ¡1æ‰§è¡Œæ—¶äº§ç”Ÿnext-key lockèŒƒå›´æ˜¯(0,5].(5,10]ã€‚æˆ‘æƒ³é—®ä¸‹update setæ“ä½œc=xxxæ˜¯ä¼šåŠ é”å—ï¼Ÿä»¥åŠåŠ é”çš„åŸç†ã€‚<br>2.ä¸€ç›´ä»¥ä¸ºgapåªä¼šåœ¨äºŒçº§ç´¢å¼•ä¸Šï¼Œçœ‹äº†ä½ çš„æ­»é”æ¡ˆä¾‹ï¼Œå‘ç°ä¸»é”®ç´¢å¼•ä¸Šä¹Ÿä¼šæœ‰gapé”ï¼Ÿ <br></div>
                            <span class="time">2018-12-28 15:37</span>
                            
                            <div class="reply">
                                <div class="reply-hd"><span>ä½œè€…å›å¤</span></div>
                                <p class="reply-content">1. å¥½é—®é¢˜ã€‚ä½ å¯ä»¥ç†è§£ä¸ºè¦åœ¨ç´¢å¼•cä¸Šæ’å…¥ä¸€ä¸ª(c=5,id=0)è¿™ä¸€è¡Œï¼Œæ˜¯è½åœ¨(0,5],(5,10]é‡Œé¢çš„ï¼Œ11å¯ä»¥å¯¹å§<br><br>2. å—¯ï¼Œä¸»é”®ç´¢å¼•çš„é—´éš™ä¸Šä¹Ÿè¦æœ‰Gap lockä¿æŠ¤çš„</p>
                                <p class="reply-time">2018-12-28 15:54</p>
                            </div>
                            
                        </div>
                    </li>
                    
                    <li data-v-87ffcada="" class="comment-item"><img
                            src="https://static001.geekbang.org/account/avatar/00/13/f3/2d/711d73b2.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">è–›ç•…</span>
                            </div>
                            <div class="bd">å¯é‡å¤è¯»éš”ç¦»çº§åˆ«ä¸‹ï¼Œç»è¯•éªŒï¼š<br>SELECT * FROM t where c&gt;=15 and c&lt;=20 for update; ä¼šåŠ å¦‚ä¸‹é”ï¼š<br>next-key lock:(10, 15], (15, 20]<br>gap lock:(20, 25)<br><br>SELECT * FROM t where c&gt;=15 and c&lt;=20  order by c desc for update; ä¼šåŠ å¦‚ä¸‹é”ï¼š<br>next-key lock:(5, 10], (10, 15], (15, 20]<br>gap lock:(20, 25)<br><br>session C è¢«é”ä½çš„åŸå› å°±æ˜¯æ ¹æ®ç´¢å¼• c é€†åºæ’åºåå¤šå‡ºçš„ next-key lock:(5, 10]<br><br>åŒæ—¶æˆ‘æœ‰ä¸ªç–‘é—®ï¼šåŠ ä¸åŠ  next-key lock:(5, 10] å¥½åƒéƒ½ä¸ä¼šå½±å“åˆ° session A å¯é‡å¤è¯»çš„è¯­ä¹‰ï¼Œé‚£ä¹ˆä¸ºä»€ä¹ˆè¦åŠ è¿™ä¸ªé”å‘¢ï¼Ÿ <br></div>
                            <span class="time">2018-12-29 09:03</span>
                            
                            <div class="reply">
                                <div class="reply-hd"><span>ä½œè€…å›å¤</span></div>
                                <p class="reply-content">æ˜¯çš„ï¼Œè¿™ä¸ªå…¶å®å°±æ˜¯ä¸ºå•¥æ€»ç»“è§„åˆ™æœ‰ç‚¹éº»çƒ¦ï¼Œæœ‰æ—¶å€™åªæ˜¯å› ä¸ºä»£ç æ˜¯è¿™ä¹ˆå†™çš„ğŸ˜“</p>
                                <p class="reply-time">2018-12-29 09:18</p>
                            </div>
                            
                        </div>
                    </li>
                    
                    <li data-v-87ffcada="" class="comment-item"><img
                            src="https://static001.geekbang.org/account/avatar/00/13/ef/3e/9c3a8abc.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">AIæœå˜‰å˜‰</span>
                            </div>
                            <div class="bd">è¯´çœŸçš„ï¼Œè¿™ä¸€ç³»åˆ—æ–‡ç« å®ç”¨æ€§çœŸçš„å¾ˆå¼ºï¼Œè€å¸ˆéå¸¸è´Ÿè´£ï¼Œæƒ³å¿…ç‰µæ‰¯åˆ°è€å¸ˆå¤§é‡ç²¾åŠ›ï¼Œå¸Œæœ›è€å¸ˆå†å‡ºå¥½æ–‡ç« ï¼Œè°¢è°¢æ‚¨äº†ï¼Œè¾›è‹¦äº† <br></div>
                            <span class="time">2018-12-28 13:59</span>
                            
                            <div class="reply">
                                <div class="reply-hd"><span>ä½œè€…å›å¤</span></div>
                                <p class="reply-content">ç²¾åŠ›èŠ±äº†æ²¡äº‹ï¼Œç¡ä¸€è§‰é†’æ¥è¿˜æ˜¯ä¸€æ¡å¥½æ±‰ğŸ˜„<br>ä¸»è¦è¿˜æ˜¯å¾—å¤§å®¶æœ‰æ”¶è·ï¼Œæˆ‘å°±å€¼äº†ğŸ˜„</p>
                                <p class="reply-time">2018-12-28 19:03</p>
                            </div>
                            
                        </div>
                    </li>
                    
                    <li data-v-87ffcada="" class="comment-item"><img
                            src="https://static001.geekbang.org/account/avatar/00/14/0c/ca/6173350b.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">éƒ­æ±Ÿä¼Ÿ</span>
                            </div>
                            <div class="bd">insert into t values(0,0,0),(5,5,5),<br>(10,10,10),(15,15,15),(20,20,20),(25,25,25);<br>è¿è¡Œmysql&gt; begin;<br>Query OK, 0 rows affected (0.00 sec)<br>mysql&gt; select * from t where c&gt;=15 and c&lt;=20 order by c desc for update;<br>c ç´¢å¼•ä¼šåœ¨æœ€å³ä¾§åŒ…å«ä¸»é”®å€¼ï¼Œcç´¢å¼•çš„å€¼ä¸º(0,0) (5,5) (10,10) (15,15) (20,20) (25,25)<br>æ­¤æ—¶cç´¢å¼•ä¸Šé”çš„èŒƒå›´å…¶å®è¿˜è¦åŒ¹é…ä¸»é”®å€¼ ã€‚<br>æ€è€ƒé¢˜ç­”æ¡ˆæ˜¯ï¼Œä¸Šé™ä¼šæ‰«åˆ°cç´¢å¼•(20,20) ä¸Šä¸€ä¸ªé”®ï¼Œä¸ºäº†é˜²æ­¢cä¸º20 ä¸»é”®å€¼å°äº25 çš„è¡Œæ’å…¥ï¼Œéœ€è¦é”å®š(20,20) (25,25) ä¸¤è€…çš„é—´éš™ï¼›å¼€å¯å¦ä¸€ä¼šè¯(26,25,25)å¯ä»¥æ’å…¥ï¼Œè€Œ(24,25,25)ä¼šè¢«å µå¡ã€‚<br>ä¸‹é™ä¼šæ‰«æåˆ°(15,15)çš„ä¸‹ä¸€ä¸ªé”®ä¹Ÿå°±æ˜¯(10,10),æµ‹è¯•è¯­å¥ä¼šç»§ç»­æ‰«æä¸€ä¸ªé”®å°±æ˜¯(5,5) ï¼Œæ­¤æ—¶ä¼šé”å®šï¼Œ(5,5) åˆ°(15,15)çš„é—´éš™ï¼Œç”±äºidæ˜¯ä¸»é”®ä¸å¯é‡å¤æ‰€ä»¥ä¸‹é™ä¹Ÿæ˜¯é—­åŒºé—´ï¼›<br>åœ¨æœ¬ä¾‹çš„æµ‹è¯•æ•°æ®ä¸­æ·»åŠ (21,25,25)åå°±å¯ä»¥æ­£å¸¸æ’å…¥(24,25,25) <br></div>
                            <span class="time">2018-12-28 13:38</span>
                            
                            <div class="reply">
                                <div class="reply-hd"><span>ä½œè€…å›å¤</span></div>
                                <p class="reply-content">æ„Ÿè§‰ä½ ä¸‹ä¸€ç¯‡çœ‹èµ·æ¥ä¼šå¾ˆè½»æ¾äº†å“ˆğŸ‘ğŸ¿</p>
                                <p class="reply-time">2018-12-28 19:04</p>
                            </div>
                            
                        </div>
                    </li>
                    
                    <li data-v-87ffcada="" class="comment-item"><img
                            src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLE4LYb3jrH63ZV98Zpc8DompwDgb1O3nffMoZCmiaibauRyEFv6NDNsST9RWxZExvMLMWb50zaanoQ/132" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">æ…§é‘«coming</span>
                            </div>
                            <div class="bd">è¿™ç¯‡éœ€è¦å¤šè¯»å‡ éï¼Œagain <br></div>
                            <span class="time">2018-12-28 08:24</span>
                            
                        </div>
                    </li>
                    
                    <li data-v-87ffcada="" class="comment-item"><img
                            src="https://static001.geekbang.org/account/avatar/00/13/fd/d5/0194ea41.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">æ²‰æµ®</span>
                            </div>
                            <div class="bd">é€šè¿‡æ‰“å°é”æ—¥å¿—å¸®åŠ©ç†è§£é—®é¢˜<br>é”ä¿¡æ¯è§æ‹¬å·é‡Œçš„è¯´æ˜ã€‚<br><br>TABLE LOCK table `guo_test`.`t` trx id 105275 lock mode IX<br>RECORD LOCKS space id 31 page no 4 n bits 80 index c of table `guo_test`.`t` trx id 105275 lock_mode X<br>Record lock, heap no 4 PHYSICAL RECORD: n_fields 2; compact format; info bits 0 												----(Next-Key Lockï¼Œç´¢å¼•é”cï¼ˆ5ï¼Œ10])<br> 0: len 4; hex 8000000a; asc     ;;<br> 1: len 4; hex 8000000a; asc     ;;<br><br>Record lock, heap no 5 PHYSICAL RECORD: n_fields 2; compact format; info bits 0	 										     	----(Next-Key Lockï¼Œç´¢å¼•é”c (10,15])	<br> 0: len 4; hex 8000000f; asc     ;;<br> 1: len 4; hex 8000000f; asc     ;;<br><br>Record lock, heap no 6 PHYSICAL RECORD: n_fields 2; compact format; info bits 0      											----(Next-Key Lockï¼Œç´¢å¼•é”c (15,20])	<br> 0: len 4; hex 80000014; asc     ;;<br> 1: len 4; hex 80000014; asc     ;;<br><br>Record lock, heap no 7 PHYSICAL RECORD: n_fields 2; compact format; info bits 0             									----(Next-Key Lockï¼Œç´¢å¼•é”c (20,25])	<br> 0: len 4; hex 80000019; asc     ;;<br> 1: len 4; hex 80000019; asc     ;;<br><br>RECORD LOCKS space id 31 page no 3 n bits 80 index PRIMARY of table `guo_test`.`t` trx id 105275 lock_mode X locks rec but not gap<br>Record lock, heap no 5 PHYSICAL RECORD: n_fields 5; compact format; info bits 0  <br>----(è®°å½•é” é”c=15å¯¹åº”çš„ä¸»é”®ï¼‰<br> 0: len 4; hex 8000000f; asc     ;;<br> 1: len 6; hex 0000000199e3; asc       ;;<br> 2: len 7; hex ca000001470134; asc     G 4;;<br> 3: len 4; hex 8000000f; asc     ;;<br> 4: len 4; hex 8000000f; asc     ;;<br><br>Record lock, heap no 6 PHYSICAL RECORD: n_fields 5; compact format; info bits 0<br> 0: len 4; hex 80000014; asc     ;;<br>----(è®°å½•é” é”c=20å¯¹åº”çš„ä¸»é”®ï¼‰<br> 1: len 6; hex 0000000199e3; asc       ;;<br> 2: len 7; hex ca000001470140; asc     G @;;<br> 3: len 4; hex 80000014; asc     ;;<br> 4: len 4; hex 80000014; asc     ;;<br>ç”±äºå­—æ•°é™åˆ¶ï¼Œæ­£åºåŠæ— æ’åºçš„æ—¥å¿—æ— æ³•å¸–å‡ºï¼Œå€’åºæ—¥å¿—æ¯”è¿™ä¸¤è€…ï¼Œå¤šäº†èŒƒå›´(Next-Key Lockï¼Œç´¢å¼•é”cï¼ˆ5ï¼Œ10])ï¼Œä¸ªäººç†è§£æ˜¯ï¼ŒåŠ é”åˆ†ä¸¤æ¬¡ï¼Œç¬¬ä¸€æ¬¡ï¼Œå³æ­£åºçš„é”ï¼Œç¬¬äºŒæ¬¡ä¸ºå€’åºçš„é”ï¼Œå³å¤šå‡ºçš„(5,10],åœ¨RRéš”ç¦»çº§åˆ«ï¼Œ<br>innodbåœ¨åŠ é”çš„è¿‡ç¨‹ä¸­ä¼šé»˜è®¤å‘åé”ä¸€ä¸ªè®°å½•ï¼ŒåŠ ä¸ŠNext-Key Lock,ç¬¬ä¸€æ¬¡åŠ é”çš„æ—¶å€™10å·²ç»åœ¨èŒƒå›´ï¼Œç”±äºå€’åºï¼Œå‘åï¼Œå³å‘5å†åŠ Next-key Lock,å³å¤šå‡ºçš„(5,10]èŒƒå›´ <br></div>
                            <span class="time">2018-12-28 16:06</span>
                            
                            <div class="reply">
                                <div class="reply-hd"><span>ä½œè€…å›å¤</span></div>
                                <p class="reply-content">ä¼˜ç§€</p>
                                <p class="reply-time">2018-12-28 17:14</p>
                            </div>
                            
                        </div>
                    </li>
                    
                    <li data-v-87ffcada="" class="comment-item"><img
                            src="https://static001.geekbang.org/account/avatar/00/12/da/ec/779c1a78.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">å¾€äº‹éšé£ï¼Œé¡ºå…¶è‡ªç„¶</span>
                            </div>
                            <div class="bd">æ€»ç»“ï¼šfor update æ˜¯é”ä½æ‰€æœ‰è¡Œè¿˜æœ‰é—´éš™é”ï¼Œä½†æ˜¯é—´éš™ğŸ”’ä¹‹é—´äº’ä¸å†²çªï¼Œä½†æ˜¯äº’ä¸å†²çªï¼Œä¸ºä»€ä¹ˆæ’å…¥9è¿™ä¸€è¡Œä¼šè¢«é—´éš™é”ç­‰å¾…ï¼ŒåŸæ¥æ²¡æœ‰è¿™ä¸€è¡Œï¼Œè¿™å’ŒæŸ¥è¯¢9è¿™ä¸€è¡Œä¸æ˜¯ä¸€æ ·ï¼Ÿ <br></div>
                            <span class="time">2018-12-28 08:09</span>
                            
                        </div>
                    </li>
                    
                    <li data-v-87ffcada="" class="comment-item"><img
                            src="https://static001.geekbang.org/account/avatar/00/11/a9/29/dad1f942.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">en</span>
                            </div>
                            <div class="bd">è€å¸ˆæ‚¨å¥½ï¼Œæˆ‘mysqlçš„éš”ç¦»çº§åˆ«æ˜¯å¯é‡å¤è¯»ï¼Œæ•°æ®æ˜¯(0,0,0),(5,5,5),(10,10,10),(15,15,15),(20,20,20),(25,25,25)ï¼Œä½¿ç”¨äº†begin;select * from t where c&gt;=15 and c&lt;=20 order by c desc for update;ç„¶åsessionBçš„11é˜»å¡äº†ï¼Œä½†æ˜¯(6,6,6)çš„æ’å…¥æˆåŠŸäº†è¿™æ˜¯ä»€ä¹ˆåŸå› å‘¢ï¼Ÿ <br></div>
                            <span class="time">2018-12-31 10:21</span>
                            
                        </div>
                    </li>
                    
                    <li data-v-87ffcada="" class="comment-item"><img
                            src="https://static001.geekbang.org/account/avatar/00/10/d1/7c/4639f22c.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">éƒ­å¥</span>
                            </div>
                            <div class="bd">è€å¸ˆï¼Œæƒ³è¯·æ•™æ‚¨å‡ ä¸ªé—®é¢˜ã€‚1.åœ¨ç¬¬å…­ç« MDLé”çš„æ—¶å€™ï¼Œæ‚¨è¯´ç»™å¤§è¡¨å¢åŠ å­—æ®µå’Œå¢åŠ ç´¢å¼•çš„æ—¶å€™è¦å°å¿ƒï¼Œä¹‹å‰åšè¿‡æµ‹è¯•ï¼Œç»™ä¸€ä¸ªä¸€åƒä¸‡çš„æ•°æ®å¢åŠ ç´¢å¼•æœ‰æ—¶éœ€è¦40åˆ†é’Ÿï¼Œä½†æ˜¯å¢åŠ ç´¢å¼•ä¸ä¼šå¯¹è¡¨å¢åŠ MDLé”å§ã€‚é™¤äº†å¢åŠ ç´¢å¼•æ…¢ï¼Œè¿˜ä¼šå¯¹æ•°æ®åº“æœ‰ä»€ä¹ˆå½±å“å—ï¼Œæˆ‘é—®æˆ‘ä»¬dbaï¼Œä»–è¯´å°±å¼€å§‹å’Œç»“æŸçš„æ—¶å€™ä¸Šä¸€ä¸‹é”ï¼Œæ²¡ä»€ä¹ˆå½±å“ï¼Œæˆ‘ä¸ªäººæ˜¯æŒæ€€ç–‘æ€åº¦çš„ã€‚2ï¼Œè€å¸ˆè®²åˆ°è¡¨é”é™¤äº†MDLé”ï¼Œè¿˜æœ‰æ˜¾ç¤ºå‘½ä»¤lock tableçš„å‘½ä»¤çš„è¡¨é”ï¼Œè€å¸ˆæˆ‘å¯ä»¥è®¤ä¸ºï¼Œåœ¨mysqlä¸­å¦‚æœä¸æ˜¾ç¤ºä½¿ç”¨lock tableè¡¨é”çš„è¯ï¼Œé‚£ä¹ˆmysqlæ˜¯æ°¸è¿œä¸ä¼šä½¿ç”¨è¡¨é”çš„ï¼Œå¦‚æœé”çš„æ¡ä»¶æ²¡æœ‰ç´¢å¼•ï¼Œä½¿ç”¨çš„æ˜¯é”ä½è¡Œé”+é—´éš™æ§åˆ¶å¹¶å‘ã€‚ <br></div>
                            <span class="time">2018-12-30 16:13</span>
                            
                            <div class="reply">
                                <div class="reply-hd"><span>ä½œè€…å›å¤</span></div>
                                <p class="reply-content">1. åœ¨é”æ–¹é¢ä½ ä»¬dbaè¯´çš„åŸºæœ¬æ˜¯å¯¹çš„ã€‚ä¸€å¼€å§‹å’Œç»“æŸæœ‰å†™é”ï¼Œæ‰§è¡Œä¸­é—´40åˆ†é’Ÿåªæœ‰è¯»é”<br>ä½†æ˜¯1000ä¸‡çš„è¡¨è¦åš40åˆ†é’Ÿï¼Œå¯èƒ½æ„å‘³ç€ç³»ç»Ÿå‹åŠ›å¤§ï¼ˆæˆ–è€…é…ç½®åå°ï¼‰ï¼Œè¿™æ ·å¯èƒ½ä¸æ˜¯æ²¡å½±å“å¯¹ï¼Œæ¯”è¾ƒè¿™ä¸ªæ“ä½œè¿˜æ˜¯è¦åƒIOå’ŒCPUçš„<br><br>2. å—¯ï¼Œinnodbå¼•æ“æ˜¯è¿™æ ·çš„ã€‚</p>
                                <p class="reply-time">2018-12-30 19:23</p>
                            </div>
                            
                        </div>
                    </li>
                    
                    <li data-v-87ffcada="" class="comment-item"><img
                            src="https://static001.geekbang.org/account/avatar/00/13/e3/2e/77ad18f4.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">æ»”æ»”</span>
                            </div>
                            <div class="bd">è€å¸ˆï¼Œå¬äº†æ‚¨çš„è¯¾æ”¶è·æ»¡æ»¡ï½ï½æ„Ÿè°¢æ‚¨çš„ä»˜å‡ºï¼æ‚¨å¯ä¸å¯ä»¥åœ¨åˆ†ææ­»é”çš„æ—¶å€™è®²ä¸€ä¸‹å¦‚ä½•åˆ†ææ­»é”æ—¥å¿—ï¼ŒæœŸå¾…ï½ï½ğŸ˜€ <br></div>
                            <span class="time">2018-12-29 18:20</span>
                            
                            <div class="reply">
                                <div class="reply-hd"><span>ä½œè€…å›å¤</span></div>
                                <p class="reply-content">è°¢è°¢ä½ çš„è‚¯å®šã€‚<br><br>å—¯æ­»é”åˆ†æä¼šæœ‰ä¸€ç¯‡ä¸“é—¨è¯´ã€‚<br><br>ä¸è¿‡ä½ å¯ä»¥æå‰è¯´ä¸€ä¸‹ç¢°åˆ°çš„ç–‘é—®ğŸ˜„</p>
                                <p class="reply-time">2018-12-29 20:08</p>
                            </div>
                            
                        </div>
                    </li>
                    
                    <li data-v-87ffcada="" class="comment-item"><img
                            src="https://static001.geekbang.org/account/avatar/00/13/29/36/c6bb0893.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">èƒ¡æœˆğŸŒˆ</span>
                            </div>
                            <div class="bd">è€å¸ˆï¼Œä»Šå¤©çº¿ä¸Šé‡ä¸Šäº†ä¸€ä¸ªæ­»é”çš„é—®é¢˜ï¼Œæ‚¨èƒ½å¸®æˆ‘åˆ†æä¸‹å—ã€‚<br>æ ¹æ®å‰é¢æ–‡ç« çš„ç†è§£ï¼šæ­»é”äº§ç”Ÿçš„åŸå› å¦‚ä¸‹<br>çº¿ç¨‹1ï¼šupdateè¯­å¥where c= 1 ç„¶å updateè¯­å¥where c=2<br>çº¿ç¨‹2ï¼šupdateè¯­å¥where c=2ç„¶å updateè¯­å¥where c=1<br>å¦‚æœçº¿ç¨‹1è·å–c=1çš„é”ï¼Œç­‰å¾…c=2çš„é”ï¼Œçº¿ç¨‹2è·å–äº†c=2çš„é”ï¼Œç­‰å¾…c=1çš„é”ï¼Œå°±ä¼šäº§ç”Ÿæ­»é”ã€‚<br>ä½†æ˜¯çº¿ä¸Šçš„æƒ…å†µæ˜¯<br>çº¿ç¨‹1ï¼šupdateè¯­å¥where c= 1 ç„¶å updateè¯­å¥where c=2<br>çº¿ç¨‹2ï¼šupdateè¯­å¥where c=1ç„¶å updateè¯­å¥where c=2<br>æŒ‰è¯´ä¸ä¼šäº§ç”Ÿæ­»é”å•Šï¼Œå› ä¸ºå¦‚æœçº¿ç¨‹1è·å–äº†c=1çš„é”ï¼Œçº¿ç¨‹2å°±é˜»å¡äº†ã€‚çº¿ç¨‹1æ‰§è¡Œå®Œä¹‹åï¼Œçº¿ç¨‹2æ‰§è¡Œå°±å¯ä»¥äº†æ­»é”æ—¥å¿—å¦‚ä¸‹ï¼š<br><br> (1) TRANSACTION:<br>TRANSACTION 9418928, ACTIVE 0.088 sec fetching rows<br>mysql tables in use 1, locked 1<br>LOCK WAIT 66 lock struct(s), heap size 13864, 8 row lock(s)<br>LOCK BLOCKING MySQL thread id: 11495130 block 11105198<br>MySQL thread id 11105198, OS thread handle 0x2b086bf45700, query id 88822589 39.106.161.89 daogou Searching rows for update<br>UPDATE union_pid<br>		SET	USE_TIMES = USE_TIMES + 1<br>		WHERE PID = &#39;mm_128160800_40474215_33107450401&#39;<br> (1) WAITING FOR THIS LOCK TO BE GRANTED:<br>RECORD LOCKS space id 134 page no 93 n bits 192 index `PRIMARY` of table `shanfan`.`union_pid` trx id 9418928 lock_mode X locks rec but not gap waiting<br>Record lock, heap no 86 PHYSICAL RECORD: n_fields 12; compact format; info bits 0<br><br> (2) TRANSACTION:<br>TRANSACTION 9418929, ACTIVE 0.088 sec fetching rows<br>mysql tables in use 1, locked 1<br>280 lock struct(s), heap size 46632, 17 row lock(s), undo log entries 1<br>MySQL thread id 11495130, OS thread handle 0x2b086be41700, query id 88822594 39.106.161.89 daogou Searching rows for update<br>UPDATE union_pid<br>		SET	USE_TIMES = USE_TIMES + 1<br>		WHERE PID = &#39;1000501132_0_1432392817&#39;<br>(2) HOLDS THE LOCK(S):<br>RECORD LOCKS space id 134 page no 93 n bits 192 index `PRIMARY` of table `shanfan`.`union_pid` trx id 9418929 lock_mode X locks rec but not gap<br>Record lock, heap no 86 PHYSICAL RECORD: n_fields 12; compact format; info bits 0<br><br> (2) WAITING FOR THIS LOCK TO BE GRANTED:<br>RECORD LOCKS space id 134 page no 68 n bits 264 index `PRIMARY` of table `shanfan`.`union_pid` trx id 9418929 lock_mode X locks rec but not gap waiting<br>Record lock, heap no 116 PHYSICAL RECORD: n_fields 12; compact format; info bits 0<br><br> WE ROLL BACK TRANSACTION (1) <br></div>
                            <span class="time">2018-12-29 18:08</span>
                            
                            <div class="reply">
                                <div class="reply-hd"><span>ä½œè€…å›å¤</span></div>
                                <p class="reply-content">PIDæ˜¯å”¯ä¸€ç´¢å¼•å—ï¼Ÿ ç»™ä¸€ä¸‹è¡¨ç»“æ„ã€‚è¿™ä¸¤ä¸ªè¯­å¥åˆ†åˆ«å¯¹åº”çš„ä¸»é”®IDå¦‚æœå•ç‹¬æŸ¥å‡ºæ¥åˆ†åˆ«æ˜¯å¤šå°‘</p>
                                <p class="reply-time">2018-12-29 20:33</p>
                            </div>
                            
                        </div>
                    </li>
                    
                    <li data-v-87ffcada="" class="comment-item"><img
                            src="https://static001.geekbang.org/account/avatar/00/13/fe/68/e0bebd9a.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">é«˜æ•</span>
                            </div>
                            <div class="bd">æ—è€å¸ˆï¼Œä»Šå¤©æˆ‘åˆå›å¤´çœ‹ç¬¬å››èŠ‚ æ·±å…¥æµ…å‡ºè°ˆç´¢å¼•ï¼ˆä¸Šï¼‰ï¼Œé‡Œé¢æœ‰è¿™æ ·ä¸€æ®µè¯ï¼šä¸ºäº†è®©ä¸€ä¸ªæŸ¥è¯¢å°½é‡å°‘åœ°è¯»ç£ç›˜ï¼Œå°±å¿…é¡»è®©æŸ¥è¯¢è¿‡ç¨‹è®¿é—®å°½é‡å°‘çš„æ•°æ®å—ã€‚é‚£ä¹ˆï¼Œæˆ‘ä»¬å°±ä¸åº”è¯¥ä½¿ç”¨äºŒå‰æ ‘ï¼Œè€Œæ˜¯è¦ä½¿ç”¨â€œN å‰â€æ ‘ã€‚è¿™é‡Œï¼Œâ€œN å‰â€æ ‘ä¸­çš„â€œNâ€å–å†³äºæ•°æ®å—çš„å¤§å°ã€‚<br>æˆ‘æƒ³é—®çš„æ˜¯ï¼Œ<br>ä¸€ mysqlæ˜¯ä»¥pageä¸ºæœ€å°å•ä½çš„ï¼Œmysqlä¸€æ¬¡ç£ç›˜ioèƒ½åªè¯»ä¸€ä¸ªå—å—ï¼Ÿè¿˜æ˜¯å¤šä¸ªå—ç»„æˆçš„pageï¼Ÿ<br>äºŒ è‹¥ä¸€æ¬¡åªèƒ½è¯»ä¸€ä¸ªpageï¼Œä¹Ÿå°±æ˜¯å¤šä¸ªå—çš„è¯ï¼Œè¿™ä¸ªNçš„å¤§å°æ˜¯ä¸æ˜¯åº”è¯¥å–å†³äºpageçš„å¤§å°å‘¢ï¼Ÿ<br>ä¸‰ ä¸»é”®ç´¢å¼•å¶å­ç»“ç‚¹å­˜æ”¾çš„å®é™…æ•°æ®ï¼Œåº”è¯¥æ˜¯é€šè¿‡æŒ‡é’ˆè·Ÿå¶å­ç»“ç‚¹è¿æ¥çš„å—ï¼Ÿè¿˜æ˜¯ç›´æ¥å­˜åœ¨å¶å­ç»“ç‚¹æ‰€åœ¨çš„é¡µé‡Œå—ï¼Ÿ <br></div>
                            <span class="time">2018-12-29 12:21</span>
                            
                        </div>
                    </li>
                    
                    <li data-v-87ffcada="" class="comment-item"><img
                            src="https://static001.geekbang.org/account/avatar/00/13/e5/39/951f89c8.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">ä¿¡ä¿¡</span>
                            </div>
                            <div class="bd">è€å¸ˆä½ å¥½ï¼Œå¦‚æœå›¾1çš„å­—æ®µdæœ‰ç´¢å¼•ï¼ŒæŒ‰å‰é¢è¯´çš„T1æ—¶åˆ»åï¼Œåªæœ‰idç­‰äº5è¿™ä¸€è¡ŒåŠ äº†å†™é”ã€‚é‚£ä¹ˆsession B  æ“ä½œçš„æ˜¯idç­‰äº0è¿™ä¸€è¡Œï¼Œåº”è¯¥ä¸ä¼šè¢«é˜»æ–­å§ï¼Ÿå¦‚æœæ²¡é˜»æ–­çš„è¯ï¼Œä»ç„¶ä¼šäº§ç”Ÿè¯­ä¹‰é—®é¢˜åŠæ•°æ®ä¸ä¸€è‡´çš„æƒ…å†µå•Šã€‚æƒ³ä¸æ˜ç™½ã€‚ã€‚ã€‚ <br></div>
                            <span class="time">2018-12-29 00:36</span>
                            
                            <div class="reply">
                                <div class="reply-hd"><span>ä½œè€…å›å¤</span></div>
                                <p class="reply-content">å¦‚æœdæœ‰ç´¢å¼•ï¼Œè€Œä¸”å†™æ³•æ˜¯d=5ï¼Œé‚£ä¹ˆå…¶ä»–è¯­å¥è¦æŠŠå…¶ä»–è¡Œçš„dæ”¹æˆ5ï¼Œä¹Ÿæ˜¯ä¸è¡Œçš„å“¦</p>
                                <p class="reply-time">2018-12-29 09:15</p>
                            </div>
                            
                        </div>
                    </li>
                    
                    <li data-v-87ffcada="" class="comment-item"><img
                            src="https://static001.geekbang.org/account/avatar/00/13/c7/a1/6e500f6b.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">å¯å‡¡ä¸å‡¡</span>
                            </div>
                            <div class="bd">è€å¸ˆ<br>update tab1  set name =(select name from tab2 where status =2)...<br>tab2.status ä¸Šæœ‰äºŒçº§éå”¯ä¸€ç´¢å¼•,rr éš”ç¦»çº§åˆ«<br>ä¸Šè¿°æƒ…å†µ<br>tab2.id ä¸Šçš„çš„ç´¢å¼•ä¼šè¢«é”å—?<br>å®é™…å¼€å‘ çœ‹åˆ°çš„æ­»é”æƒ…å†µ æ˜¯è¿™æ¡è¯­å¥åœ¨ç­‰å¾… s é” ä½†æ˜¯æ²¡æœ‰ gap é”,ä¹Ÿæ²¡æœ‰è®¾ç½® semi-consistent read <br></div>
                            <span class="time">2018-12-28 09:44</span>
                            
                            <div class="reply">
                                <div class="reply-hd"><span>ä½œè€…å›å¤</span></div>
                                <p class="reply-content">Tab2æ»¡è¶³æ¡ä»¶çš„èˆªä¸Šä¼šåŠ è¯»é”</p>
                                <p class="reply-time">2018-12-28 10:05</p>
                            </div>
                            
                        </div>
                    </li>
                    
                    <li data-v-87ffcada="" class="comment-item"><img
                            src="https://static001.geekbang.org/account/avatar/00/13/06/c4/11c9aa38.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">å°æ–°</span>
                            </div>
                            <div class="bd">è¿™ç¯‡æ–‡ç« çœŸçš„éœ€è¦å¤šå•ƒå‡ éï¼Œ <br></div>
                            <span class="time">2018-12-28 08:53</span>
                            
                            <div class="reply">
                                <div class="reply-hd"><span>ä½œè€…å›å¤</span></div>
                                <p class="reply-content">å—¯å—¯ï¼Œè€Œä¸”è¿™ç¯‡æ˜¯ä¸‹ç¯‡çš„åŸºç¡€ğŸ˜„</p>
                                <p class="reply-time">2018-12-28 09:43</p>
                            </div>
                            
                        </div>
                    </li>
                    
                    <li data-v-87ffcada="" class="comment-item"><img
                            src="https://static001.geekbang.org/account/avatar/00/13/ec/01/978d54af.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">Justin</span>
                            </div>
                            <div class="bd">ä¸‹ä¸€ç« è€å¸ˆä¼šä¸ä¼šè®²èµ°æ™®é€šç´¢å¼•ï¼Œé”æ™®é€šç´¢å¼•çš„æ—¶å€™ï¼Œä¸»é”®ç´¢å¼•ï¼Œä»¥åŠå…¶ä»–ç´¢å¼•çš„åŠ é”é¡ºåºæˆ–è€…è§„åˆ™å‘¢ï¼Ÿå¾ˆæ˜¯å¥½å¥‡  <br></div>
                            <span class="time">2018-12-28 00:50</span>
                            
                            <div class="reply">
                                <div class="reply-hd"><span>ä½œè€…å›å¤</span></div>
                                <p class="reply-content">å—¯å—¯ï¼Œå°±æ˜¯è¿™äº›å†…å®¹ğŸ˜„<br><br>è¿™ç¯‡æ–‡ç« æœ«å°¾çš„é—®é¢˜å¦‚æœä¸€çœ¼çœ‹æ‡‚çš„åŒå­¦åº”è¯¥çœ‹èµ·æ¥å°±è½»æ¾çš„</p>
                                <p class="reply-time">2018-12-28 09:46</p>
                            </div>
                            
                        </div>
                    </li>
                    
                    <li data-v-87ffcada="" class="comment-item"><img
                            src="https://static001.geekbang.org/account/avatar/00/11/6b/c6/2534e14a.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">spraith</span>
                            </div>
                            <div class="bd">ä»¥å‰æ²¡ç”¨è¿‡ for update è¯­å¥ï¼Œæˆ‘ä¸Šä¸€ä¸ªé—®é¢˜çš„ç­”æ¡ˆåº”è¯¥æ‰¾åˆ°äº†ï¼ŒåŸæ¥ select è¯­å¥åªæœ‰åŠ äº† for update è¯­å¥æ‰ä¼šåŠ å†™é”çš„ <br></div>
                            <span class="time">2019-01-12 03:11</span>
                            
                            <div class="reply">
                                <div class="reply-hd"><span>ä½œè€…å›å¤</span></div>
                                <p class="reply-content">ä½ å¾—åˆ°äº†å®ƒğŸ˜†</p>
                                <p class="reply-time">2019-01-12 13:02</p>
                            </div>
                            
                        </div>
                    </li>
                    
                    <li data-v-87ffcada="" class="comment-item"><img
                            src="https://static001.geekbang.org/account/avatar/00/11/6b/c6/2534e14a.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">spraith</span>
                            </div>
                            <div class="bd">å›¾1çš„Q1è¯­å¥ï¼Œæ¯æ¬¡ select æ˜¯å¦éƒ½æ˜¯è‡ªåŠ¨åŠ å†™é”çš„ï¼Ÿå¦‚æœæ˜¯ï¼Œé‚£ä¸ºäº†å®ç°å¯é‡å¤è¯»æå‡ºæ¥çš„mvccå¥½åƒå°±æ²¡å¿…è¦äº†å•Šï¼Œå› ä¸ºåˆ«çš„äº‹åŠ¡éƒ½åªèƒ½ç­‰å¾…å‰é¢çš„å†™é”é‡Šæ”¾æ‰èƒ½å†å†™ï¼Œæ‰€ä»¥Q1æ‰€åœ¨çš„äº‹åŠ¡è‡ªç„¶å°±èƒ½å®ç°â€œå¯é‡å¤è¯»â€ï¼Œä¼¼ä¹ä¸éœ€è¦mvccã€‚<br>æ±‚è€å¸ˆè§£ç­” <br></div>
                            <span class="time">2019-01-12 03:06</span>
                            
                        </div>
                    </li>
                    
                    <li data-v-87ffcada="" class="comment-item"><img
                            src="https://static001.geekbang.org/account/avatar/00/14/1d/b5/971261fd.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">alias cd=rm -rf</span>
                            </div>
                            <div class="bd">æ€è€ƒé¢˜çŒœæµ‹ï¼š<br>å› ä¸ºsessionAè™½ç„¶æœ‰ç´¢å¼•ï¼Œä½†æ˜¯å› ä¸ºæ’åºéœ€è¦æ‰«æå…¨è¡¨ã€‚æ‰€ä»¥ä¸ºå…¨è¡¨å¢åŠ äº†gap lockã€‚å¯¼è‡´insertéƒ½éœ€è¦ç­‰å¾…é”é‡Šæ”¾ã€‚<br>æ˜¯å¦sessionAä¸åŠ order byï¼ŒsessionCå°±ä¸ç”¨blockäº†ï¼Ÿ <br></div>
                            <span class="time">2019-01-10 09:23</span>
                            
                        </div>
                    </li>
                    
                    <li data-v-87ffcada="" class="comment-item"><img
                            src="https://static001.geekbang.org/account/avatar/00/10/ed/d2/e3ae7ddd.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">ä¸‰æœ¨ç¦¾</span>
                            </div>
                            <div class="bd">è€å¸ˆï¼Œæˆ‘çš„æ•°æ®åº“ç‰ˆæœ¬æ˜¯5.6.39-logï¼Œå­˜å‚¨å¼•æ“ä¸ºinnodb,äº‹åŠ¡çš„éš”ç¦»çº§åˆ«ä¸º  REPEATABLE-READ<br>CREATE TABLE `t` (<br>  `id` int(11) NOT NULL,<br>  `c` int(11) DEFAULT NULL,<br>  `d` int(11) DEFAULT NULL,<br>  PRIMARY KEY (`id`),<br>  KEY `c` (`c`)<br>) ENGINE=InnoDB DEFAULT CHARSET=utf8ï¼›<br>ä½†æ˜¯æˆ‘åœ¨ä¸€ä¸ªsessionAæ‰§è¡Œbegin;  select * from t where d=5 for update;<br>å¾—åˆ° 5 | 5 | 5 |  è¿™ä¸€è¡Œæ•°æ®<br>sessionB æ‰§è¡Œupdate t set id=5 set id=0;  ç„¶åè¿™æ¡è¯­å¥é˜»å¡<br>sessionCæ‰§è¡Œinsert into t(id,c,d) values(1,1,5);  ä¹Ÿé˜»å¡ï¼Œè·Ÿæ‚¨çš„å›¾1 çš„æ‰§è¡Œç»“æœä¸ä¸€æ ·ï¼Œä¸ºä»€ä¹ˆå•Šï¼Ÿ<br> <br></div>
                            <span class="time">2019-01-07 20:46</span>
                            
                            <div class="reply">
                                <div class="reply-hd"><span>ä½œè€…å›å¤</span></div>
                                <p class="reply-content">å›¾1æ˜¯ä¸ºäº†æ¨å¯¼â€œå¦‚æœä¸é˜»å¡ä¼šå‘ç”Ÿä»€ä¹ˆç°è±¡â€<br><br>æœ€åæˆ‘ä»¬æ¨è®ºå‡ºæ¥éœ€è¦é˜»å¡<br><br>å®é™…ä¸Šè·Ÿä½ éªŒè¯çš„è¿™ä¸ªç»“æœä¸€è‡´çš„</p>
                                <p class="reply-time">2019-01-07 22:04</p>
                            </div>
                            
                        </div>
                    </li>
                    


                </ul>
            </div>
        </div>
    </div>
</div>
</body>
</html>